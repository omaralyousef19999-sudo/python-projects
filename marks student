import customtkinter as ctk
from tkinter import messagebox, Canvas
from PIL import Image
import json
import os
from datetime import datetime, timedelta
from openpyxl import Workbook
import shutil
import re
import random
import time
import pygame
import hashlib

# ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ==========
ctk.set_default_color_theme("blue")

DATA_FILE = "students_data.json"
BACKUP_FILE = "students_data_backup.json"
MAX_GRADES = 100
EDIT_DAYS_LIMIT = 5
FIREWORKS_SOUND = "fireworks.wav"
EMAIL = "omar.alyousef.19999@gmail.com"

# ============================================================
# ğŸ”¹ Ø¯Ø§Ù„Ø© ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
# ============================================================
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

# ============================================================
# ğŸ”¹ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ============================================================
def save_data(data):
    try:
        if os.path.exists(DATA_FILE):
            shutil.copy(DATA_FILE, BACKUP_FILE)
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4, ensure_ascii=False)
    except Exception as e:
        messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {str(e)}")
        raise

# ============================================================
# ğŸ”¹ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ============================================================
def load_data():
    if not os.path.exists(DATA_FILE):
        return {"accounts": []}
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
            if "accounts" not in data:
                data = {"accounts": [data]}
            return data
    except json.JSONDecodeError:
        messagebox.showerror("Ø®Ø·Ø£", "Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„Ù. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯.")
        return {"accounts": []}
    except Exception as e:
        messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {str(e)}")
        return {"accounts": []}

# ============================================================
# ğŸ”¹ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ©
# ============================================================
def show_fireworks(master, lang):
    try:
        pygame.mixer.init()
        if os.path.exists(FIREWORKS_SOUND):
            pygame.mixer.music.load(FIREWORKS_SOUND)
            pygame.mixer.music.play()
        else:
            messagebox.showwarning(
                "ØªØ­Ø°ÙŠØ±" if lang == "ar" else "Warning",
                f"Ù…Ù„Ù Ø§Ù„ØµÙˆØª {FIREWORKS_SOUND} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯." if lang == "ar" else f"Sound file {FIREWORKS_SOUND} not found."
            )
    except Exception as e:
        messagebox.showerror(
            "Ø®Ø·Ø£" if lang == "ar" else "Error",
            f"ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª: {str(e)}" if lang == "ar" else f"Failed to play sound: {str(e)}"
        )

    popup = ctk.CTkToplevel(master)
    popup.title("Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ©" if lang == "ar" else "Fireworks")
    screen_width = master.winfo_screenwidth()
    screen_height = master.winfo_screenheight()
    window_width = int(screen_width * 0.5)
    window_height = int(screen_height * 0.5)
    popup.wm_geometry(f"{window_width}x{window_height}+{int((screen_width - window_width) / 2)}+{int((screen_height - window_height) / 2)}")
    popup.transient(master)
    popup.grab_set()

    canvas = Canvas(popup, bg="black", highlightthickness=0)
    canvas.pack(fill="both", expand=True)

    particles = []
    colors = ["red", "yellow", "blue", "green", "purple", "white"]

    def create_particle():
        x = random.randint(50, window_width - 50)
        y = random.randint(50, window_height - 50)
        size = random.randint(5, 15)
        color = random.choice(colors)
        dx = random.uniform(-3, 3)
        dy = random.uniform(-3, 3)
        particle = canvas.create_oval(x, y, x + size, y + size, fill=color)
        return {"id": particle, "dx": dx, "dy": dy, "life": 50}

    def animate():
        nonlocal particles
        if len(particles) < 20:
            particles.append(create_particle())
        new_particles = []
        for p in particles:
            canvas.move(p["id"], p["dx"], p["dy"])
            p["life"] -= 1
            if p["life"] > 0:
                new_particles.append(p)
            else:
                canvas.delete(p["id"])
        particles = new_particles
        if particles:
            popup.after(50, animate)
        else:
            popup.destroy()

    for _ in range(10):
        particles.append(create_particle())
    animate()
    popup.after(3000, lambda: [pygame.mixer.music.stop(), popup.destroy()])

# ============================================================
# ğŸ”¹ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
# ============================================================
class AccountManagerWindow(ctk.CTk):
    def __init__(self, lang="ar", mode="dark"):
        super().__init__()
        ctk.set_appearance_mode(mode)
        self.title("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª" if lang == "ar" else "Account Manager")
        self.lang = lang
        self.mode = mode
        self.data = load_data()
        self.accounts = self.data.get("accounts", [])

        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        window_width = int(screen_width * 0.8)
        window_height = int(screen_height * 0.8)
        self.wm_geometry(f"{window_width}x{window_height}+{int((screen_width - window_width) / 2)}+{int((screen_height - window_height) / 2)}")

        self.main_frame = ctk.CTkFrame(self, corner_radius=10)
        self.main_frame.place(relx=0.5, rely=0.5, anchor="center")

        ctk.CTkLabel(
            self.main_frame,
            text="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª" if lang == "ar" else "Manage Accounts",
            font=("Cairo" if lang == "ar" else "Arial", 24, "bold")
        ).pack(pady=15)

        self.account_frame = ctk.CTkScrollableFrame(self.main_frame, corner_radius=8)
        self.account_frame.pack(pady=10, fill="both", expand=True)

        button_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        button_frame.pack(pady=10, fill="x", padx=10)

        lang_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ‡¬ğŸ‡§ English" if lang == "ar" else "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
            font=("Cairo" if lang == "ar" else "Arial", 12),
            command=self.toggle_language,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        lang_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        mode_btn = ctk.CTkButton(
            button_frame,
            text="â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" if lang == "ar" and mode == "dark" else "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" if lang == "ar" and mode == "light" else "â˜€ï¸ Light Mode" if mode == "dark" else "ğŸŒ™ Dark Mode",
            font=("Cairo" if lang == "ar" else "Arial", 12),
            command=self.toggle_mode,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        mode_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        add_btn = ctk.CTkButton(
            button_frame,
            text="â• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" if lang == "ar" else "â• Create New Account",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.create_new_account,
            fg_color="#2E7D32",
            hover_color="#4CAF50",
            corner_radius=8
        )
        add_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        self.load_accounts()

    def load_accounts(self):
        for widget in self.account_frame.winfo_children():
            widget.destroy()

        for i, account in enumerate(self.accounts):
            row = ctk.CTkFrame(self.account_frame, corner_radius=5, fg_color="#424242")
            row.pack(fill="x", pady=5, padx=5)

            ctk.CTkLabel(
                row,
                text=f"{i+1}. {account['teacher']} - {account['institute']}",
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                anchor="w" if self.lang == "ar" else "e"
            ).pack(side="left" if self.lang == "ar" else "right", padx=10, fill="x", expand=True)

            open_btn = ctk.CTkButton(
                row,
                text="ğŸ“‚ ÙØªØ­" if self.lang == "ar" else "ğŸ“‚ Open",
                width=80,
                command=lambda acc=account: self.show_password_prompt(acc)
            )
            open_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

            delete_btn = ctk.CTkButton(
                row,
                text="ğŸ—‘ï¸ Ø­Ø°Ù" if self.lang == "ar" else "ğŸ—‘ï¸ Delete",
                width=80,
                fg_color="#D32F2F",
                hover_color="#F44336",
                command=lambda idx=i: self.delete_account(idx)
            )
            delete_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

    def toggle_language(self):
        new_lang = "en" if self.lang == "ar" else "ar"
        self.destroy()
        AccountManagerWindow(new_lang, self.mode).mainloop()

    def toggle_mode(self):
        new_mode = "light" if self.mode == "dark" else "dark"
        self.destroy()
        AccountManagerWindow(self.lang, new_mode).mainloop()

    def create_new_account(self):
        self.destroy()
        CreateAccountWindow(self.lang, self.mode).mainloop()

    def show_password_prompt(self, account):
        popup = ctk.CTkToplevel(self)
        popup.title("ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" if self.lang == "ar" else "Password Confirmation")
        popup.geometry("400x300")
        popup.transient(self)
        popup.grab_set()

        frame = ctk.CTkFrame(popup, corner_radius=10)
        frame.pack(pady=20, padx=20, fill="both", expand=True)

        ctk.CTkLabel(
            frame,
            text="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:" if self.lang == "ar" else "Enter Password:",
            font=("Cairo" if self.lang == "ar" else "Arial", 14)
        ).pack(pady=10)

        password_entry = ctk.CTkEntry(
            frame,
            show="*",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        password_entry.pack(pady=10, padx=20, fill="x")
        password_entry.focus_set()

        password_entry.bind("<Return>", lambda event: verify_password())

        show_password_switch = ctk.CTkSwitch(
            frame,
            text="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" if self.lang == "ar" else "Show Password",
            command=lambda: password_entry.configure(show="" if show_password_switch.get() else "*"),
            font=("Cairo" if self.lang == "ar" else "Arial", 12)
        )
        show_password_switch.pack(pady=10)

        def verify_password():
            entered_password = password_entry.get().strip()
            hashed_entered_password = hash_password(entered_password)
            if hashed_entered_password == account.get("password", ""):
                popup.destroy()
                self.destroy()
                StudentWindow(account, self.lang, self.mode).mainloop()
            else:
                messagebox.showerror(
                    "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                    "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©." if self.lang == "ar" else "Incorrect password."
                )

        verify_btn = ctk.CTkButton(
            frame,
            text="ØªØ­Ù‚Ù‚" if self.lang == "ar" else "Verify",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=verify_password,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        )
        verify_btn.pack(pady=10)

        cancel_btn = ctk.CTkButton(
            frame,
            text="Ø¥Ù„ØºØ§Ø¡" if self.lang == "ar" else "Cancel",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=popup.destroy,
            fg_color="#D32F2F",
            hover_color="#F44336",
            corner_radius=8
        )
        cancel_btn.pack(pady=5)

        forgot_password_btn = ctk.CTkButton(
            frame,
            text="Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ" if self.lang == "ar" else "Forgot Password?",
            font=("Cairo" if self.lang == "ar" else "Arial", 12),
            command=lambda: self.show_forgot_password(account, popup),
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        forgot_password_btn.pack(pady=10)

    def show_forgot_password(self, account, parent_popup):
        forgot_popup = ctk.CTkToplevel(self)
        forgot_popup.title("Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" if self.lang == "ar" else "Forgot Password")
        forgot_popup.geometry("400x250")
        forgot_popup.transient(self)
        forgot_popup.grab_set()

        frame = ctk.CTkFrame(forgot_popup, corner_radius=10)
        frame.pack(pady=20, padx=20, fill="both", expand=True)

        ctk.CTkLabel(
            frame,
            text="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:" if self.lang == "ar" else "Enter your email:",
            font=("Cairo" if self.lang == "ar" else "Arial", 14)
        ).pack(pady=10)

        email_entry = ctk.CTkEntry(
            frame,
            placeholder_text="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" if self.lang == "ar" else "Email",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        email_entry.pack(pady=10, padx=20, fill="x")
        email_entry.focus_set()

        def verify_email():
            entered_email = email_entry.get().strip()
            if entered_email == EMAIL:
                parent_popup.destroy()
                forgot_popup.destroy()
                messagebox.showinfo(
                    "ØªÙ…" if self.lang == "ar" else "Success",
                    f"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡ÙŠ: {account.get('raw_password', 'ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©')}" if self.lang == "ar" else f"Your password is: {account.get('raw_password', 'Not available')}"
                )
            else:
                messagebox.showerror(
                    "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                    "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­." if self.lang == "ar" else "Incorrect email."
                )

        email_entry.bind("<Return>", lambda event: verify_email())

        verify_email_btn = ctk.CTkButton(
            frame,
            text="ØªØ­Ù‚Ù‚" if self.lang == "ar" else "Verify",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=verify_email,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        )
        verify_email_btn.pack(pady=15)

        cancel_email_btn = ctk.CTkButton(
            frame,
            text="Ø¥Ù„ØºØ§Ø¡" if self.lang == "ar" else "Cancel",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=forgot_popup.destroy,
            fg_color="#D32F2F",
            hover_color="#F44336",
            corner_radius=8
        )
        cancel_email_btn.pack(pady=5)

    def delete_account(self, index):
        if messagebox.askyesno(
            "ØªØ£ÙƒÙŠØ¯" if self.lang == "ar" else "Confirm",
            "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ" if self.lang == "ar" else "Do you want to delete this account?"
        ):
            del self.accounts[index]
            self.data["accounts"] = self.accounts
            save_data(self.data)
            self.load_accounts()
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­." if self.lang == "ar" else "Account deleted successfully."
            )

# ============================================================
# ğŸ”¹ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
# ============================================================
class CreateAccountWindow(ctk.CTk):
    def __init__(self, lang="ar", mode="dark"):
        super().__init__()
        ctk.set_appearance_mode(mode)
        self.title("Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨" if lang == "ar" else "Institute System - Create Account")
        self.lang = lang
        self.mode = mode
        self.data = load_data()
        self.students = []

        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        window_width = int(screen_width * 0.8)
        window_height = int(screen_height * 0.8)
        self.wm_geometry(f"{window_width}x{window_height}+{int((screen_width - window_width) / 2)}+{int((screen_height - window_height) / 2)}")

        self.main_frame = ctk.CTkFrame(self, corner_radius=10)
        self.main_frame.place(relx=0.5, rely=0.5, anchor="center")

        ctk.CTkLabel(
            self.main_frame,
            text="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø³ØªØ§Ø°" if lang == "ar" else "Create Teacher Account",
            font=("Cairo" if lang == "ar" else "Arial", 24, "bold")
        ).pack(pady=15)

        self.name_entry = ctk.CTkEntry(
            self.main_frame,
            placeholder_text="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°" if lang == "ar" else "Teacher Name",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        self.name_entry.pack(pady=10, padx=40, fill="x")

        self.inst_entry = ctk.CTkEntry(
            self.main_frame,
            placeholder_text="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯" if lang == "ar" else "Institute Name",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        self.inst_entry.pack(pady=10, padx=40, fill="x")

        self.password_entry = ctk.CTkEntry(
            self.main_frame,
            placeholder_text="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" if lang == "ar" else "Password",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40,
            show="*"
        )
        self.password_entry.pack(pady=10, padx=40, fill="x")

        self.show_password_switch = ctk.CTkSwitch(
            self.main_frame,
            text="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" if lang == "ar" else "Show Password",
            command=self.toggle_password_visibility,
            font=("Cairo" if lang == "ar" else "Arial", 14)
        )
        self.show_password_switch.pack(pady=5)

        button_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        button_frame.pack(pady=10, fill="x", padx=10)

        self.add_students_btn = ctk.CTkButton(
            button_frame,
            text="â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨" if lang == "ar" else "â• Add Students",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.open_student_input,
            fg_color="#2E7D32",
            hover_color="#4CAF50",
            corner_radius=8
        )
        self.add_students_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        self.create_btn = ctk.CTkButton(
            button_frame,
            text="âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨" if lang == "ar" else "âœ… Create Account",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.create_account,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        )
        self.create_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        self.manager_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª" if lang == "ar" else "ğŸ“‹ Manage Accounts",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.goto_account_manager,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        self.manager_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        lang_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ‡¬ğŸ‡§ English" if lang == "ar" else "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
            font=("Cairo" if lang == "ar" else "Arial", 12),
            command=self.toggle_language,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        lang_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        mode_btn = ctk.CTkButton(
            button_frame,
            text="â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" if lang == "ar" and mode == "dark" else "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" if lang == "ar" and mode == "light" else "â˜€ï¸ Light Mode" if mode == "dark" else "ğŸŒ™ Dark Mode",
            font=("Cairo" if lang == "ar" else "Arial", 12),
            command=self.toggle_mode,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        mode_btn.pack(side="right" if lang == "ar" else "left", padx=5)

    def toggle_password_visibility(self):
        if self.show_password_switch.get():
            self.password_entry.configure(show="")
        else:
            self.password_entry.configure(show="*")

    def toggle_language(self):
        new_lang = "en" if self.lang == "ar" else "ar"
        self.destroy()
        CreateAccountWindow(new_lang, self.mode).mainloop()

    def toggle_mode(self):
        new_mode = "light" if self.mode == "dark" else "dark"
        self.destroy()
        CreateAccountWindow(self.lang, new_mode).mainloop()

    def goto_account_manager(self):
        if self.data["accounts"]:
            self.destroy()
            AccountManagerWindow(self.lang, self.mode).mainloop()
        else:
            messagebox.showinfo(
                "ØªÙ†Ø¨ÙŠÙ‡" if self.lang == "ar" else "Alert",
                "Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¯." if self.lang == "ar" else "No accounts have been created yet."
            )

    def open_student_input(self):
        self.student_input_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        self.student_input_frame.pack(pady=10, padx=40, fill="x")

        ctk.CTkLabel(
            self.student_input_frame,
            text="Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨" if self.lang == "ar" else "Add Student",
            font=("Cairo" if self.lang == "ar" else "Arial", 16, "bold")
        ).pack(pady=5)

        self.student_entry = ctk.CTkEntry(
            self.student_input_frame,
            placeholder_text="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" if self.lang == "ar" else "Student Name",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        self.student_entry.pack(side="left" if self.lang == "ar" else "right", padx=5, fill="x", expand=True)
        self.student_entry.bind("<Return>", lambda event: self.add_student())

        add_btn = ctk.CTkButton(
            self.student_input_frame,
            text="â• Ø¥Ø¶Ø§ÙØ©" if self.lang == "ar" else "â• Add",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=self.add_student,
            fg_color="#2E7D32",
            hover_color="#4CAF50",
            corner_radius=8
        )
        add_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

        remove_btn = ctk.CTkButton(
            self.student_input_frame,
            text="ğŸ—‘ï¸ Ø­Ø°Ù" if self.lang == "ar" else "ğŸ—‘ï¸ Remove",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=self.remove_student,
            fg_color="#D32F2F",
            hover_color="#F44336",
            corner_radius=8
        )
        remove_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

        self.student_list_frame = ctk.CTkScrollableFrame(self.main_frame, corner_radius=8)
        self.student_list_frame.pack(pady = 10, padx=40, fill="both", expand=True)
        self.refresh_student_list()

    def add_student(self):
        name = self.student_entry.get().strip()
        print(f"Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨: {name}")
        if not name:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨." if self.lang == "ar" else "Please enter a student name."
            )
            return
        if not re.match(r"^[a-zA-Z\sØ£-ÙŠ]+$", name):
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙˆÙ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø±Ù…ÙˆØ²)." if self.lang == "ar" else "Name must contain letters only (no numbers or symbols)."
            )
            return
        if any(s["name"] == name for s in self.students):
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„." if self.lang == "ar" else "Student name already exists."
            )
            return

        self.students.append({"name": name, "grades": [], "info": "", "attendance": []})
        print(f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨: {name}, Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù†: {self.students}")
        self.student_entry.delete(0, "end")
        self.refresh_student_list()
        messagebox.showinfo(
            "ØªÙ…" if self.lang == "ar" else "Success",
            f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ {name} Ø¨Ù†Ø¬Ø§Ø­." if self.lang == "ar" else f"Student {name} added successfully."
        )

    def remove_student(self):
        name = self.student_entry.get().strip()
        if not name:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø­Ø°ÙÙ‡." if self.lang == "ar" else "Please enter a student name to remove."
            )
            return
        if any(s["name"] == name for s in self.students):
            self.students = [s for s in self.students if s["name"] != name]
            self.student_entry.delete(0, "end")
            self.refresh_student_list()
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                f"ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ {name} Ø¨Ù†Ø¬Ø§Ø­." if self.lang == "ar" else f"Student {name} removed successfully."
            )
        else:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯." if self.lang == "ar" else "Student name not found."
            )

    def refresh_student_list(self):
        for widget in self.student_list_frame.winfo_children():
            widget.destroy()

        if not self.students:
            ctk.CTkLabel(
                self.student_list_frame,
                text="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø¶Ø§ÙÙŠÙ† Ø¨Ø¹Ø¯." if self.lang == "ar" else "No students added yet.",
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                text_color="gray"
            ).pack(pady=10)
        else:
            for i, student in enumerate(self.students):
                row = ctk.CTkFrame(self.student_list_frame, corner_radius=5, fg_color="#424242")
                row.pack(fill="x", pady=5, padx=5)
                ctk.CTkLabel(
                    row,
                    text=f"{i+1}. {student['name']}",
                    font=("Cairo" if self.lang == "ar" else "Arial", 14),
                    anchor="w" if self.lang == "ar" else "e"
                ).pack(pady=5, padx=10, fill="x")
        print(f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨: {self.students}")

    def create_account(self):
        name = self.name_entry.get().strip()
        inst = self.inst_entry.get().strip()
        raw_password = self.password_entry.get().strip()

        if not name or not inst or not raw_password:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±." if self.lang == "ar" else "Please enter all fields including password."
            )
            return

        if not self.students:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹." if self.lang == "ar" else "Please add students first."
            )
            return

        hashed_password = hash_password(raw_password)
        creation_date = datetime.now().strftime("%Y-%m-%d")
        new_account = {
            "teacher": name,
            "institute": inst,
            "created_at": creation_date,
            "students": self.students,
            "password": hashed_password,
            "raw_password": raw_password,
            "course_days": 5  # default value, can be changed later
        }

        self.data["accounts"].append(new_account)
        save_data(self.data)
        messagebox.showinfo(
            "ØªÙ…" if self.lang == "ar" else "Success",
            "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰" if self.lang == "ar" else "Account created successfully ğŸ‰"
        )

        self.destroy()
        AccountManagerWindow(self.lang, self.mode).mainloop()

# ============================================================
# ğŸ”¹ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
# ============================================================
class AttendanceWindow(ctk.CTkToplevel):
    def __init__(self, master, account, lang="ar", mode="dark"):
        super().__init__(master)
        ctk.set_appearance_mode(mode)
        self.account = account
        self.lang = lang
        self.mode = mode
        self.title("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ±" if lang == "ar" else "Manage Attendance")

        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        window_width = int(screen_width * 0.8)
        window_height = int(screen_height * 0.8)
        self.wm_geometry(f"{window_width}x{window_height}+{int((screen_width - window_width) / 2)}+{int((screen_height - window_height) / 2)}")

        self.main_frame = ctk.CTkFrame(self, corner_radius=10)
        self.main_frame.pack(fill="both", expand=True)

        # Left section: Students list for attendance
        left_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        left_frame.pack(side="left" if lang == "ar" else "right", fill="both", expand=True, padx=10, pady=10)

        ctk.CTkLabel(
            left_frame,
            text="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨" if lang == "ar" else "Students List",
            font=("Cairo" if lang == "ar" else "Arial", 18, "bold")
        ).pack(pady=10)

        self.attendance_frame = ctk.CTkScrollableFrame(left_frame, corner_radius=8)
        self.attendance_frame.pack(fill="both", expand=True, pady=10)

        self.load_attendance_students()

        save_attendance_btn = ctk.CTkButton(
            left_frame,
            text="ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±" if lang == "ar" else "ğŸ’¾ Save Attendance",
            command=self.save_attendance,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        )
        save_attendance_btn.pack(pady=10)

        # Right section: Date, day, sessions per week
        right_frame = ctk.CTkFrame(self.main_frame, corner_radius=10, width=300)
        right_frame.pack(side="right" if lang == "ar" else "left", fill="y", padx=10, pady=10)

        ctk.CTkLabel(
            right_frame,
            text="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…" if lang == "ar" else "Day Settings",
            font=("Cairo" if lang == "ar" else "Arial", 18, "bold")
        ).pack(pady=10)

        today = datetime.now()
        ctk.CTkLabel(
            right_frame,
            text=f"Ø§Ù„ØªØ§Ø±ÙŠØ®: {today.strftime('%Y-%m-%d')}" if lang == "ar" else f"Date: {today.strftime('%Y-%m-%d')}",
            font=("Cairo" if lang == "ar" else "Arial", 14)
        ).pack(pady=5)

        day_name = today.strftime("%A")
        arabic_days = {"Monday": "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Tuesday": "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Wednesday": "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Thursday": "Ø§Ù„Ø®Ù…ÙŠØ³", "Friday": "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Saturday": "Ø§Ù„Ø³Ø¨Øª", "Sunday": "Ø§Ù„Ø£Ø­Ø¯"}
        ctk.CTkLabel(
            right_frame,
            text=f"Ø§Ù„ÙŠÙˆÙ…: {arabic_days.get(day_name, day_name)}" if lang == "ar" else f"Day: {day_name}",
            font=("Cairo" if lang == "ar" else "Arial", 14)
        ).pack(pady=5)

        ctk.CTkLabel(
            right_frame,
            text="Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:" if lang == "ar" else "Sessions per Week:",
            font=("Cairo" if lang == "ar" else "Arial", 14)
        ).pack(pady=5)

        self.sessions_entry = ctk.CTkEntry(
            right_frame,
            font=("Cairo" if lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        self.sessions_entry.insert(0, str(self.account.get("course_days", 5)))
        self.sessions_entry.pack(pady=5)

        update_sessions_btn = ctk.CTkButton(
            right_frame,
            text="ØªØ­Ø¯ÙŠØ«" if lang == "ar" else "Update",
            command=self.update_sessions,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        update_sessions_btn.pack(pady=10)

    def load_attendance_students(self):
        for widget in self.attendance_frame.winfo_children():
            widget.destroy()

        today = datetime.now().strftime("%Y-%m-%d")
        for i, student in enumerate(self.account["students"]):
            row = ctk.CTkFrame(self.attendance_frame, corner_radius=5, fg_color="#424242")
            row.pack(fill="x", pady=5, padx=5)

            ctk.CTkLabel(
                row,
                text=f"{i+1}. {student['name']}",
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                anchor="w" if self.lang == "ar" else "e"
            ).pack(side="left" if self.lang == "ar" else "right", padx=10, fill="x", expand=True)

            # Use variable for each switch
            present_var = ctk.BooleanVar(value=any(a["date"] == today and a["present"] for a in student.get("attendance", [])))
            present_switch = ctk.CTkSwitch(
                row,
                text="Ø­Ø§Ø¶Ø±" if self.lang == "ar" else "Present",
                variable=present_var,
                command=lambda s=student, var=present_var: self.toggle_attendance(s, today, var.get())
            )
            present_switch.pack(side="right" if self.lang == "ar" else "left", padx=5)

    def toggle_attendance(self, student, date, present):
        attendance = student.get("attendance", [])
        # Remove existing for today if any
        attendance = [a for a in attendance if a["date"] != date]
        attendance.append({"date": date, "present": present})
        student["attendance"] = attendance

    def save_attendance(self):
        full_data = load_data()
        for acc in full_data["accounts"]:
            if acc["institute"] == self.account["institute"] and acc["teacher"] == self.account["teacher"]:
                acc["students"] = self.account["students"]
                break
        save_data(full_data)
        messagebox.showinfo(
            "ØªÙ…" if self.lang == "ar" else "Success",
            "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…" if self.lang == "ar" else "Attendance saved successfully âœ…"
        )

    def update_sessions(self):
        try:
            sessions = int(self.sessions_entry.get())
            if sessions < 1:
                raise ValueError
            self.account["course_days"] = sessions
            full_data = load_data()
            for acc in full_data["accounts"]:
                if acc["institute"] == self.account["institute"] and acc["teacher"] == self.account["teacher"]:
                    acc["course_days"] = sessions
                    break
            save_data(full_data)
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…" if self.lang == "ar" else "Sessions updated successfully âœ…"
            )
        except ValueError:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ." if self.lang == "ar" else "Please enter a positive integer."
            )

# ============================================================
# ğŸ”¹ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
# ============================================================
class StudentWindow(ctk.CTk):
    def __init__(self, account, lang="ar", mode="dark"):
        super().__init__()
        ctk.set_appearance_mode(mode)
        self.account = account
        self.lang = lang
        self.mode = mode
        self.title("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨" if lang == "ar" else "Manage Students")

        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        window_width = int(screen_width * 0.8)
        window_height = int(screen_height * 0.8)
        self.wm_geometry(f"{window_width}x{window_height}+{int((screen_width - window_width) / 2)}+{int((screen_height - window_height) / 2)}")

        self.main_frame = ctk.CTkFrame(self, corner_radius=10)
        self.main_frame.place(relx=0.5, rely=0.5, anchor="center")

        ctk.CTkLabel(
            self.main_frame,
            text=f"Ø§Ù„Ù…Ø¹Ù‡Ø¯: {account['institute']}" if lang == "ar" else f"Institute: {account['institute']}",
            font=("Cairo" if lang == "ar" else "Arial", 24, "bold")
        ).pack(pady=15)

        search_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        search_frame.pack(pady=10, padx=40, fill="x")

        self.search_entry = ctk.CTkEntry(
            search_frame,
            placeholder_text="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." if lang == "ar" else "Search for a student...",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        self.search_entry.pack(side="right" if lang == "ar" else "left", fill="x", expand=True, padx=5)

        search_btn = ctk.CTkButton(
            search_frame,
            text="ğŸ” Ø¨Ø­Ø«" if lang == "ar" else "ğŸ” Search",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.filter_students,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8,
            width=100
        )
        search_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        self.stats_frame = ctk.CTkFrame(self.main_frame, corner_radius=10, fg_color="#37474F")
        self.stats_frame.pack(pady=10, padx=40, fill="x")

        ctk.CTkLabel(
            self.stats_frame,
            text="ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª" if lang == "ar" else "ğŸ“ˆ Statistics",
            font=("Cairo" if lang == "ar" else "Arial", 16, "bold")
        ).pack(pady=5)

        self.stats_labels = {
            "count": ctk.CTkLabel(self.stats_frame, text="", font=("Cairo" if lang == "ar" else "Arial", 14)),
            "avg": ctk.CTkLabel(self.stats_frame, text="", font=("Cairo" if lang == "ar" else "Arial", 14)),
            "max": ctk.CTkLabel(self.stats_frame, text="", font=("Cairo" if lang == "ar" else "Arial", 14)),
            "min": ctk.CTkLabel(self.stats_frame, text="", font=("Cairo" if lang == "ar" else "Arial", 14)),
            "above_90": ctk.CTkLabel(self.stats_frame, text="", font=("Cairo" if lang == "ar" else "Arial", 14))
        }
        for label in self.stats_labels.values():
            label.pack(pady=2, anchor="w" if lang == "ar" else "e")

        student_input_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        student_input_frame.pack(pady=10, padx=40, fill="x")

        ctk.CTkLabel(
            student_input_frame,
            text="Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨" if self.lang == "ar" else "Add Student",
            font=("Cairo" if self.lang == "ar" else "Arial", 16, "bold")
        ).pack(pady=5)

        self.student_entry = ctk.CTkEntry(
            student_input_frame,
            placeholder_text="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" if lang == "ar" else "Student Name",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        self.student_entry.pack(side="left" if self.lang == "ar" else "right", padx=5, fill="x", expand=True)
        self.student_entry.bind("<Return>", lambda event: self.add_student())

        add_btn = ctk.CTkButton(
            student_input_frame,
            text="â• Ø¥Ø¶Ø§ÙØ©" if self.lang == "ar" else "â• Add",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=self.add_student,
            fg_color="#2E7D32",
            hover_color="#4CAF50",
            corner_radius=8
        )
        add_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

        remove_btn = ctk.CTkButton(
            student_input_frame,
            text="ğŸ—‘ï¸ Ø­Ø°Ù" if self.lang == "ar" else "ğŸ—‘ï¸ Remove",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=self.remove_student,
            fg_color="#D32F2F",
            hover_color="#F44336",
            corner_radius=8
        )
        remove_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

        save_btn = ctk.CTkButton(
            student_input_frame,
            text="ğŸ’¾ Ø­ÙØ¸" if self.lang == "ar" else "ğŸ’¾ Save",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=self.save_students,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        )
        save_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

        button_frame = ctk.CTkFrame(self.main_frame, corner_radius=10)
        button_frame.pack(pady=10, fill="x")

        attendance_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ±" if lang == "ar" else "ğŸ“… Manage Attendance",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.open_attendance_window,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        attendance_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        export_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel" if lang == "ar" else "ğŸ“Š Export to Excel",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.export_to_excel,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        )
        export_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        restart_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡" if lang == "ar" else "ğŸ”„ Restart",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.restart_students,
            fg_color="#D32F2F",
            hover_color="#F44336",
            corner_radius=8
        )
        restart_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        return_btn = ctk.CTkButton(
            button_frame,
            text="â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª" if lang == "ar" else "â¬…ï¸ Back to Account Manager",
            font=("Cairo" if lang == "ar" else "Arial", 14),
            command=self.back_to_manager,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        return_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        lang_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ‡¬ğŸ‡§ English" if lang == "ar" else "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
            font=("Cairo" if lang == "ar" else "Arial", 12),
            command=self.toggle_language,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        lang_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        mode_btn = ctk.CTkButton(
            button_frame,
            text="â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" if lang == "ar" and mode == "dark" else "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ" if lang == "ar" and mode == "light" else "â˜€ï¸ Light Mode" if mode == "dark" else "ğŸŒ™ Dark Mode",
            font=("Cairo" if lang == "ar" else "Arial", 12),
            command=self.toggle_mode,
            fg_color="#0288D1",
            hover_color="#03A9F4",
            corner_radius=8
        )
        mode_btn.pack(side="right" if lang == "ar" else "left", padx=5)

        self.table_frame = ctk.CTkScrollableFrame(self.main_frame, corner_radius=8, width=window_width - 100)
        self.table_frame.pack(pady=10, fill="both", expand=True)

        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø£Ø³ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… grid
        header_frame = ctk.CTkFrame(self.table_frame, fg_color="#37474F")
        header_frame.grid(row=0, column=0, sticky="ew", pady=5, padx=5)
        header_frame.grid_columnconfigure((0, 1, 2, 3, 4), weight=1)

        headers = [
            ("Ø±Ù‚Ù…" if self.lang == "ar" else "No.", 50),
            ("Ø§Ù„Ø§Ø³Ù…" if self.lang == "ar" else "Name", 200),
            ("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" if self.lang == "ar" else "Total", 100),
            ("Ù…Ù„Ø§Ø­Ø¸Ø§Øª" if self.lang == "ar" else "Notes", 300),
            ("Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" if self.lang == "ar" else "Actions", 100)
        ]

        for col, (text, width) in enumerate(headers):
            ctk.CTkLabel(
                header_frame,
                text=text,
                font=("Cairo" if self.lang == "ar" else "Arial", 14, "bold"),
                width=width
            ).grid(row=0, column=col, padx=5, sticky="ew")

        self.load_students()

    def open_attendance_window(self):
        AttendanceWindow(self, self.account, self.lang, self.mode)

    def update_stats(self):
        students = self.account["students"]
        count = len(students)
        totals = [sum(g["grade"] for g in s.get("grades", [])) for s in students]
        avg = sum(totals) / count if count > 0 else 0
        max_grade = max(totals) if totals else 0
        min_grade = min(totals) if totals else 0
        above_90 = sum(1 for t in totals if (t / MAX_GRADES) * 100 >= 90) if totals else 0

        max_students = [s["name"] for s in students if sum(g["grade"] for g in s.get("grades", [])) == max_grade]
        min_students = [s["name"] for s in students if sum(g["grade"] for g in s.get("grades", [])) == min_grade]

        stats_text = {
            "count": f"Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: {count}" if self.lang == "ar" else f"Number of Students: {count}",
            "avg": f"Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª: {avg:.2f}" if self.lang == "ar" else f"Average Grade: {avg:.2f}",
            "max": f"Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©: {max_grade} ({', '.join(max_students)})" if self.lang == "ar" else f"Highest Grade: {max_grade} ({', '.join(max_students)})",
            "min": f"Ø£Ø¯Ù†Ù‰ Ø¯Ø±Ø¬Ø©: {min_grade} ({', '.join(min_students)})" if self.lang == "ar" else f"Lowest Grade: {min_grade} ({', '.join(min_students)})",
            "above_90": f"Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙˆÙ‚ 90%: {above_90}" if self.lang == "ar" else f"Students above 90%: {above_90}"
        }

        for key, label in self.stats_labels.items():
            label.configure(text=stats_text[key])

    def toggle_language(self):
        new_lang = "en" if self.lang == "ar" else "ar"
        self.destroy()
        StudentWindow(self.account, new_lang, self.mode).mainloop()

    def toggle_mode(self):
        new_mode = "light" if self.mode == "dark" else "dark"
        self.destroy()
        StudentWindow(self.account, self.lang, new_mode).mainloop()

    def filter_students(self):
        search_term = self.search_entry.get().strip().lower()
        filtered_students = [
            s for s in self.account["students"]
            if search_term in s["name"].lower()
        ]
        self.load_students(filtered_students if search_term else self.account["students"])

    def load_students(self, students=None):
        # Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø£Ø³
        for widget in self.table_frame.winfo_children()[1:]:
            widget.destroy()

        students = students or self.account["students"]
        sorted_students = sorted(students, key=lambda x: sum(g["grade"] for g in x.get("grades", [])), reverse=True)

        # Ø¥Ø¹Ø¯Ø§Ø¯ grid Ù„Ù„ØµÙÙˆÙ
        self.table_frame.grid_columnconfigure((0, 1, 2, 3, 4), weight=1)
        for i, student in enumerate(sorted_students):
            total = sum(g["grade"] for g in student.get("grades", []))
            row = ctk.CTkFrame(self.table_frame, corner_radius=5, fg_color="#424242")
            row.grid(row=i+1, column=0, sticky="ew", pady=2, padx=5)
            row.grid_columnconfigure((0, 1, 2, 3, 4), weight=1)

            rank_icon = ""
            if i == 0 and len(sorted_students) >= 1:
                rank_icon = "ğŸ¥‡"
            elif i == 1 and len(sorted_students) >= 2:
                rank_icon = "ğŸ¥ˆ"
            elif i == 2 and len(sorted_students) >= 3:
                rank_icon = "ğŸ¥‰"
            elif i == len(sorted_students) - 1 and len(sorted_students) >= 1:
                rank_icon = "ğŸ¦“"

            ctk.CTkLabel(
                row,
                text=str(i+1),
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                width=50
            ).grid(row=0, column=0, padx=5, sticky="ew")

            name_label = ctk.CTkLabel(
                row,
                text=f"{rank_icon} {student['name']}" if rank_icon else student["name"],
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                width=200,
                anchor="w" if self.lang == "ar" else "e"
            )
            name_label.grid(row=0, column=1, padx=5, sticky="ew")
            if rank_icon == "ğŸ¥‡":
                name_label.configure(cursor="hand2")
                name_label.bind("<Button-1>", lambda e: show_fireworks(self, self.lang))

            ctk.CTkLabel(
                row,
                text=str(total),
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                width=100
            ).grid(row=0, column=2, padx=5, sticky="ew")

            ctk.CTkLabel(
                row,
                text=student.get("info", "")[:30] + ("..." if len(student.get("info", "")) > 30 else ""),
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                width=300,
                anchor="w" if self.lang == "ar" else "e"
            ).grid(row=0, column=3, padx=5, sticky="ew")

            ctk.CTkButton(
                row,
                text="âœï¸ ØªØ¹Ø¯ÙŠÙ„" if self.lang == "ar" else "âœï¸ Edit",
                font=("Cairo" if self.lang == "ar" else "Arial", 14),
                width=100,
                command=lambda s=student: self.edit_student(s),
                fg_color="#0288D1",
                hover_color="#03A9F4",
                corner_radius=8
            ).grid(row=0, column=4, padx=5, sticky="ew")

        self.update_stats()

    def add_student(self):
        name = self.student_entry.get().strip()
        if name and re.match(r"^[a-zA-Z\sØ£-ÙŠ]+$", name):
            if any(s["name"] == name for s in self.account["students"]):
                messagebox.showerror(
                    "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                    "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„." if self.lang == "ar" else "Student name already exists."
                )
                return
            self.account["students"].append({"name": name, "grades": [], "info": "", "attendance": []})
            self.student_entry.delete(0, "end")
            self.load_students()
            self.update_stats()
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ {name} Ø¨Ù†Ø¬Ø§Ø­." if self.lang == "ar" else f"Student {name} added successfully."
            )
        elif name:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙˆÙ ÙÙ‚Ø·." if self.lang == "ar" else "Name must contain letters only."
            )

    def remove_student(self):
        name = self.student_entry.get().strip()
        if name and any(s["name"] == name for s in self.account["students"]):
            self.account["students"] = [s for s in self.account["students"] if s["name"] != name]
            self.student_entry.delete(0, "end")
            self.load_students()
            self.update_stats()
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                f"ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ {name} Ø¨Ù†Ø¬Ø§Ø­." if self.lang == "ar" else f"Student {name} removed successfully."
            )
        elif name:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯." if self.lang == "ar" else "Student name not found."
            )

    def save_students(self):
        full_data = load_data()
        for acc in full_data["accounts"]:
            if acc["institute"] == self.account["institute"] and acc["teacher"] == self.account["teacher"]:
                acc["students"] = self.account["students"]
                break
        save_data(full_data)
        messagebox.showinfo(
            "ØªÙ…" if self.lang == "ar" else "Success",
            "ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…" if self.lang == "ar" else "Student list saved successfully âœ…"
        )

    def restart_students(self):
        if messagebox.askyesno(
            "ØªØ£ÙƒÙŠØ¯" if self.lang == "ar" else "Confirm",
            "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ ÙˆØªÙØ±ÙŠØº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ" if self.lang == "ar" else "Do you want to restart and clear the student list?"
        ):
            self.account["students"] = []
            self.load_students()
            self.update_stats()
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                "ØªÙ… ØªÙØ±ÙŠØº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­." if self.lang == "ar" else "Student list cleared successfully."
            )

    def edit_student(self, student):
        creation_date = datetime.strptime(self.account["created_at"], "%Y-%m-%d")
        if datetime.now() > creation_date + timedelta(days=EDIT_DAYS_LIMIT):
            messagebox.showinfo(
                "ØªÙ†Ø¨ÙŠÙ‡" if self.lang == "ar" else "Alert",
                "Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª." if self.lang == "ar" else "Editing period has expired."
            )
            return

        popup = ctk.CTkToplevel(self)
        popup.title(f"ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª {student['name']}" if self.lang == "ar" else f"Edit {student['name']} Data")
        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        window_width = int(screen_width * 0.5)
        window_height = int(screen_height * 0.7)
        popup.wm_geometry(f"{window_width}x{window_height}+{int((screen_width - window_width) / 2)}+{int((screen_height - window_height) / 2)}")
        popup.transient(self)
        popup.grab_set()

        edit_frame = ctk.CTkFrame(popup, corner_radius=10)
        edit_frame.pack(pady=20, padx=20, fill="both", expand=True)

        ctk.CTkLabel(
            edit_frame,
            text="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:" if self.lang == "ar" else "Student Name:",
            font=("Cairo" if self.lang == "ar" else "Arial", 14)
        ).pack(pady=5)
        name_entry = ctk.CTkEntry(
            edit_frame,
            width=400,
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            corner_radius=8,
            height=40
        )
        name_entry.insert(0, student["name"])
        name_entry.pack(pady=10)

        # Grades section
        ctk.CTkLabel(
            edit_frame,
            text="Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª:" if self.lang == "ar" else "Grades:",
            font=("Cairo" if self.lang == "ar" else "Arial", 14)
        ).pack(pady=5)

        grades_frame = ctk.CTkScrollableFrame(edit_frame, corner_radius=8, height=150)
        grades_frame.pack(fill="x", pady=10)

        self.grade_rows = []
        self.load_grades(grades_frame, student)

        add_grade_frame = ctk.CTkFrame(edit_frame, corner_radius=10)
        add_grade_frame.pack(fill="x", pady=10)

        self.grade_entry = ctk.CTkEntry(
            add_grade_frame,
            placeholder_text="Ø§Ù„Ø¹Ù„Ø§Ù…Ø©" if self.lang == "ar" else "Grade",
            width=100
        )
        self.grade_entry.pack(side="left" if self.lang == "ar" else "right", padx=5)

        self.date_entry = ctk.CTkEntry(
            add_grade_frame,
            placeholder_text="Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD)" if self.lang == "ar" else "Date (YYYY-MM-DD)",
            width=150
        )
        self.date_entry.insert(0, datetime.now().strftime("%Y-%m-%d"))
        self.date_entry.pack(side="left" if self.lang == "ar" else "right", padx=5)

        self.reason_entry = ctk.CTkEntry(
            add_grade_frame,
            placeholder_text="Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" if self.lang == "ar" else "Reason (optional)",
            width=200
        )
        self.reason_entry.pack(side="left" if self.lang == "ar" else "right", padx=5)

        add_grade_btn = ctk.CTkButton(
            add_grade_frame,
            text="â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø©" if self.lang == "ar" else "â• Add Grade",
            command=lambda: self.add_grade(student, grades_frame)
        )
        add_grade_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

        save_grades_btn = ctk.CTkButton(
            edit_frame,
            text="ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª" if self.lang == "ar" else "ğŸ’¾ Save Grades",
            command=lambda: self.save_grades(student, popup)
        )
        save_grades_btn.pack(pady=10)

        ctk.CTkLabel(
            edit_frame,
            text="Ù…Ù„Ø§Ø­Ø¸Ø§Øª:" if self.lang == "ar" else "Notes:",
            font=("Cairo" if self.lang == "ar" else "Arial", 14)
        ).pack(pady=5)
        info_entry = ctk.CTkTextbox(
            edit_frame,
            width=400,
            height=120,
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            corner_radius=8
        )
        info_entry.insert("end", student.get("info", ""))
        info_entry.pack(pady=10)

        def save_changes():
            new_name = name_entry.get().strip()
            if new_name and re.match(r"^[a-zA-Z\sØ£-ÙŠ]+$", new_name):
                student["name"] = new_name
            else:
                messagebox.showerror(
                    "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                    "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­." if self.lang == "ar" else "Invalid student name."
                )
                return

            # Grades are already updated in student["grades"] via add/edit/delete

            student["info"] = info_entry.get("1.0", "end").strip()
            self.load_students()
            self.update_stats()
            popup.destroy()
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…" if self.lang == "ar" else "Changes saved successfully âœ…"
            )

        ctk.CTkButton(
            edit_frame,
            text="ğŸ’¾ Ø­ÙØ¸" if self.lang == "ar" else "ğŸ’¾ Save",
            font=("Cairo" if self.lang == "ar" else "Arial", 14),
            command=save_changes,
            fg_color="#5E2A7E",
            hover_color="#7B1FA2",
            corner_radius=8
        ).pack(pady=15)

    def save_grades(self, student, popup):
        full_data = load_data()
        for acc in full_data["accounts"]:
            if acc["institute"] == self.account["institute"] and acc["teacher"] == self.account["teacher"]:
                for s in acc["students"]:
                    if s["name"] == student["name"]:
                        s["grades"] = student["grades"]
                        break
                break
        save_data(full_data)
        messagebox.showinfo(
            "ØªÙ…" if self.lang == "ar" else "Success",
            "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…" if self.lang == "ar" else "Grades saved successfully âœ…"
        )

    def load_grades(self, frame, student):
        for widget in frame.winfo_children():
            widget.destroy()

        self.grade_rows = []
        # Aggregate grades by date
        from collections import defaultdict
        daily_grades = defaultdict(list)
        for g in student.get("grades", []):
            daily_grades[g["date"]].append(g)

        for date, grades in sorted(daily_grades.items()):
            total_daily = sum(g["grade"] for g in grades)
            row = ctk.CTkFrame(frame, corner_radius=5)
            row.pack(fill="x", pady=5)

            date_label = ctk.CTkLabel(row, text=f"{date}: {total_daily}", width=150)
            date_label.pack(side="left" if self.lang == "ar" else "right", padx=5)

            for idx, g in enumerate(grades):
                sub_row = ctk.CTkFrame(row)
                sub_row.pack(fill="x", padx=20)

                grade_label = ctk.CTkLabel(sub_row, text=str(g["grade"]), width=50)
                grade_label.pack(side="left" if self.lang == "ar" else "right", padx=5)

                reason_label = ctk.CTkLabel(sub_row, text=g.get("reason", ""), width=150)
                reason_label.pack(side="left" if self.lang == "ar" else "right", padx=5)

                global_idx = student["grades"].index(g)
                edit_btn = ctk.CTkButton(
                    sub_row,
                    text="âœï¸" ,
                    width=30,
                    command=lambda gi=global_idx: self.edit_grade(student, gi, frame)
                )
                edit_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

                delete_btn = ctk.CTkButton(
                    sub_row,
                    text="ğŸ—‘ï¸",
                    width=30,
                    fg_color="#D32F2F",
                    hover_color="#F44336",
                    command=lambda gi=global_idx: self.delete_grade(student, gi, frame)
                )
                delete_btn.pack(side="right" if self.lang == "ar" else "left", padx=5)

            self.grade_rows.append(row)

    def add_grade(self, student, frame):
        try:
            grade = int(self.grade_entry.get())
            if grade < 0 or grade > MAX_GRADES:
                raise ValueError
            date = self.date_entry.get()
            datetime.strptime(date, "%Y-%m-%d")  # validate date
            reason = self.reason_entry.get().strip()

            student["grades"].append({"grade": grade, "date": date, "reason": reason})
            self.grade_entry.delete(0, "end")
            self.reason_entry.delete(0, "end")
            self.load_grades(frame, student)
        except ValueError:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ø£Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­." if self.lang == "ar" else "Invalid grade or date."
            )

    def edit_grade(self, student, idx, frame):
        g = student["grades"][idx]
        edit_popup = ctk.CTkToplevel(self)
        edit_popup.title("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©" if self.lang == "ar" else "Edit Grade")
        edit_popup.geometry("300x200")

        grade_entry = ctk.CTkEntry(edit_popup, placeholder_text="Ø§Ù„Ø¹Ù„Ø§Ù…Ø©")
        grade_entry.insert(0, str(g["grade"]))
        grade_entry.pack(pady=10)

        date_entry = ctk.CTkEntry(edit_popup, placeholder_text="Ø§Ù„ØªØ§Ø±ÙŠØ®")
        date_entry.insert(0, g["date"])
        date_entry.pack(pady=10)

        reason_entry = ctk.CTkEntry(edit_popup, placeholder_text="Ø§Ù„Ø³Ø¨Ø¨")
        reason_entry.insert(0, g.get("reason", ""))
        reason_entry.pack(pady=10)

        def save_edit():
            try:
                grade = int(grade_entry.get())
                if grade < 0 or grade > MAX_GRADES:
                    raise ValueError
                date = date_entry.get()
                datetime.strptime(date, "%Y-%m-%d")
                reason = reason_entry.get().strip()
                student["grades"][idx] = {"grade": grade, "date": date, "reason": reason}
                self.load_grades(frame, student)
                edit_popup.destroy()
            except ValueError:
                messagebox.showerror("Ø®Ø·Ø£", "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©.")

        save_btn = ctk.CTkButton(edit_popup, text="Ø­ÙØ¸", command=save_edit)
        save_btn.pack(pady=10)

    def delete_grade(self, student, idx, frame):
        if messagebox.askyesno("ØªØ£ÙƒÙŠØ¯", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©ØŸ"):
            del student["grades"][idx]
            self.load_grades(frame, student)

    def back_to_manager(self):
        self.destroy()
        AccountManagerWindow(self.lang, self.mode).mainloop()

    def export_to_excel(self):
        self.attributes("-disabled", True)
        try:
            wb = Workbook()
            ws = wb.active
            ws.title = "Students"
            ws.append([
                "Ø§Ù„Ø§Ø³Ù…" if self.lang == "ar" else "Name",
                "Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª" if self.lang == "ar" else "Grades",
                "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" if self.lang == "ar" else "Total",
                "Ù…Ù„Ø§Ø­Ø¸Ø§Øª" if self.lang == "ar" else "Notes"
            ])

            for student in self.account["students"]:
                grades_str = " ".join([f"{g['grade']} ({g['date']}, {g.get('reason', '')})" for g in student.get("grades", [])])
                total = sum(g["grade"] for g in student.get("grades", []))
                ws.append([
                    student["name"],
                    grades_str,
                    total,
                    student.get("info", "")
                ])

            wb.save("students_data.xlsx")
            messagebox.showinfo(
                "ØªÙ…" if self.lang == "ar" else "Success",
                "ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­ âœ…" if self.lang == "ar" else "Data exported to Excel successfully âœ…"
            )
        except PermissionError:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                "Ø§Ù„Ù…Ù„Ù Ù…ÙØªÙˆØ­ ÙÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¢Ø®Ø±. Ø£ØºÙ„Ù‚ Ø§Ù„Ù…Ù„Ù ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹." if self.lang == "ar" else "File is open in another program. Close it and try again."
            )
        except Exception as e:
            messagebox.showerror(
                "Ø®Ø·Ø£" if self.lang == "ar" else "Error",
                f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: {str(e)}" if self.lang == "ar" else f"Error during export: {str(e)}"
            )
        finally:
            self.attributes("-disabled", False)

# ============================================================
# ğŸŸ¢ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# ============================================================
if __name__ == "__main__":
    data = load_data()
    if not data["accounts"]:
        CreateAccountWindow().mainloop()
    else:
        AccountManagerWindow().mainloop()
