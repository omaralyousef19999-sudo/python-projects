import customtkinter as ctk
from tkinter import messagebox, simpledialog
import json
import os
from datetime import datetime, timedelta
from openpyxl import Workbook

# ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ==========
ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("dark-blue")

DATA_FILE = "students_data.json"

# ============================================================
# ğŸ”¹ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù
# ============================================================
def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f, indent=4)

# ============================================================
# ğŸ”¹ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù
# ============================================================
def load_data():
    if not os.path.exists(DATA_FILE):
        return {}
    with open(DATA_FILE, "r") as f:
        return json.load(f)

# ============================================================
# ğŸ”¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
# ============================================================
class CreateAccountWindow(ctk.CTk):
    def __init__(self):
        super().__init__()
        self.title("Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯ - Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨")
        self.geometry("600x400")
        self.resizable(False, False)

        self.data = load_data()

        ctk.CTkLabel(self, text="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø³ØªØ§Ø°", font=("Cairo", 22, "bold")).pack(pady=20)

        self.name_entry = ctk.CTkEntry(self, placeholder_text="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°")
        self.name_entry.pack(pady=10, padx=40, fill="x")

        self.inst_entry = ctk.CTkEntry(self, placeholder_text="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù‡Ø¯")
        self.inst_entry.pack(pady=10, padx=40, fill="x")

        self.students = []

        self.add_students_btn = ctk.CTkButton(self, text="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨", command=self.open_student_popup)
        self.add_students_btn.pack(pady=15)

        self.create_btn = ctk.CTkButton(self, text="Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨", fg_color="#5E2A7E", command=self.create_account)
        self.create_btn.pack(pady=25)

    def open_student_popup(self):
        popup = ctk.CTkToplevel(self)
        popup.title("Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨")
        popup.geometry("400x400")

        self.student_listbox = ctk.CTkTextbox(popup, width=350, height=220)
        self.student_listbox.pack(pady=15)

        add_btn = ctk.CTkButton(popup, text="Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨", command=lambda: self.add_student(popup))
        add_btn.pack(pady=5)

        remove_btn = ctk.CTkButton(popup, text="Ø­Ø°Ù Ø·Ø§Ù„Ø¨", fg_color="#AA3333", command=lambda: self.remove_student(popup))
        remove_btn.pack(pady=5)

        save_btn = ctk.CTkButton(popup, text="Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©", fg_color="#5E2A7E", command=lambda: self.save_students(popup))
        save_btn.pack(pady=15)

    def add_student(self, popup):
        name = simpledialog.askstring("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨", "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:")
        if name:
            self.students.append({"name": name, "grades": [], "info": ""})
            self.refresh_students_display()

    def remove_student(self, popup):
        name = simpledialog.askstring("Ø­Ø°Ù Ø·Ø§Ù„Ø¨", "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡:")
        self.students = [s for s in self.students if s["name"] != name]
        self.refresh_students_display()

    def refresh_students_display(self):
        text = "\n".join([s["name"] for s in self.students])
        self.student_listbox.delete("1.0", "end")
        self.student_listbox.insert("end", text)

    def save_students(self, popup):
        if not self.students:
            messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
            return
        popup.destroy()
        messagebox.showinfo("ØªÙ…", "ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…")

    def create_account(self):
        name = self.name_entry.get().strip()
        inst = self.inst_entry.get().strip()

        if not name or not inst:
            messagebox.showerror("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")
            return

        if not self.students:
            messagebox.showerror("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹.")
            return

        creation_date = datetime.now().strftime("%Y-%m-%d")

        self.data = {
            "teacher": name,
            "institute": inst,
            "created_at": creation_date,
            "students": self.students
        }

        save_data(self.data)
        messagebox.showinfo("ØªÙ…", "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰")

        self.destroy()
        StudentWindow(self.data).mainloop()


# ============================================================
# ğŸ”¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
# ============================================================
class StudentWindow(ctk.CTk):
    def __init__(self, data):
        super().__init__()
        self.data = data
        self.title("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨")
        self.geometry("800x500")
        self.resizable(False, False)

        ctk.CTkLabel(self, text=f"Ø§Ù„Ù…Ø¹Ù‡Ø¯: {data['institute']}", font=("Cairo", 20, "bold")).pack(pady=10)

        # Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
        export_btn = ctk.CTkButton(self, text="ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel", fg_color="#5E2A7E", command=self.export_to_excel)
        export_btn.pack(pady=5)

        self.frame = ctk.CTkScrollableFrame(self, width=700, height=400)
        self.frame.pack(pady=10)

        self.load_students()

    def load_students(self):
        for widget in self.frame.winfo_children():
            widget.destroy()

        for i, student in enumerate(self.data["students"]):
            total = sum(student.get("grades", []))
            row = ctk.CTkFrame(self.frame)
            row.pack(fill="x", pady=5, padx=10)

            ctk.CTkLabel(row, text=f"{i+1}- {student['name']}", font=("Cairo", 16)).pack(side="left", padx=10)
            ctk.CTkLabel(row, text=f"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {total}", font=("Cairo", 16)).pack(side="left", padx=20)
            ctk.CTkButton(row, text="ØªØ¹Ø¯ÙŠÙ„", width=70, command=lambda s=student: self.edit_student(s)).pack(side="right", padx=10)

    def edit_student(self, student):
        popup = ctk.CTkToplevel(self)
        popup.title(f"ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª {student['name']}")
        popup.geometry("400x400")

        grades_text = ctk.CTkTextbox(popup, width=350, height=100)
        grades_text.insert("end", " ".join(map(str, student.get("grades", []))))
        grades_text.pack(pady=15)

        info_entry = ctk.CTkTextbox(popup, width=350, height=80)
        info_entry.insert("end", student.get("info", ""))
        info_entry.pack(pady=10)

        def save_changes():
            grades_str = grades_text.get("1.0", "end").strip()
            if grades_str:
                student["grades"] = list(map(int, grades_str.split()))
            student["info"] = info_entry.get("1.0", "end").strip()

            save_data(self.data)
            popup.destroy()
            self.load_students()

        ctk.CTkButton(popup, text="ğŸ’¾ Ø­ÙØ¸", fg_color="#5E2A7E", command=save_changes).pack(pady=10)

    def export_to_excel(self):
        wb = Workbook()
        ws = wb.active
        ws.title = "Students"

        ws.append(["Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª"])

        for student in self.data["students"]:
            total = sum(student.get("grades", []))
            ws.append([student["name"], " ".join(map(str, student.get("grades", []))), total, student.get("info", "")])

        wb.save("students_data.xlsx")
        messagebox.showinfo("ØªÙ…", "ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­ âœ…")


# ============================================================
# ğŸŸ¢ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# ============================================================
if __name__ == "__main__":
    if os.path.exists(DATA_FILE):
        data = load_data()
        creation_date = datetime.strptime(data["created_at"], "%Y-%m-%d")
        if datetime.now() > creation_date + timedelta(days=5):
            # Ù‚ÙÙ„ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯ 5 Ø£ÙŠØ§Ù…
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨.")
        StudentWindow(data).mainloop()
    else:
        CreateAccountWindow().mainloop()
