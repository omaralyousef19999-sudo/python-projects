# main.py - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© 2025 (ÙƒÙ„ Ø­Ø§Ø¬Ø© Ø´ØºØ§Ù„Ø©)
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button
from kivy.uix.textinput import TextInput
from kivy.uix.scrollview import ScrollView
from kivy.uix.gridlayout import GridLayout
from kivy.uix.image import AsyncImage
from kivy.uix.modalview import ModalView
from kivy.uix.popup import Popup
from kivy.uix.tabbedpanel import TabbedPanel, TabbedPanelItem
from kivy.clock import Clock
from kivy.animation import Animation
from kivy.graphics import Color, RoundedRectangle, Line
from kivy.core.window import Window
from kivy.metrics import dp, sp
import json
import os
from datetime import datetime

Window.clearcolor = (0.04, 0.06, 0.12, 1)
Window.size = (420, 850)

# Ù…Ù„Ù Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
DATA_FILE = "ucl_predictor_data.json"

# Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ÙØ±Ù‚
team_emojis = {
    "Arsenal": "ğŸ”´", "Liverpool": "ğŸ”´", "Real Madrid": "âšª", 
    "Paris SG": "ğŸ”µ", "Bayern Munich": "ğŸ”´", "Slavia Praha": "ğŸ”´",
    "Man City": "ğŸ”µ", "Barcelona": "ğŸ”µ", "Inter": "ğŸ”µ", "Dortmund": "ğŸŸ¡"
}

# Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© - Matchday 5
matches = [
    {"id": "1", "team1": "Arsenal", "team2": "Slavia Praha", "date": "25 Ù†ÙˆÙÙ…Ø¨Ø± 2025 - 21:00", "played": False},
    {"id": "2", "team1": "Liverpool", "team2": "Real Madrid", "date": "26 Ù†ÙˆÙÙ…Ø¨Ø± 2025 - 20:45", "played": False},
    {"id": "3", "team1": "Paris SG", "team2": "Bayern Munich", "date": "25 Ù†ÙˆÙÙ…Ø¨Ø± 2025 - 21:00", "played": False},
    {"id": "4", "team1": "Man City", "team2": "Barcelona", "date": "27 Ù†ÙˆÙÙ…Ø¨Ø± 2025 - 21:00", "played": False},
]

class DataManager:
    @staticmethod
    def load():
        if os.path.exists(DATA_FILE):
            try:
                with open(DATA_FILE, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except: 
                return {"users": {}, "predictions": {}, "likes": [], "stats": {}}
        return {"users": {}, "predictions": {}, "likes": [], "stats": {}}
    
    @staticmethod
    def save(data):
        with open(DATA_FILE, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=4, ensure_ascii=False)

class ModernLabel(Label):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.color = (1, 1, 1, 1)
        self.halign = 'center'
        self.valign = 'middle'

class ModernButton(Button):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.background_color = (0, 0.6, 1, 1)
        self.color = (1, 1, 1, 1)
        self.font_size = sp(16)
        self.bold = True

class LoginModal(ModalView):
    def __init__(self, app, **kwargs):
        super().__init__(**kwargs)
        self.app = app
        self.size_hint = (0.9, 0.8)
        self.background_color = (0.08, 0.1, 0.2, 0.98)
        self.overlay_color = (0, 0, 0, 0.5)

        layout = BoxLayout(orientation='vertical', padding=dp(30), spacing=dp(25))
        
        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        title_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.15))
        title_layout.add_widget(Label(text="ğŸ”", font_size=sp(35)))
        title_layout.add_widget(ModernLabel(text="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", font_size=sp(28), bold=True))
        layout.add_widget(title_layout)

        # Ø­Ø§ÙˆÙŠØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_container = BoxLayout(orientation='vertical', size_hint=(1, 0.2), spacing=dp(8))
        user_container.add_widget(ModernLabel(text="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", font_size=sp(18)))
        self.username = TextInput(
            hint_text="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...",
            size_hint_y=None, 
            height=dp(55),
            font_size=sp(18),
            background_color=(0.15, 0.18, 0.25, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(15), dp(15)],
            multiline=False
        )
        user_container.add_widget(self.username)
        layout.add_widget(user_container)

        # Ø­Ø§ÙˆÙŠØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        pass_container = BoxLayout(orientation='vertical', size_hint=(1, 0.2), spacing=dp(8))
        pass_container.add_widget(ModernLabel(text="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", font_size=sp(18)))
        self.password = TextInput(
            hint_text="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...",
            password=True,
            size_hint_y=None, 
            height=dp(55),
            font_size=sp(18),
            background_color=(0.15, 0.18, 0.25, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(15), dp(15)],
            multiline=False
        )
        pass_container.add_widget(self.password)
        layout.add_widget(pass_container)

        # Ø£Ø²Ø±Ø§Ø±
        btns = BoxLayout(spacing=dp(15), size_hint_y=None, height=dp(60))
        login_btn = ModernButton(text="ğŸš€ Ø¯Ø®ÙˆÙ„", on_press=self.login)
        register_btn = ModernButton(text="â­ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯", background_color=(0.1, 0.8, 0.3, 1), on_press=self.register)
        
        btns.add_widget(login_btn)
        btns.add_widget(register_btn)
        layout.add_widget(btns)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        info_label = ModernLabel(
            text="ğŸ’¡ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ!",
            font_size=sp(14),
            color=(0.7, 0.8, 1, 1)
        )
        layout.add_widget(info_label)

        self.add_widget(layout)

    def login(self, btn):
        if not self.username.text.strip():
            return self.show_error("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        
        data = DataManager.load()
        key = f"{self.username.text.strip()}"
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
        user_found = None
        for user_key, user_data in data["users"].items():
            if user_data["name"] == self.username.text.strip():
                user_found = user_data
                break
        
        if user_found:
            self.app.current_user = user_found
            self.app.update_header()
            self.dismiss()
            self.app.show_popup(f"ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ {user_found['name']}!")
        else:
            self.show_error("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")

    def register(self, btn):
        username = self.username.text.strip()
        password = self.password.text.strip()
        
        if not username or len(username) < 3:
            return self.show_error("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„")
        
        if not password or len(password) < 4:
            return self.show_error("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„")
        
        data = DataManager.load()
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø±
        for user_data in data["users"].values():
            if user_data["name"] == username:
                return self.show_error("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        new_user = {
            "name": username,
            "password": password,  # ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ÙŠØ¬Ø¨ ØªØ´ÙÙŠØ±Ù‡Ø§
            "join_date": datetime.now().strftime("%Y-%m-%d %H:%M"),
            "predictions": 0,
            "points": 0,
            "correct_predictions": 0,
            "favorite_team": "âš½"
        }
        
        user_key = f"{username}_{datetime.now().timestamp()}"
        data["users"][user_key] = new_user
        DataManager.save(data)
        
        self.app.current_user = new_user
        self.app.update_header()
        self.dismiss()
        self.app.show_popup(f"ğŸŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ {username} Ø¨Ù†Ø¬Ø§Ø­!")

    def show_error(self, msg):
        popup = Popup(
            title="",
            content=ModernLabel(text=msg, font_size=sp(18)),
            size_hint=(0.8, 0.4),
            background_color=(0.9, 0.3, 0.3, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 3)

class PredictModal(ModalView):
    def __init__(self, app, match, **kwargs):
        super().__init__(**kwargs)
        self.app = app
        self.match = match
        self.size_hint = (0.95, 0.85)
        self.background_color = (0.08, 0.1, 0.2, 0.98)

        layout = BoxLayout(orientation='vertical', padding=dp(25), spacing=dp(20))
        
        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.15))
        title_layout.add_widget(Label(text="ğŸ¯", font_size=sp(30)))
        title_layout.add_widget(ModernLabel(
            text=f"ØªÙˆÙ‚Ø¹ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©", 
            font_size=sp(24), 
            bold=True,
            color=(0, 0.8, 1, 1)
        ))
        layout.add_widget(title_layout)
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
        match_info = BoxLayout(orientation='horizontal', size_hint=(1, 0.2), spacing=dp(20))
        team1_layout = BoxLayout(orientation='vertical')
        team1_layout.add_widget(ModernLabel(text=team_emojis.get(match['team1'], "âš½"), font_size=sp(35)))
        team1_layout.add_widget(ModernLabel(text=match['team1'], font_size=sp(18), bold=True))
        
        vs_layout = BoxLayout(orientation='vertical')
        vs_layout.add_widget(ModernLabel(text="VS", font_size=sp(20), color=(0.8, 0.8, 0.8, 1)))
        vs_layout.add_widget(ModernLabel(text=match['date'], font_size=sp(14), color=(0.7, 0.9, 1, 1)))
        
        team2_layout = BoxLayout(orientation='vertical')
        team2_layout.add_widget(ModernLabel(text=team_emojis.get(match['team2'], "âš½"), font_size=sp(35)))
        team2_layout.add_widget(ModernLabel(text=match['team2'], font_size=sp(18), bold=True))
        
        match_info.add_widget(team1_layout)
        match_info.add_widget(vs_layout)
        match_info.add_widget(team2_layout)
        layout.add_widget(match_info)

        # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        score_layout = BoxLayout(orientation='vertical', size_hint=(1, 0.25), spacing=dp(10))
        score_layout.add_widget(ModernLabel(text="ğŸ“Š ØªÙˆÙ‚Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©", font_size=sp(18)))
        
        score_inputs = BoxLayout(orientation='horizontal', size_hint_y=None, height=dp(100), spacing=dp(30))
        self.g1 = TextInput(
            text="2", 
            font_size=sp(50), 
            input_filter='int', 
            halign='center',
            background_color=(0.15, 0.18, 0.25, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)]
        )
        self.g2 = TextInput(
            text="1", 
            font_size=sp(50), 
            input_filter='int', 
            halign='center',
            background_color=(0.15, 0.18, 0.25, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)]
        )
        score_inputs.add_widget(self.g1)
        score_inputs.add_widget(ModernLabel(text="-", font_size=sp(50)))
        score_inputs.add_widget(self.g2)
        score_layout.add_widget(score_inputs)
        layout.add_widget(score_layout)

        # Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ†
        scorers_layout = BoxLayout(orientation='vertical', size_hint=(1, 0.3), spacing=dp(10))
        scorers_layout.add_widget(ModernLabel(text="âš½ Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", font_size=sp(16)))
        self.scorers = TextInput(
            hint_text="Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ÙŠÙ†...",
            size_hint_y=None, 
            height=dp(100),
            font_size=sp(16),
            background_color=(0.15, 0.18, 0.25, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(15), dp(15)],
            multiline=True
        )
        scorers_layout.add_widget(self.scorers)
        layout.add_widget(scorers_layout)

        # Ø²Ø± Ø§Ù„Ø­ÙØ¸
        save_btn = ModernButton(
            text="ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚Ø¹", 
            background_color=(0.1, 0.8, 0.3, 1), 
            size_hint_y=None, 
            height=dp(60), 
            on_press=self.save
        )
        layout.add_widget(save_btn)

        self.add_widget(layout)

    def save(self, btn):
        if not self.app.current_user:
            self.app.show_popup("ğŸ” ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!")
            self.dismiss()
            return
        
        try:
            score1 = int(self.g1.text) if self.g1.text else 0
            score2 = int(self.g2.text) if self.g2.text else 0
        except:
            self.app.show_popup("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©")
            return
        
        data = DataManager.load()
        pred_id = f"{self.match['id']}_{self.app.current_user['name']}"
        data["predictions"][pred_id] = {
            "match_id": self.match["id"],
            "user": self.app.current_user["name"],
            "score": f"{score1}-{score2}",
            "scorers": self.scorers.text,
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M"),
            "match_info": f"{self.match['team1']} vs {self.match['team2']}"
        }
        
        # ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_key = next((k for k, v in data["users"].items() if v["name"] == self.app.current_user["name"]), None)
        if user_key:
            data["users"][user_key]["predictions"] = data["users"][user_key].get("predictions", 0) + 1
        
        DataManager.save(data)
        self.app.show_popup("âœ… ØªÙ… Ø­ÙØ¸ ØªÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­!")
        self.dismiss()

class MatchCard(BoxLayout):
    def __init__(self, app, match, **kwargs):
        super().__init__(**kwargs)
        self.app = app
        self.match = match
        self.orientation = 'vertical'
        self.height = dp(280)
        self.size_hint_y = None
        self.padding = dp(20)
        self.spacing = dp(15)

        with self.canvas.before:
            Color(0.08, 0.10, 0.18, 1)
            self.rect = RoundedRectangle(pos=self.pos, size=self.size, radius=[dp(20)])
            Color(0, 0.6, 1, 0.8)
            self.line = Line(width=dp(3))

        self.bind(pos=self.update_gfx, size=self.update_gfx)

        # Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        header = BoxLayout(orientation='horizontal', size_hint=(1, 0.3))
        header.add_widget(ModernLabel(text="ğŸ† Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", font_size=sp(16), color=(0.7, 0.9, 1, 1)))
        header.add_widget(ModernLabel(text=match['date'], font_size=sp(14), color=(0.8, 0.8, 0.8, 1)))
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ†
        teams_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.5), spacing=dp(10))
        
        # Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„
        team1_layout = BoxLayout(orientation='vertical')
        team1_layout.add_widget(ModernLabel(text=team_emojis.get(match['team1'], "âš½"), font_size=sp(40)))
        team1_layout.add_widget(ModernLabel(text=match['team1'], font_size=sp(18), bold=True))
        
        # VS
        vs_layout = BoxLayout(orientation='vertical')
        vs_layout.add_widget(ModernLabel(text="VS", font_size=sp(24), color=(1, 0.8, 0.2, 1)))
        vs_layout.add_widget(ModernLabel(text="Ù…Ø¨Ø§Ø±Ø§Ø© Ù‚Ø§Ø¯Ù…Ø©", font_size=sp(14), color=(0.6, 0.8, 1, 1)))
        
        # Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ
        team2_layout = BoxLayout(orientation='vertical')
        team2_layout.add_widget(ModernLabel(text=team_emojis.get(match['team2'], "âš½"), font_size=sp(40)))
        team2_layout.add_widget(ModernLabel(text=match['team2'], font_size=sp(18), bold=True))
        
        teams_layout.add_widget(team1_layout)
        teams_layout.add_widget(vs_layout)
        teams_layout.add_widget(team2_layout)

        # Ø²Ø± Ø§Ù„ØªÙˆÙ‚Ø¹
        predict_btn = ModernButton(
            text="ğŸ¯ ØªÙˆÙ‚Ø¹ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©", 
            background_color=(0, 0.7, 1, 1), 
            size_hint_y=None, 
            height=dp(55)
        )
        predict_btn.bind(on_press=lambda x: PredictModal(app, match).open())

        self.add_widget(header)
        self.add_widget(teams_layout)
        self.add_widget(predict_btn)

    def update_gfx(self, *args):
        self.rect.pos = self.pos
        self.rect.size = self.size
        self.line.points = [
            self.x + dp(30), self.y + self.height - dp(5),
            self.x + self.width - dp(30), self.y + self.height - dp(5)
        ]

class UserProfileModal(ModalView):
    def __init__(self, app, **kwargs):
        super().__init__(**kwargs)
        self.app = app
        self.size_hint = (0.85, 0.7)
        self.background_color = (0.08, 0.1, 0.2, 0.98)
        
        layout = BoxLayout(orientation='vertical', padding=dp(30), spacing=dp(20))
        
        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title = ModernLabel(text="ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", font_size=sp(26), bold=True, color=(0, 0.8, 1, 1))
        layout.add_widget(title)
        
        if self.app.current_user:
            # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            user_info = BoxLayout(orientation='vertical', spacing=dp(15))
            user_info.add_widget(ModernLabel(
                text=f"ğŸ†” {self.app.current_user['name']}", 
                font_size=sp(22),
                bold=True
            ))
            user_info.add_widget(ModernLabel(
                text=f"ğŸ“… Ø§Ù†Ø¶Ù… ÙÙŠ: {self.app.current_user.get('join_date', 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}",
                font_size=sp(16)
            ))
            user_info.add_widget(ModernLabel(
                text=f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª: {self.app.current_user.get('predictions', 0)}",
                font_size=sp(16)
            ))
            user_info.add_widget(ModernLabel(
                text=f"â­ Ø§Ù„Ù†Ù‚Ø§Ø·: {self.app.current_user.get('points', 0)}",
                font_size=sp(16),
                color=(1, 0.8, 0.2, 1)
            ))
            layout.add_widget(user_info)
            
            # Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            logout_btn = ModernButton(
                text="ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", 
                background_color=(0.9, 0.3, 0.3, 1),
                on_press=self.logout
            )
            layout.add_widget(logout_btn)
        else:
            layout.add_widget(ModernLabel(text="âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„", font_size=sp(20)))
        
        self.add_widget(layout)
    
    def logout(self, instance):
        self.app.current_user = None
        self.app.update_header()
        self.dismiss()
        self.app.show_popup("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!")

class UCLApp(App):
    def build(self):
        self.title = "UCL Predictor 2025 ğŸ†"
        self.current_user = None
        self.data = DataManager.load()

        root = BoxLayout(orientation='vertical')

        # Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø­Ø³Ù†
        self.header = BoxLayout(size_hint_y=None, height=dp(120), padding=dp(20))
        with self.header.canvas.before:
            Color(0.02, 0.04, 0.10, 1)
            RoundedRectangle(pos=self.header.pos, size=self.header.size, radius=[0,0,dp(35),dp(35)])

        # Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‡ÙŠØ¯Ø±
        header_content = BoxLayout(orientation='horizontal')
        
        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        title_layout = BoxLayout(orientation='horizontal', size_hint_x=0.4)
        title_layout.add_widget(Label(text="ğŸ†", font_size=sp(30)))
        title_layout.add_widget(ModernLabel(text="Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", font_size=sp(20), bold=True))
        
        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        self.user_label = ModernLabel(text="ğŸ‘¤ ØºÙŠØ± Ù…Ø³Ø¬Ù„", font_size=sp(16), color=(0.7,0.9,1,1))
        
        # Ø£Ø²Ø±Ø§Ø±
        btn_layout = BoxLayout(orientation='horizontal', size_hint_x=0.4, spacing=dp(10))
        self.profile_btn = ModernButton(
            text="ğŸ‘¤", 
            size_hint_x=0.3,
            on_press=lambda x: UserProfileModal(self).open()
        )
        self.login_btn = ModernButton(
            text="Ø¯Ø®ÙˆÙ„", 
            size_hint_x=0.7,
            on_press=lambda x: LoginModal(self).open()
        )
        
        btn_layout.add_widget(self.profile_btn)
        btn_layout.add_widget(self.login_btn)
        
        header_content.add_widget(title_layout)
        header_content.add_widget(self.user_label)
        header_content.add_widget(btn_layout)
        
        self.header.add_widget(header_content)
        root.add_widget(self.header)

        # Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ø³ÙƒØ±ÙˆÙ„ ÙÙŠÙˆ
        scroll = ScrollView()
        self.grid = GridLayout(cols=1, spacing=dp(25), size_hint_y=None, padding=dp(25))
        self.grid.bind(minimum_height=self.grid.setter('height'))

        for m in matches:
            card = MatchCard(self, m)
            self.grid.add_widget(card)
            card.opacity = 0
            anim = Animation(opacity=1, y=card.y + dp(50), duration=0.8, t='out_back')
            Clock.schedule_once(lambda dt, c=card: anim.start(c), len(self.grid.children)*0.15)

        scroll.add_widget(self.grid)
        root.add_widget(scroll)
        
        return root

    def update_header(self):
        if self.current_user:
            self.user_label.text = f"ğŸ‘¤ {self.current_user['name']}"
            self.login_btn.text = "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"
            self.login_btn.background_color = (0.9, 0.3, 0.3, 1)
            self.login_btn.bind(on_press=self.logout)
        else:
            self.user_label.text = "ğŸ‘¤ ØºÙŠØ± Ù…Ø³Ø¬Ù„"
            self.login_btn.text = "Ø¯Ø®ÙˆÙ„"
            self.login_btn.background_color = (0, 0.7, 1, 1)
            self.login_btn.bind(on_press=lambda x: LoginModal(self).open())

    def logout(self, btn):
        self.current_user = None
        self.update_header()
        self.show_popup("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬")

    def show_popup(self, msg):
        content = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(10))
        content.add_widget(ModernLabel(text=msg, font_size=sp(20)))
        
        popup = Popup(
            title="",
            content=content,
            size_hint=(0.8, 0.4),
            background_color=(0.1, 0.2, 0.3, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 2)

if __name__ == '__main__':
    UCLApp().run()
