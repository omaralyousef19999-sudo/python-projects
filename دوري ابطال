from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView
from kivy.uix.gridlayout import GridLayout
from kivy.uix.tabbedpanel import TabbedPanel, TabbedPanelItem
from kivy.uix.textinput import TextInput
from kivy.uix.modalview import ModalView
from kivy.uix.popup import Popup
from kivy.clock import Clock
from kivy.graphics import Color, Rectangle, RoundedRectangle
from kivy.core.window import Window
from kivy.metrics import dp
import threading
import json
import os
from datetime import datetime

Window.clearcolor = (0.05, 0.08, 0.15, 1)

class ModernLabel(Label):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.color = (1, 1, 1, 1)

class ModernButton(Button):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.background_color = (0, 0, 0, 0)
        self.color = (1, 1, 1, 1)
        self.font_size = dp(14)
        self.bold = True

class CardLayout(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.size_hint_y = None
        self.padding = dp(15)
        self.spacing = dp(8)
        
        with self.canvas.before:
            Color(0.15, 0.2, 0.3, 1)
            self.rect = RoundedRectangle(
                pos=self.pos, 
                size=self.size,
                radius=[dp(15),]
            )
        self.bind(pos=self.update_rect, size=self.update_rect)
    
    def update_rect(self, *args):
        self.rect.pos = self.pos
        self.rect.size = self.size

class IconLabel(BoxLayout):
    def __init__(self, icon, text, icon_size=dp(20), font_size=dp(14), **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'horizontal'
        self.spacing = dp(8)
        self.padding = [dp(5), 0]
        
        icon_label = Label(
            text=icon,
            font_size=icon_size,
            size_hint=(None, None),
            size=(icon_size, icon_size),
            color=(1, 1, 1, 1)
        )
        
        text_label = Label(
            text=text,
            font_size=font_size,
            color=(1, 1, 1, 1),
            halign='left',
            valign='middle'
        )
        text_label.bind(size=text_label.setter('text_size'))
        
        self.add_widget(icon_label)
        self.add_widget(text_label)

class LoginSection(BoxLayout):
    def __init__(self, on_login_success, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.spacing = dp(15)
        self.padding = dp(20)
        self.on_login_success = on_login_success
        self.create_ui()
    
    def create_ui(self):
        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title = ModernLabel(
            text="ğŸ” Create Account / Login",
            font_size=dp(22),
            bold=True,
            halign='center',
            size_hint=(1, 0.2)
        )
        self.add_widget(title)
        
        # Ø­Ø§ÙˆÙŠØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        username_container = BoxLayout(orientation='vertical', size_hint=(1, 0.25), spacing=dp(5))
        username_label = ModernLabel(text="ğŸ‘¤ Username:", font_size=dp(16))
        self.username_input = TextInput(
            multiline=False,
            font_size=dp(18),
            size_hint=(1, 0.7),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(15), dp(15)],
            hint_text="Enter your username...",
            hint_text_color=(0.7, 0.7, 0.8, 0.7)
        )
        username_container.add_widget(username_label)
        username_container.add_widget(self.username_input)
        
        # Ø­Ø§ÙˆÙŠØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        password_container = BoxLayout(orientation='vertical', size_hint=(1, 0.25), spacing=dp(5))
        password_label = ModernLabel(text="ğŸ”’ Password:", font_size=dp(16))
        self.password_input = TextInput(
            multiline=False,
            password=True,
            font_size=dp(18),
            size_hint=(1, 0.7),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(15), dp(15)],
            hint_text="Enter your password...",
            hint_text_color=(0.7, 0.7, 0.8, 0.7)
        )
        password_container.add_widget(password_label)
        password_container.add_widget(self.password_input)
        
        # Ø­Ø§ÙˆÙŠØ© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙˆÙ‚Ø¹
        strategy_container = BoxLayout(orientation='vertical', size_hint=(1, 0.4), spacing=dp(5))
        strategy_label = ModernLabel(text="ğŸ¯ Prediction Strategy:", font_size=dp(16))
        self.strategy_input = TextInput(
            multiline=True,
            font_size=dp(16),
            size_hint=(1, 0.8),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(15), dp(15)],
            hint_text="Describe your prediction strategy and approach...",
            hint_text_color=(0.7, 0.7, 0.8, 0.7)
        )
        strategy_container.add_widget(strategy_label)
        strategy_container.add_widget(self.strategy_input)
        
        # Ø£Ø²Ø±Ø§Ø±
        buttons_container = BoxLayout(size_hint=(1, 0.2), spacing=dp(15))
        
        register_btn = Button(
            text='âœ… Register New Account',
            font_size=dp(16),
            background_color=(0.2, 0.6, 0.2, 1),
            on_press=self.register_account
        )
        
        login_btn = Button(
            text='ğŸ” Login to Existing Account',
            font_size=dp(16),
            background_color=(0.2, 0.4, 0.8, 1),
            on_press=self.login_account
        )
        
        buttons_container.add_widget(register_btn)
        buttons_container.add_widget(login_btn)
        
        self.add_widget(username_container)
        self.add_widget(password_container)
        self.add_widget(strategy_container)
        self.add_widget(buttons_container)
    
    def register_account(self, instance):
        username = self.username_input.text.strip()
        password = self.password_input.text.strip()
        strategy = self.strategy_input.text.strip()
        
        if not username or not password:
            self.show_error("âŒ Please fill in all fields!")
            return
        
        if len(username) < 3:
            self.show_error("âŒ Username must be at least 3 characters!")
            return
        
        if len(password) < 4:
            self.show_error("âŒ Password must be at least 4 characters!")
            return
        
        if not strategy:
            self.show_error("âŒ Please describe your prediction strategy!")
            return
        
        # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_key = f"{username}_{password}"
        users_data = self.load_users_data()
        
        if user_key in users_data:
            self.show_error("âŒ Account already exists! Please login instead.")
            return
        
        users_data[user_key] = {
            'username': username,
            'password': password,
            'strategy': strategy,
            'join_date': datetime.now().strftime('%Y-%m-%d %H:%M'),
            'predictions_count': 0,
            'total_matches_predicted': 0,
            'correct_predictions': 0
        }
        
        self.save_users_data(users_data)
        self.on_login_success(users_data[user_key])
        self.show_success(f"ğŸ‰ Welcome {username}! Account created successfully.")
    
    def login_account(self, instance):
        username = self.username_input.text.strip()
        password = self.password_input.text.strip()
        
        if not username or not password:
            self.show_error("âŒ Please enter username and password!")
            return
        
        users_data = self.load_users_data()
        user_key = f"{username}_{password}"
        
        if user_key not in users_data:
            self.show_error("âŒ Invalid username or password!")
            return
        
        self.on_login_success(users_data[user_key])
        self.show_success(f"ğŸ‘‹ Welcome back {username}!")
    
    def load_users_data(self):
        try:
            if os.path.exists("users_data.json"):
                with open("users_data.json", 'r') as f:
                    return json.load(f)
            return {}
        except:
            return {}
    
    def save_users_data(self, users_data):
        try:
            with open("users_data.json", 'w') as f:
                json.dump(users_data, f, indent=4)
        except:
            pass
    
    def show_error(self, message):
        popup = Popup(
            title='Error',
            content=ModernLabel(text=message),
            size_hint=(0.7, 0.3),
            background_color=(0.8, 0.2, 0.2, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 3)
    
    def show_success(self, message):
        popup = Popup(
            title='Success',
            content=ModernLabel(text=message),
            size_hint=(0.7, 0.3),
            background_color=(0.2, 0.6, 0.2, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 2)

class DetailedPredictionModal(ModalView):
    def __init__(self, match, current_user, on_prediction_submit, **kwargs):
        super().__init__(**kwargs)
        self.match = match
        self.current_user = current_user
        self.on_prediction_submit = on_prediction_submit
        self.size_hint = (0.9, 0.8)
        self.background_color = (0.1, 0.15, 0.25, 0.95)
        self.create_ui()
    
    def create_ui(self):
        layout = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(15))
        
        title = ModernLabel(
            text=f"ğŸ¯ Detailed Prediction: {self.match['team1']} vs {self.match['team2']}",
            font_size=dp(18),
            bold=True,
            halign='center'
        )
        layout.add_widget(title)
        
        user_info = ModernLabel(
            text=f"ğŸ‘¤ Predictor: {self.current_user['username']}",
            font_size=dp(14),
            color=(0.8, 0.9, 1, 1)
        )
        layout.add_widget(user_info)
        
        score_layout = BoxLayout(size_hint=(1, 0.15), spacing=dp(20))
        score_layout.add_widget(ModernLabel(text="Final Score:", font_size=dp(16)))
        
        self.team1_score = TextInput(
            text='0', multiline=False, input_filter='int',
            font_size=dp(18), halign='center', size_hint=(0.2, 1),
            background_color=(0.2, 0.25, 0.35, 1), foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)]
        )
        score_layout.add_widget(self.team1_score)
        
        score_layout.add_widget(ModernLabel(text=":", font_size=dp(20)))
        
        self.team2_score = TextInput(
            text='0', multiline=False, input_filter='int',
            font_size=dp(18), halign='center', size_hint=(0.2, 1),
            background_color=(0.2, 0.25, 0.35, 1), foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)]
        )
        score_layout.add_widget(self.team2_score)
        
        score_layout.add_widget(ModernLabel(text="", size_hint=(0.4, 1)))
        layout.add_widget(score_layout)
        
        winner_layout = BoxLayout(size_hint=(1, 0.1), spacing=dp(10))
        winner_layout.add_widget(ModernLabel(text="ğŸ† Winner:", font_size=dp(14)))
        
        self.winner_input = TextInput(
            text=self.match['team1'], multiline=False,
            font_size=dp(14), size_hint=(0.6, 1),
            background_color=(0.2, 0.25, 0.35, 1), foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)]
        )
        winner_layout.add_widget(self.winner_input)
        layout.add_widget(winner_layout)
        
        scorers_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.3))
        scorers_layout.add_widget(ModernLabel(text="âš½ Goal Scorers:", font_size=dp(14)))
        
        self.scorers_input = TextInput(
            multiline=True,
            font_size=dp(13),
            size_hint=(1, 0.8),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)],
            hint_text="List goal scorers and their teams..."
        )
        scorers_layout.add_widget(self.scorers_input)
        layout.add_widget(scorers_layout)
        
        analysis_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.3))
        analysis_layout.add_widget(ModernLabel(text="ğŸ“Š Match Analysis:", font_size=dp(14)))
        
        self.analysis_input = TextInput(
            multiline=True,
            font_size=dp(13),
            size_hint=(1, 0.8),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            padding=[dp(10), dp(10)],
            hint_text="Your analysis and reasoning..."
        )
        analysis_layout.add_widget(self.analysis_input)
        layout.add_widget(analysis_layout)
        
        buttons_layout = BoxLayout(size_hint=(1, 0.15), spacing=dp(10))
        
        cancel_btn = ModernButton(text='âŒ Cancel', on_press=self.dismiss)
        submit_btn = ModernButton(text='âœ… Submit Prediction', on_press=self.submit_prediction)
        
        buttons_layout.add_widget(cancel_btn)
        buttons_layout.add_widget(submit_btn)
        layout.add_widget(buttons_layout)
        
        self.add_widget(layout)
    
    def submit_prediction(self, instance):
        try:
            prediction_data = {
                'score': f"{self.team1_score.text}-{self.team2_score.text}",
                'winner': self.winner_input.text,
                'scorers': self.scorers_input.text,
                'analysis': self.analysis_input.text,
                'username': self.current_user['username'],
                'strategy': self.current_user['strategy'],
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M')
            }
            self.on_prediction_submit(self.match, prediction_data)
            self.dismiss()
        except ValueError:
            self.show_error("âŒ Please check your inputs!")

class ChampionsLeagueApp(App):
    def build(self):
        self.title = "UEFA Champions League ğŸ†"
        self.data_manager = DataManager()
        self.user_predictions = {}
        self.liked_posts = set()
        self.current_user = None
        
        self.main_layout = BoxLayout(orientation='vertical', spacing=dp(5))
        
        self.create_header()
        self.create_stats_bar()
        self.create_tabs()
        
        Clock.schedule_once(lambda dt: self.load_data(), 1)
        
        return self.main_layout
    
    def create_header(self):
        header = BoxLayout(size_hint=(1, 0.1), padding=dp(10))
        with header.canvas.before:
            Color(0.1, 0.15, 0.25, 1)
            Rectangle(pos=header.pos, size=header.size)
            Color(0, 0.4, 0.8, 0.3)
            Rectangle(pos=(header.pos[0], header.pos[1] + header.height * 0.5), 
                     size=(header.width, header.height * 0.5))
        
        title_layout = BoxLayout(orientation='horizontal', size_hint=(0.4, 1))
        title_layout.add_widget(Label(text='ğŸ†', font_size=dp(28)))
        title_layout.add_widget(Label(text='UEFA Champions League', font_size=dp(20), bold=True))
        
        self.user_btn = ModernButton(
            text='ğŸ‘¤ Login' if not self.current_user else f'ğŸ‘¤ {self.current_user["username"]}',
            size_hint=(0.25, 1),
            on_press=self.show_user_profile
        )
        
        refresh_btn = ModernButton(
            text='ğŸ”„ Refresh',
            size_hint=(0.2, 1),
            on_press=self.refresh_data
        )
        
        header.add_widget(title_layout)
        header.add_widget(self.user_btn)
        header.add_widget(refresh_btn)
        
        self.main_layout.add_widget(header)
    
    def create_stats_bar(self):
        stats_layout = BoxLayout(size_hint=(1, 0.08), spacing=dp(8), padding=dp(10))
        
        stats_data = [
            ('ğŸ‘¥', '16', 'Teams'),
            ('ğŸ“Š', '45', 'Matches'),
            ('ğŸ¯', '128', 'Goals'),
            ('ğŸ¤”', str(len(self.user_predictions)), 'Predictions')
        ]
        
        for emoji, value, label in stats_data:
            stat_box = BoxLayout(orientation='vertical')
            with stat_box.canvas.before:
                Color(0.12, 0.18, 0.28, 1)
                RoundedRectangle(pos=stat_box.pos, size=stat_box.size, radius=[dp(10),])
            
            stat_box.add_widget(Label(text=emoji, font_size=dp(20)))
            stat_box.add_widget(Label(text=value, font_size=dp(16), bold=True, color=(1, 1, 1, 1)))
            stat_box.add_widget(Label(text=label, font_size=dp(10), color=(0.7, 0.7, 0.8, 1)))
            stats_layout.add_widget(stat_box)
        
        self.main_layout.add_widget(stats_layout)
    
    def create_tabs(self):
        self.tabs = TabbedPanel(
            size_hint=(1, 0.82),
            tab_pos='top_mid',
            do_default_tab=False,
            background_color=(0.08, 0.12, 0.2, 1),
            border=[0, 0, 0, 0]
        )
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
        matches_tab = TabbedPanelItem(text='âš½ Matches')
        matches_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.matches_content = ScrollView()
        self.matches_layout = GridLayout(cols=1, spacing=dp(10), size_hint_y=None, padding=dp(10))
        self.matches_layout.bind(minimum_height=self.matches_layout.setter('height'))
        self.matches_content.add_widget(self.matches_layout)
        matches_tab.add_widget(self.matches_content)
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„)
        predictions_tab = TabbedPanelItem(text='ğŸ¤” Predictions')
        predictions_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.predictions_content = ScrollView()
        self.predictions_layout = GridLayout(cols=1, spacing=dp(10), size_hint_y=None, padding=dp(10))
        self.predictions_layout.bind(minimum_height=self.predictions_layout.setter('height'))
        self.predictions_content.add_widget(self.predictions_layout)
        predictions_tab.add_widget(self.predictions_content)
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±ØªÙŠØ¨
        standings_tab = TabbedPanelItem(text='ğŸ“Š Standings')
        standings_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.standings_content = ScrollView()
        self.standings_layout = GridLayout(cols=1, spacing=dp(3), size_hint_y=None, padding=dp(10))
        self.standings_layout.bind(minimum_height=self.standings_layout.setter('height'))
        self.standings_content.add_widget(self.standings_layout)
        standings_tab.add_widget(self.standings_content)
        
        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
        news_tab = TabbedPanelItem(text='ğŸ“° News')
        news_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.news_content = ScrollView()
        self.news_layout = GridLayout(cols=1, spacing=dp(12), size_hint_y=None, padding=dp(10))
        self.news_layout.bind(minimum_height=self.news_layout.setter('height'))
        self.news_content.add_widget(self.news_layout)
        news_tab.add_widget(self.news_content)
        
        self.tabs.add_widget(matches_tab)
        self.tabs.add_widget(predictions_tab)
        self.tabs.add_widget(standings_tab)
        self.tabs.add_widget(news_tab)
        
        self.main_layout.add_widget(self.tabs)
    
    def update_predictions_tab(self):
        self.predictions_layout.clear_widgets()
        
        if not self.current_user:
            # Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹
            login_section = LoginSection(self.on_login_success)
            self.predictions_layout.add_widget(login_section)
        else:
            # Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹
            if not self.user_predictions:
                empty_label = ModernLabel(
                    text="ğŸ¤” No predictions yet!\nğŸ¯ Go to Matches tab to predict upcoming matches.",
                    font_size=dp(16),
                    halign='center'
                )
                self.predictions_layout.add_widget(empty_label)
            else:
                for pred_id, prediction_data in self.user_predictions.items():
                    self.predictions_layout.add_widget(self.create_detailed_prediction_card(prediction_data))
    
    def on_login_success(self, user_data):
        self.current_user = user_data
        self.user_btn.text = f'ğŸ‘¤ {user_data["username"]}'
        self.update_predictions_tab()
    
    def show_user_profile(self, instance):
        if not self.current_user:
            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ø§Ù†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª
            self.tabs.switch_to(self.tabs.tab_list[1])  # Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª
            return
        
        content = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(10))
        
        content.add_widget(IconLabel('ğŸ‘¤', self.current_user['username'], font_size=dp(18)))
        content.add_widget(IconLabel('ğŸ¯', f"Strategy: {self.current_user['strategy']}", font_size=dp(14)))
        content.add_widget(IconLabel('ğŸ“…', f"Member since: {self.current_user['join_date']}", font_size=dp(12)))
        content.add_widget(IconLabel('ğŸ“Š', f"Predictions made: {self.current_user.get('predictions_count', 0)}", font_size=dp(12)))
        
        logout_btn = ModernButton(
            text='ğŸšª Logout',
            on_press=self.logout
        )
        content.add_widget(logout_btn)
        
        popup = Popup(
            title='User Profile',
            content=content,
            size_hint=(0.7, 0.5),
            background_color=(0.1, 0.15, 0.25, 1)
        )
        popup.open()
    
    def logout(self, instance):
        self.current_user = None
        self.user_btn.text = 'ğŸ‘¤ Login'
        for popup in [p for p in Popup._active_popups if hasattr(p, '_instance')]:
            popup.dismiss()
        self.update_predictions_tab()
        self.show_success_message("ğŸ‘‹ Logged out successfully!")
    
    def show_success_message(self, message):
        popup = Popup(
            title='Success',
            content=ModernLabel(text=message),
            size_hint=(0.6, 0.3),
            background_color=(0.2, 0.6, 0.2, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 2)
    
    def create_match_card(self, match):
        card = CardLayout(height=dp(160))
        
        header = BoxLayout(orientation='horizontal', size_hint=(1, 0.2))
        header.add_widget(Label(text='ğŸ†', font_size=dp(16)))
        header.add_widget(Label(text=match['stage'], font_size=dp(12), color=(0.8, 0.8, 0.8, 1)))
        header.add_widget(Label(text=f"ğŸ• {match['date']}", font_size=dp(12), color=(0.8, 0.8, 0.8, 1)))
        
        match_info = BoxLayout(size_hint=(1, 0.5))
        
        team1_layout = BoxLayout(orientation='vertical', size_hint=(0.4, 1))
        team1_layout.add_widget(Label(text=self.get_team_emoji(match['team1']), font_size=dp(28)))
        team1_layout.add_widget(Label(text=match['team1'], font_size=dp(12), halign='center'))
        
        score_layout = BoxLayout(orientation='vertical', size_hint=(0.2, 1))
        if match.get('status') == 'upcoming':
            score = Label(text="VS", font_size=dp(20), color=(0.8, 0.8, 0.8, 1))
            status = Label(text="â° UPCOMING", font_size=dp(10), color=(0.6, 0.8, 1, 1))
        else:
            score = Label(text=match['score'], font_size=dp(22), bold=True, color=(1, 0.8, 0.2, 1))
            status = Label(text="ğŸ”´ LIVE", font_size=dp(10), color=(1, 0.3, 0.3, 1))
        score_layout.add_widget(score)
        score_layout.add_widget(status)
        
        team2_layout = BoxLayout(orientation='vertical', size_hint=(0.4, 1))
        team2_layout.add_widget(Label(text=self.get_team_emoji(match['team2']), font_size=dp(28)))
        team2_layout.add_widget(Label(text=match['team2'], font_size=dp(12), halign='center'))
        
        match_info.add_widget(team1_layout)
        match_info.add_widget(score_layout)
        match_info.add_widget(team2_layout)
        
        actions = BoxLayout(size_hint=(1, 0.3), spacing=dp(5))
        if match.get('status') == 'upcoming':
            predict_btn = ModernButton(
                text='ğŸ¯ Predict This Match',
                size_hint=(0.8, 1),
                on_press=lambda x, m=match: self.show_detailed_prediction_modal(m)
            )
            actions.add_widget(predict_btn)
        
        card.add_widget(header)
        card.add_widget(match_info)
        if match.get('status') == 'upcoming':
            card.add_widget(actions)
        
        return card
    
    def show_detailed_prediction_modal(self, match):
        if not self.current_user:
            self.show_login_required_message()
            return
        
        modal = DetailedPredictionModal(match, self.current_user, self.on_detailed_prediction_submit)
        modal.open()
    
    def show_login_required_message(self):
        # Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        self.tabs.switch_to(self.tabs.tab_list[1])
        self.show_error_message("ğŸ” Please create an account or login first!")
    
    def show_error_message(self, message):
        popup = Popup(
            title='Login Required',
            content=ModernLabel(text=message),
            size_hint=(0.6, 0.3),
            background_color=(0.8, 0.6, 0.2, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 3)
    
    def on_detailed_prediction_submit(self, match, prediction_data):
        match_id = f"{match['team1']}_{match['team2']}_{match['date']}"
        self.user_predictions[match_id] = {
            'match': match,
            'prediction': prediction_data
        }
        
        # ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        self.update_user_stats()
        self.update_predictions_tab()
        self.show_success_message("âœ… Prediction submitted successfully!")
    
    def update_user_stats(self):
        if self.current_user:
            users_data = self.load_users_data()
            user_key = f"{self.current_user['username']}_{self.current_user['password']}"
            if user_key in users_data:
                users_data[user_key]['predictions_count'] = len(self.user_predictions)
                self.save_users_data(users_data)
    
    def load_users_data(self):
        try:
            if os.path.exists("users_data.json"):
                with open("users_data.json", 'r') as f:
                    return json.load(f)
            return {}
        except:
            return {}
    
    def save_users_data(self, users_data):
        try:
            with open("users_data.json", 'w') as f:
                json.dump(users_data, f, indent=4)
        except:
            pass
    
    def create_detailed_prediction_card(self, prediction_data):
        card = CardLayout(height=dp(220))
        match = prediction_data['match']
        pred = prediction_data['prediction']
        
        title_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.15))
        title_layout.add_widget(Label(text='ğŸ¯', font_size=dp(18)))
        title_layout.add_widget(Label(text=f"Prediction by {pred['username']}", font_size=dp(14), bold=True))
        
        match_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.2))
        match_layout.add_widget(Label(text=self.get_team_emoji(match['team1']), font_size=dp(20)))
        match_layout.add_widget(Label(text=f"{match['team1']} vs {match['team2']}", font_size=dp(13)))
        match_layout.add_widget(Label(text=self.get_team_emoji(match['team2']), font_size=dp(20)))
        
        score_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.15))
        score_layout.add_widget(Label(text='ğŸ“Š', font_size=dp(16)))
        score_layout.add_widget(Label(text=f"Predicted Score: {pred['score']}", font_size=dp(14), bold=True, color=(1, 0.8, 0.2, 1)))
        
        details = BoxLayout(orientation='vertical', size_hint=(1, 0.4))
        details.add_widget(IconLabel('ğŸ†', f"Winner: {pred['winner']}", font_size=dp(12)))
        details.add_widget(IconLabel('âš½', f"Scorers: {pred['scorers']}", font_size=dp(11)))
        details.add_widget(IconLabel('ğŸ“Š', f"Analysis: {pred['analysis']}", font_size=dp(11)))
        
        footer = BoxLayout(size_hint=(1, 0.1))
        footer.add_widget(IconLabel('ğŸ•', pred['timestamp'], font_size=dp(10)))
        footer.add_widget(IconLabel('ğŸ¯', f"Strategy: {pred['strategy'][:15]}...", font_size=dp(10)))
        
        card.add_widget(title_layout)
        card.add_widget(match_layout)
        card.add_widget(score_layout)
        card.add_widget(details)
        card.add_widget(footer)
        
        return card
    
    def get_team_emoji(self, team_name):
        emoji_map = {
            'Real Madrid': 'ğŸ‘‘', 'Man City': 'ğŸŒƒ', 'Bayern Munich': 'ğŸ”´',
            'Arsenal': 'ğŸ”«', 'Barcelona': 'ğŸ”µ', 'PSG': 'â­',
            'Liverpool': 'ğŸ”´', 'Chelsea': 'ğŸ”µ', 'Dortmund': 'ğŸŸ¡', 
            'Atletico Madrid': 'ğŸ”´'
        }
        return emoji_map.get(team_name, 'âš½')
    
    def load_data(self):
        threading.Thread(target=self._load_data_thread, daemon=True).start()
    
    def _load_data_thread(self):
        try:
            matches_data = self.data_manager.get_live_matches()
            standings_data = self.data_manager.get_standings()
            news_data = self.data_manager.get_news()
            
            Clock.schedule_once(lambda dt: self.update_ui(
                matches_data, standings_data, news_data
            ), 0)
            
        except Exception as e:
            Clock.schedule_once(lambda dt: self.show_error(str(e)), 0)
    
    def update_ui(self, matches, standings, news):
        self.matches_layout.clear_widgets()
        for match in matches:
            self.matches_layout.add_widget(self.create_match_card(match))
        
        self.update_predictions_tab()
        
        self.standings_layout.clear_widgets()
        self.standings_layout.add_widget(self.create_standings_header())
        for team in standings:
            self.standings_layout.add_widget(self.create_team_row(team, team['rank']))
        
        self.news_layout.clear_widgets()
        for news_item in news:
            self.news_layout.add_widget(self.create_news_card(news_item))
    
    def create_standings_header(self):
        header = BoxLayout(size_hint_y=None, height=dp(40), padding=dp(5))
        with header.canvas.before:
            Color(0, 0.4, 0.8, 1)
            Rectangle(pos=header.pos, size=header.size)
        
        headers = ['ğŸ…', 'Team', 'P', 'W', 'D', 'L', 'Pts']
        for text in headers:
            header.add_widget(Label(text=text, font_size=dp(12), bold=True, color=(1, 1, 1, 1), halign='center'))
        
        return header
    
    def create_team_row(self, team, rank):
        row = BoxLayout(size_hint_y=None, height=dp(35), padding=dp(5))
        bg_color = (0.12, 0.18, 0.28, 1) if rank % 2 == 0 else (0.15, 0.22, 0.35, 1)
        with row.canvas.before:
            Color(*bg_color)
            Rectangle(pos=row.pos, size=row.size)
        
        rank_emoji = 'ğŸ¥‡' if rank == 1 else 'ğŸ¥ˆ' if rank == 2 else 'ğŸ¥‰' if rank == 3 else f'{rank}'
        
        data = [
            rank_emoji,
            f"{self.get_team_emoji(team['name'])} {team['name']}",
            str(team['played']),
            str(team['won']),
            str(team['drawn']),
            str(team['lost']),
            str(team['points'])
        ]
        
        for i, text in enumerate(data):
            color = (1, 0.8, 0.2, 1) if i == 6 else (1, 1, 1, 1)
            bold = i in [0, 6]
            row.add_widget(Label(text=text, font_size=dp(11), bold=bold, color=color, halign='center'))
        
        return row
    
    def create_news_card(self, news_item):
        card = CardLayout(height=dp(170))
        
        title_layout = BoxLayout(orientation='horizontal', size_hint=(1, 0.3))
        title_layout.add_widget(Label(text='ğŸ“¢', font_size=dp(20)))
        title_layout.add_widget(Label(text=news_item['title'], font_size=dp(14), bold=True, halign='left'))
        
        content = Label(
            text=news_item['content'],
            font_size=dp(11),
            size_hint_y=0.4,
            color=(0.8, 0.9, 1, 1),
            halign='left',
            valign='top'
        )
        content.bind(size=content.setter('text_size'))
        
        interactions = BoxLayout(size_hint=(1, 0.3))
        
        likes_layout = BoxLayout(orientation='horizontal', size_hint=(0.25, 1))
        likes_layout.add_widget(Label(text='ğŸ‘', font_size=dp(14)))
        likes_layout.add_widget(Label(text=news_item['likes'], font_size=dp(12)))
        
        comments_layout = BoxLayout(orientation='horizontal', size_hint=(0.25, 1))
        comments_layout.add_widget(Label(text='ğŸ’¬', font_size=dp(14)))
        comments_layout.add_widget(Label(text=news_item['comments'], font_size=dp(12)))
        
        shares_layout = BoxLayout(orientation='horizontal', size_hint=(0.25, 1))
        shares_layout.add_widget(Label(text='ğŸ”„', font_size=dp(14)))
        shares_layout.add_widget(Label(text=news_item['shares'], font_size=dp(12)))
        
        date_layout = BoxLayout(orientation='horizontal', size_hint=(0.25, 1))
        date_layout.add_widget(Label(text='ğŸ“…', font_size=dp(14)))
        date_layout.add_widget(Label(text=news_item['date'], font_size=dp(10), color=(0.7, 0.7, 0.8, 1)))
        
        interactions.add_widget(likes_layout)
        interactions.add_widget(comments_layout)
        interactions.add_widget(shares_layout)
        interactions.add_widget(date_layout)
        
        card.add_widget(title_layout)
        card.add_widget(content)
        card.add_widget(interactions)
        
        return card
    
    def refresh_data(self, instance):
        self.load_data()
        self.show_success_message("ğŸ”„ Data refreshed!")
    
    def show_error(self, error_msg):
        print(f"Error: {error_msg}")

class DataManager:
    def get_live_matches(self):
        return [
            {
                'team1': 'Real Madrid', 'team2': 'Man City', 'score': '3-2',
                'date': 'Today 21:00', 'stage': 'Quarter Final', 'status': 'live'
            },
            {
                'team1': 'Bayern Munich', 'team2': 'Arsenal', 'score': '0-0',
                'date': 'Tomorrow 20:00', 'stage': 'Quarter Final', 'status': 'upcoming'
            },
            {
                'team1': 'Barcelona', 'team2': 'PSG', 'score': '0-0',
                'date': 'Apr 14, 21:00', 'stage': 'Quarter Final', 'status': 'upcoming'
            }
        ]
    
    def get_standings(self):
        return [
            {'rank': 1, 'name': 'Real Madrid', 'played': 6, 'won': 5, 'drawn': 1, 'lost': 0, 'points': 16},
            {'rank': 2, 'name': 'Man City', 'played': 6, 'won': 4, 'drawn': 2, 'lost': 0, 'points': 14},
            {'rank': 3, 'name': 'Bayern Munich', 'played': 6, 'won': 4, 'drawn': 1, 'lost': 1, 'points': 13},
        ]
    
    def get_news(self):
        return [
            {
                'title': 'New Injury Shakes Real Madrid',
                'content': 'Brazilian star out for 3 weeks before crucial Man City clash.',
                'likes': '1.2K', 'comments': '245', 'shares': '89', 'date': '2 hours ago'
            }
        ]

if __name__ == '__main__':
    ChampionsLeagueApp().run()
