# main.py - UCL Predictor 2025 | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© (Ø´ØºØ§Ù„ 100% Ù…Ù† Ø£ÙˆÙ„ Ù…Ø±Ø©)
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button
from kivy.uix.textinput import TextInput
from kivy.uix.scrollview import ScrollView
from kivy.uix.gridlayout import GridLayout
from kivy.uix.image import AsyncImage
from kivy.uix.popup import Popup
from kivy.uix.tabbedpanel import TabbedPanel, TabbedPanelItem
from kivy.clock import Clock
from kivy.animation import Animation
from kivy.graphics import Color, RoundedRectangle, Line
from kivy.core.window import Window
from kivy.metrics import dp, sp
import json
import os
from datetime import datetime

Window.clearcolor = (0.04, 0.06, 0.12, 1)
Window.size = (420, 850)

DATA_FILE = "ucl2025.json"

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
matches = [
    {"id": "1", "team1": "Arsenal", "team2": "Slavia Praha", "date": "25 Ù†ÙˆÙÙ…Ø¨Ø± 21:00", "score": "?:?", "live": True},
    {"id": "2", "team1": "Liverpool", "team2": "Real Madrid", "date": "26 Ù†ÙˆÙÙ…Ø¨Ø± 20:45", "score": "?:?", "live": True},
    {"id": "3", "team1": "Paris SG", "team2": "Bayern Munich", "date": "25 Ù†ÙˆÙÙ…Ø¨Ø± 21:00", "score": "0-1", "live": False},
]

team_logos = {
    "Arsenal": "https://resources.premierleague.com/premierleague/badges/70/t3.png",
    "Liverpool": "https://resources.premierleague.com/premierleague/badges/70/t14.png",
    "Real Madrid": "https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg",
    "Paris SG": "https://upload.wikimedia.org/wikipedia/en/a/a7/Paris_Saint-Germain_F.C..svg",
    "Bayern Munich": "https://upload.wikimedia.org/wikipedia/commons/1/1f/FC_Bayern_M%C3%BCnchen_logo_%282017%29.svg",
    "Slavia Praha": "https://upload.wikimedia.org/wikipedia/en/9/9c/Slavia_Prague_logo.png",
}

def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {"users": {}, "predictions": {}, "chat": [], "points": {}}

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)

data = load_data()

class UCLApp(App):
    def build(self):
        self.title = "UCL Predictor 2025"
        self.username = None

        # Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        tabs = TabbedPanel(do_default_tab=False)
        tabs.background_color = (0.08, 0.1, 0.15, 1)

        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª
        matches_tab = TabbedPanelItem(text="Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª")
        self.matches_grid = GridLayout(cols=1, spacing=dp(20), size_hint_y=None, padding=dp(20))
        self.matches_grid.bind(minimum_height=self.matches_grid.setter('height'))
        scroll1 = ScrollView()
        scroll1.add_widget(self.matches_grid)
        matches_tab.add_widget(scroll1)

        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª
        preds_tab = TabbedPanelItem(text="Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª")
        self.preds_grid = GridLayout(cols=1, spacing=dp(15), size_hint_y=None, padding=dp(20))
        self.preds_grid.bind(minimum_height=self.preds_grid.setter('height'))
        scroll2 = ScrollView()
        scroll2.add_widget(self.preds_grid)
        preds_tab.add_widget(scroll2)

        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø´Ø§Øª
        chat_tab = TabbedPanelItem(text="Ø§Ù„Ø´Ø§Øª")
        chat_box = BoxLayout(orientation='vertical')
        self.chat_grid = GridLayout(cols=1, spacing=dp(10), size_hint_y=None, padding=dp(10))
        self.chat_grid.bind(minimum_height=self.chat_grid.setter('height'))
        chat_scroll = ScrollView()
        chat_scroll.add_widget(self.chat_grid)
        msg_input = TextInput(hint_text="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...", size_hint_y=None, height=dp(50))
        send_btn = Button(text="Ø¥Ø±Ø³Ø§Ù„", size_hint_x=0.25, background_color=(0, 0.7, 1, 1))
        send_btn.bind(on_press=lambda x: self.send_chat(msg_input.text, msg_input))
        bottom = BoxLayout(size_hint_y=None, height=dp(60))
        bottom.add_widget(msg_input)
        bottom.add_widget(send_btn)
        chat_box.add_widget(chat_scroll)
        chat_box.add_widget(bottom)
        chat_tab.add_widget(chat_box)

        # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±ØªÙŠØ¨
        rank_tab = TabbedPanelItem(text="Ø§Ù„ØªØ±ØªÙŠØ¨")
        self.rank_grid = GridLayout(cols=1, spacing=dp(10), size_hint_y=None, padding=dp(20))
        self.rank_grid.bind(minimum_height=self.rank_grid.setter('height'))
        rank_scroll = ScrollView()
        rank_scroll.add_widget(self.rank_grid)
        rank_tab.add_widget(rank_scroll)

        tabs.add_widget(matches_tab)
        tabs.add_widget(preds_tab)
        tabs.add_widget(chat_tab)
        tabs.add_widget(rank_tab)

        # ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
        Clock.schedule_interval(self.refresh_all, 15)

        self.refresh_all()
        Clock.schedule_once(self.ask_login, 1)

        return tabs

    def ask_login(self, dt):
        if not self.username:
            popup = Popup(title="Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ ÙˆØ­Ø´!", size_hint=(0.8, 0.5), auto_dismiss=False)
            layout = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(20))
            name_input = TextInput(hint_text="Ø§Ø³Ù…Ùƒ ÙŠØ§ Ù…Ù„Ùƒ", text="Ù„Ø§Ø¹Ø¨ 1", size_hint_y=None, height=dp(50))
            login_btn = Button(text="Ø¯Ø®ÙˆÙ„", background_color=(0, 0.7, 1, 1), size_hint_y=None, height=dp(60))
            login_btn.bind(on_press=lambda x: self.do_login(name_input.text, popup))
            layout.add_widget(Label(text="Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø¹Ø´Ø§Ù† ØªØ¨Ø¯Ø£ ØªÙ„Ø¹Ø¨", color=(1,1,1,1)))
            layout.add_widget(name_input)
            layout.add_widget(login_btn)
            popup.content = layout
            popup.open()

    def do_login(self, name, popup):
        if name.strip():
            self.username = name.strip()
            popup.dismiss()
            self.root.current_tab.text = f"Ø§Ù‡Ù„Ø§Ù‹ {self.username}"

    def refresh_all(self, dt=None):
        self.show_matches()
        self.show_predictions()
        self.show_chat()
        self.show_ranking()

    def show_matches(self):
        self.matches_grid.clear_widgets()
        for match in matches:
            card = BoxLayout(orientation='vertical', size_hint_y=None, height=dp(240), padding=dp(15))
            with card.canvas.before:
                Color(0.08, 0.12, 0.2, 1)
                RoundedRectangle(pos=card.pos, size=card.size, radius=[18])
                Color(0.9, 0.2, 0.2, 1)
                Line(points=[card.x+30, card.y+card.height-10, card.x+card.width-30, card.y+card.height-10], width=5)

            # Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ†
            top = BoxLayout(spacing=dp(20))
            left = BoxLayout(orientation='vertical')
            left.add_widget(AsyncImage(source=team_logos.get(match["team1"], "")))
            left.add_widget(Label(text=match["team1"], bold=True, color=(1,1,1,1)))

            middle = BoxLayout(orientation='vertical')
            middle.add_widget(Label(text=f"{match['team1']} vs {match['team2']}", bold=True, font_size=sp(20)))
            status = "ğŸ”´ Ù…Ø¨Ø§Ø´Ø±" if match["live"] else "Ø§Ù†ØªÙ‡Øª"
            middle.add_widget(Label(text=f"{status} â€¢ {match['score']}", color=(0,1,0,1) if match["live"] else (1,0.8,0,1)))

            right = BoxLayout(orientation='vertical')
            right.add_widget(AsyncImage(source=team_logos.get(match["team2"], "")))
            right.add_widget(Label(text=match["team2"], bold=True, color=(1,1,1,1)))

            top.add_widget(left)
            top.add_widget(middle)
            top.add_widget(right)

            btn = Button(text="ØªÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†" if match["live"] else "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©", background_color=(0, 0.6, 1, 1) if match["live"] else (0.5, 0.5, 0.5, 1), size_hint_y=None, height=dp(55))
            if match["live"]:
                btn.bind(on_press=lambda x, m=match: self.predict_match(m))

            card.add_widget(top)
            card.add_widget(btn)
            Animation(opacity=0, duration=0).start(card)
            anim = Animation(opacity=1, y=card.y + 50, duration=0.6, t='out_back')
            anim.start(card)

            self.matches_grid.add_widget(card)

    def predict_match(self, match):
        if not self.username:
            Popup(title="Ø®Ø·Ø£", content=Label(text="Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ ÙˆØ­Ø´!")).open()
            return

        popup = Popup(title=f"ØªÙˆÙ‚Ø¹: {match['team1']} vs {match['team2']}", size_hint=(0.9, 0.8))
        layout = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(20))

        score_box = BoxLayout(spacing=dp(30), size_hint_y=None, height=dp(100))
        g1 = TextInput(text="2", font_size=sp(50), input_filter='int', halign='center')
        g2 = TextInput(text="1", font_size=sp(50), input_filter='int', halign='center')
        score_box.add_widget(g1)
        score_box.add_widget(Label(text="-", font_size=sp(60)))
        score_box.add_widget(g2)

        scorers = TextInput(hint_text="Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", size_hint_y=None, height=dp(100))

        def save_pred(btn):
            pred_id = f"{match['id']}_{self.username}"
            data["predictions"][pred_id] = {
                "user": self.username,
                "score": f"{g1.text}-{g2.text}",
                "scorers": scorers.text.strip(),
                "time": datetime.now().strftime("%H:%M")
            }
            save_data(data)
            popup.dismiss()
            Popup(title="ØªÙ…!", content=Label(text="ØªÙˆÙ‚Ø¹Ùƒ Ø§ØªØ­ÙØ¸ ÙŠØ§ Ø£Ø³Ø·ÙˆØ±Ø©!")).open()

        layout.add_widget(score_box)
        layout.add_widget(scorers)
        layout.add_widget(Button(text="Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚Ø¹", background_color=(0.1, 0.8, 0.3, 1), height=dp(60), on_press=save_pred))

        popup.content = layout
        popup.open()

    def show_predictions(self):
        self.preds_grid.clear_widgets()
        for pid, p in data["predictions"].items():
            card = BoxLayout(orientation='vertical', padding=dp(15), spacing=dp(8), size_hint_y=None, height=dp(140))
            with card.canvas.before:
                Color(0.1, 0.15, 0.25, 1)
                RoundedRectangle(pos=card.pos, size=card.size, radius=[12])

            card.add_widget(Label(text=f"[b]{p['user']}[/b]", markup=True, color=(0,0.8,1,1)))
            card.add_widget(Label(text=f"ØªÙˆÙ‚Ø¹: {p['score']}"))
            if p.get("scorers"):
                card.add_widget(Label(text=f"Ù‡Ø¯Ø§ÙÙŠÙ†: {p['scorers']}"))
            card.add_widget(Label(text=p['time'], color=(0.7,0.7,0.7,1), font_size=sp(12)))

            self.preds_grid.add_widget(card)

    def send_chat(self, text, input_widget):
        if text.strip() and self.username:
            data["chat"].append({
                "user": self.username,
                "msg": text.strip(),
                "time": datetime.now().strftime("%H:%M")
            })
            save_data(data)
            input_widget.text = ""
            self.show_chat()

    def show_chat(self):
        self.chat_grid.clear_widgets()
        for msg in data["chat"][-30:]:
            lbl = Label(
                text=f"[b]{msg['user']}[/b]: {msg['msg']}\n[color=888888]{msg['time']}[/color]",
                markup=True,
                text_size=(None, None),
                halign='right',
                size_hint_y=None,
                height=dp(50)
            )
            self.chat_grid.add_widget(lbl)

    def show_ranking(self):
        self.rank_grid.clear_widgets()
        ranking = sorted(data["points"].items(), key=lambda x: x[1], reverse=True)[:15]
        for i, (user, pts) in enumerate(ranking):
            row = BoxLayout(size_hint_y=None, height=dp(60))
            row.add_widget(Label(text=str(i+1), color=(1,0.8,0,1)))
            row.add_widget(Label(text=user, bold=True))
            row.add_widget(Label(text=f"{pts} Ù†Ù‚Ø·Ø©", color=(0,1,0,1)))
            self.rank_grid.add_widget(row)

if __name__ == '__main__':
    UCLApp().run()
