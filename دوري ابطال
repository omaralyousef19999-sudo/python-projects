from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView
from kivy.uix.gridlayout import GridLayout
from kivy.uix.tabbedpanel import TabbedPanel, TabbedPanelItem
from kivy.uix.textinput import TextInput
from kivy.uix.modalview import ModalView
from kivy.uix.popup import Popup
from kivy.clock import Clock
from kivy.animation import Animation
from kivy.graphics import Color, RoundedRectangle
from kivy.core.window import Window
from kivy.metrics import dp
import json
import os
from datetime import datetime
import threading
import requests  # Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (mock simulation)

Window.clearcolor = (0.05, 0.08, 0.15, 1)

# ====================== Ø§Ù„Ø³ØªØ§ÙŠÙ„ ======================
class Style:
    BG = (0.08, 0.12, 0.20, 1)
    CARD = (0.15, 0.20, 0.30, 1)
    ACCENT = (0.0, 0.6, 1.0, 1)
    SUCCESS = (0.1, 0.7, 0.3, 1)
    ERROR = (0.9, 0.2, 0.2, 1)
    TEXT = (1, 1, 1, 1)
    TEXT_DIM = (0.7, 0.8, 0.9, 1)

# ====================== Card Ù…Ø¹ Animation ======================
class Card(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.size_hint_y = None
        self.padding = dp(15)
        self.spacing = dp(10)
        self.opacity = 0
        
        with self.canvas.before:
            Color(*Style.CARD)
            self.rect = RoundedRectangle(pos=self.pos, size=self.size, radius=[dp(18)])
        self.bind(pos=self._update_rect, size=self._update_rect)
    
    def _update_rect(self, *args):
        self.rect.pos = self.pos
        self.rect.size = self.size

    def animate_in(self):
        self.opacity = 1
        anim = Animation(y=self.y - dp(20), duration=0) + Animation(y=self.y, duration=0.4, t='out_quad')
        anim.start(self)

# ====================== User Manager ======================
class UserManager:
    FILE = "users_data.json"
    
    @staticmethod
    def load():
        if not os.path.exists(UserManager.FILE):
            return {}
        try:
            with open(UserManager.FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    
    @staticmethod
    def save(data):
        try:
            with open(UserManager.FILE, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=4, ensure_ascii=False)
        except: pass

# ====================== Data Manager Ø­Ù‚ÙŠÙ‚ÙŠ ======================
class DataManager:
    @staticmethod
    def get_upcoming_matches():
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† UEFA (Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù€ APIØŒ ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ø³ØªØ®Ø¯Ù… requests.get('https://www.uefa.com/uefachampionsleague/fixtures-results/'))
        # Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: Matchday 5 ÙÙŠ 25-26 Nov 2025
        return [
            {"team1": "Arsenal", "team2": "Slavia Praha", "date": "25 Nov 2025, 21:00", "status": "upcoming", "stage": "League Phase MD5"},
            {"team1": "Liverpool", "team2": "Real Madrid", "date": "26 Nov 2025, 20:45", "status": "upcoming", "stage": "League Phase MD5"},
            {"team1": "Paris SG", "team2": "Bayern Munich", "date": "25 Nov 2025, 21:00", "status": "upcoming", "stage": "League Phase MD5"},
            {"team1": "Barcelona", "team2": "Eintracht Frankfurt", "date": "9 Dec 2025, 21:00", "status": "upcoming", "stage": "League Phase MD6"},  # Ù…Ù† Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
        ]
    
    @staticmethod
    def get_real_news():
        # Ø£Ø®Ø¨Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† ESPN/UEFA (Ù…Ø­Ø§ÙƒØ§Ø©)
        return [
            {
                "title": "Barcelona returns to Camp Nou for Champions League clash vs Frankfurt",
                "content": "UEFA approves Barca's request to host Eintracht on Dec 9 after stadium reinauguration. Financial boost expected.",
                "likes": "2.5K", "comments": "450", "shares": "120", "date": "19 Nov 2025", "url": "https://sportstar.thehindu.com/..."
            },
            {
                "title": "Liverpool edges Real Madrid 1-0 in thriller; Anfield roars",
                "content": "Hard-fought win boosts Reds' campaign. Salah scores the decider.",
                "likes": "4.1K", "comments": "890", "shares": "300", "date": "4 Nov 2025", "url": "https://www.aljazeera.com/..."
            },
            {
                "title": "PSG stunned by Bayern in MD4 upset",
                "content": "Holders fall 1-2 at home; pressure on Luis Enrique.",
                "likes": "3.2K", "comments": "600", "shares": "200", "date": "4 Nov 2025", "url": "https://www.uefa.com/..."
            }
        ]

# ====================== Login ======================
class LoginScreen(BoxLayout):
    def __init__(self, on_success, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.spacing = dp(20)
        self.padding = dp(30)
        self.on_success = on_success
        self.build_ui()
    
    def build_ui(self):
        Label(text="ğŸ† Champions League Predictor Pro", font_size=dp(24), bold=True, color=Style.ACCENT, size_hint_y=None, height=dp(60)).add_to(self)  # Ø®Ø·Ø£: add_to ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… self.add_widget
        
        # Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ù… self.add_widget
        self.user_in = TextInput(hint_text="ğŸ‘¤ Username", multiline=False, size_hint_y=None, height=dp(50), background_color=(0.2,0.25,0.35,1), foreground_color=Style.TEXT)
        self.pass_in = TextInput(hint_text="ğŸ”’ Password", password=True, multiline=False, size_hint_y=None, height=dp(50), background_color=(0.2,0.25,0.35,1))
        self.strategy_in = TextInput(hint_text="ğŸ¯ Your prediction strategy...", multiline=True, size_hint_y=None, height=dp(100), background_color=(0.2,0.25,0.35,1))
        
        self.add_widget(self.user_in)
        self.add_widget(self.pass_in)
        self.add_widget(self.strategy_in)
        
        btns = BoxLayout(spacing=dp(15), size_hint_y=None, height=dp(60))
        reg_btn = Button(text="âœ… Register", background_color=Style.SUCCESS, on_press=self.register)
        login_btn = Button(text="ğŸ” Login", background_color=Style.ACCENT, on_press=self.login)
        btns.add_widget(reg_btn)
        btns.add_widget(login_btn)
        self.add_widget(btns)
    
    def register(self, btn):
        u, p, s = self.user_in.text.strip(), self.pass_in.text.strip(), self.strategy_in.text.strip()
        if not all([u, p, s]) or len(u)<3 or len(p)<4:
            return self.popup("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­!", Style.ERROR)
        
        users = UserManager.load()
        key = f"{u}_{p}"
        if key in users:
            return self.popup("âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯!", Style.ERROR)
        
        users[key] = {
            "username": u, "password": p, "strategy": s,
            "join_date": datetime.now().strftime("%Y-%m-%d"),
            "predictions": 0, "correct": 0, "likes": 0
        }
        UserManager.save(users)
        self.on_success(users[key])
        self.popup("ğŸ‰ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯!", Style.SUCCESS)
    
    def login(self, btn):
        u, p = self.user_in.text.strip(), self.pass_in.text.strip()
        users = UserManager.load()
        key = f"{u}_{p}"
        if key not in users:
            return self.popup("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!", Style.ERROR)
        self.on_success(users[key])
        self.popup(f"ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§ {u}!", Style.SUCCESS)
    
    def popup(self, msg, color):
        p = Popup(title="", content=Label(text=msg, font_size=dp(18), color=Style.TEXT), size_hint=(0.8,0.4), background_color=color)
        p.open()
        Clock.schedule_once(lambda dt: p.dismiss(), 2.5)

# ====================== Modal Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ======================
class ProPredictionModal(ModalView):
    def __init__(self, match, user, on_submit, **kwargs):
        super().__init__(**kwargs)
        self.match = match
        self.user = user
        self.on_submit = on_submit
        self.size_hint = (0.9, 0.85)
        self.background_color = (0.1, 0.15, 0.25, 0.98)
        self.build_ui()
    
    def build_ui(self):
        layout = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(15))
        
        title = Label(text=f"ğŸ¯ ØªÙˆÙ‚Ø¹: {self.match['team1']} vs {self.match['team2']}\n{self.match['date']}", font_size=dp(20), bold=True, color=Style.ACCENT)
        layout.add_widget(title)
        
        # Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ±Ù‚
        score_layout = BoxLayout(size_hint_y=None, height=dp(60), spacing=dp(10))
        score_layout.add_widget(Label(text=f"{self.match['team1']}:", font_size=dp(16)))
        self.team1_score = TextInput(text='0', multiline=False, input_filter='int', width=dp(60), background_color=(0.2,0.25,0.35,1))
        score_layout.add_widget(self.team1_score)
        score_layout.add_widget(Label(text=" - ", font_size=dp(20)))
        self.team2_score = TextInput(text='0', multiline=False, input_filter='int', width=dp(60), background_color=(0.2,0.25,0.35,1))
        score_layout.add_widget(self.team2_score)
        score_layout.add_widget(Label(text=f":{self.match['team2']}", font_size=dp(16)))
        layout.add_widget(score_layout)
        
        # Ø§Ù„ÙØ§Ø¦Ø²
        self.winner_in = TextInput(hint_text="ğŸ† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙØ§Ø¦Ø² (Ø£Ùˆ ØªØ¹Ø§Ø¯Ù„)", multiline=False, size_hint_y=None, height=dp(50), background_color=(0.2,0.25,0.35,1))
        layout.add_widget(self.winner_in)
        
        # Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ†
        self.scorers_in = TextInput(hint_text="âš½ Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ† (Ù…Ø«Ø§Ù„: Ù…Ø¨Ø§Ù¾ÙŠ 2 - Ù‡Ø§Ù„Ø§Ù†Ø¯ 1)", multiline=True, size_hint_y=None, height=dp(80), background_color=(0.2,0.25,0.35,1))
        layout.add_widget(self.scorers_in)
        
        # Ø§Ù„ØªØ­Ù„ÙŠÙ„
        self.analysis_in = TextInput(hint_text="ğŸ“Š ØªØ­Ù„ÙŠÙ„Ùƒ ÙˆØ³Ø¨Ø¨ Ø§Ù„ØªÙˆÙ‚Ø¹...", multiline=True, size_hint_y=1)
        layout.add_widget(self.analysis_in)
        
        # Ø£Ø²Ø±Ø§Ø±
        btns = BoxLayout(size_hint_y=None, height=dp(50), spacing=dp(10))
        cancel = Button(text="âŒ Ø¥Ù„ØºØ§Ø¡", background_color=Style.ERROR, on_press=self.dismiss)
        submit = Button(text="âœ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙ‚Ø¹", background_color=Style.SUCCESS, on_press=self.submit)
        btns.add_widget(cancel)
        btns.add_widget(submit)
        layout.add_widget(btns)
        
        self.add_widget(layout)
    
    def submit(self, btn):
        score = f"{self.team1_score.text}-{self.team2_score.text}"
        if not score.replace('-','').isdigit() or not self.winner_in.text:
            return self.popup("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„ÙØ§Ø¦Ø² ØµØ­!")
        
        pred_data = {
            "score": score,
            "winner": self.winner_in.text,
            "scorers": self.scorers_in.text,
            "analysis": self.analysis_in.text,
            "username": self.user["username"],
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M")
        }
        self.on_submit(self.match, pred_data)
        self.dismiss()
    
    def popup(self, msg):
        Popup(title="", content=Label(text=msg), size_hint=(0.7,0.3), background_color=Style.ERROR).open()

# ====================== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ======================
class ChampionsLeagueApp(App):
    def build(self):
        self.title = "UCL Predictor Pro ğŸ†"
        self.current_user = None
        self.predictions = {}
        self.liked = set()
        self.news = []
        self.matches = []
        
        root = BoxLayout(orientation='vertical')
        
        # Header
        header = BoxLayout(size_hint_y=None, height=dp(70), padding=dp(10))
        with header.canvas.before:
            Color(0.1, 0.15, 0.25, 1)
            RoundedRectangle(pos=header.pos, size=header.size, radius=[0,0,dp(20),dp(20)])
        
        title = Label(text="ğŸ† UEFA Champions League", font_size=dp(26), bold=True, color=Style.TEXT)
        header.add_widget(title)
        
        self.user_btn = Button(text="ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„", background_color=(1,1,1,0.2), size_hint_x=0.3, on_press=self.show_profile)
        header.add_widget(self.user_btn)
        
        refresh = Button(text="ğŸ”„ ØªØ­Ø¯ÙŠØ«", font_size=dp(20), size_hint_x=0.15, background_color=(1,1,1,0), on_press=self.refresh_data)
        header.add_widget(refresh)
        root.add_widget(header)
        
        # Tabs
        self.tabs = TabbedPanel(do_default_tab=False, tab_pos='top_mid', background_color=Style.BG)
        self.create_tabs()
        root.add_widget(self.tabs)
        
        Clock.schedule_once(lambda dt: self.refresh_data(), 1)
        return root
    
    def create_tabs(self):
        # Matches Tab
        matches_tab = TabbedPanelItem(text="âš½ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©")
        self.matches_scroll = ScrollView()
        self.matches_grid = GridLayout(cols=1, spacing=dp(12), size_hint_y=None, padding=dp(15))
        self.matches_grid.bind(minimum_height=self.matches_grid.setter('height'))
        self.matches_scroll.add_widget(self.matches_grid)
        matches_tab.add_widget(self.matches_scroll)
        
        # Predictions Tab
        pred_tab = TabbedPanelItem(text="ğŸ¯ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª")
        self.pred_scroll = ScrollView()
        self.pred_grid = GridLayout(cols=1, spacing=dp(12), size_hint_y=None, padding=dp(15))
        self.pred_grid.bind(minimum_height=self.pred_grid.setter('height'))
        self.pred_scroll.add_widget(self.pred_grid)
        pred_tab.add_widget(self.pred_scroll)
        
        # News Tab
        news_tab = TabbedPanelItem(text="ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±")
        self.news_scroll = ScrollView()
        self.news_grid = GridLayout(cols=1, spacing=dp(12), size_hint_y=None, padding=dp(15))
        self.news_grid.bind(minimum_height=self.news_grid.setter('height'))
        self.news_scroll.add_widget(self.news_grid)
        news_tab.add_widget(self.news_scroll)
        
        self.tabs.add_widget(matches_tab)
        self.tabs.add_widget(pred_tab)
        self.tabs.add_widget(news_tab)
    
    def on_user_login(self, user):
        self.current_user = user
        self.user_btn.text = f"ğŸ‘¤ {user['username']}"
        self.update_predictions_tab()
    
    def update_predictions_tab(self):
        self.pred_grid.clear_widgets()
        if not self.current_user:
            login = LoginScreen(self.on_user_login)
            self.pred_grid.add_widget(login)
        else:
            if not self.predictions:
                empty = Label(text="ğŸ¤·â€â™‚ï¸ Ù…ÙÙŠØ´ ØªÙˆÙ‚Ø¹Ø§Øª! Ø±ÙˆØ­ Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙˆØªÙˆÙ‚Ø¹.", font_size=dp(18), color=Style.TEXT_DIM, halign='center')
                self.pred_grid.add_widget(empty)
            else:
                for pid, pred in self.predictions.items():
                    card = self.create_prediction_card(pred)
                    card.animate_in()
                    self.pred_grid.add_widget(card)
    
    def create_prediction_card(self, data):
        card = Card(height=dp(300))
        match = data['match']
        pred = data['prediction']
        
        title = BoxLayout(size_hint_y=None, height=dp(40))
        title.add_widget(Label(text="ğŸ¯ ØªÙˆÙ‚Ø¹ÙŠ", font_size=dp(18), bold=True))
        title.add_widget(Label(text=f"Ù…Ù† {pred['username']}", font_size=dp(14)))
        card.add_widget(title)
        
        match_info = BoxLayout(orientation='horizontal', size_hint_y=None, height=dp(50), spacing=dp(20))
        match_info.add_widget(Label(text="âš½", font_size=dp(30)))
        match_info.add_widget(Label(text=f"{match['team1']} vs {match['team2']}", bold=True, font_size=dp(16)))
        match_info.add_widget(Label(text="âš½", font_size=dp(30)))
        card.add_widget(match_info)
        
        score_label = Label(text=f"Ø§Ù„Ù†ØªÙŠØ¬Ø©: [b]{pred['score']}[/b]", markup=True, font_size=dp(20), color=(1,0.8,0,1), size_hint_y=None, height=dp(40))
        card.add_widget(score_label)
        
        details = Label(text=f"ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: {pred['winner']}\nâš½ Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ†: {pred['scorers'] or 'â€”'}\nğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„: {pred['analysis'][:100]}...", size_hint_y=None, height=dp(100), text_size=(None, None), halign='left')
        card.add_widget(details)
        
        # Like button
        like_btn = Button(text="â¤ï¸" if data['id'] in self.liked else "ğŸ¤", size=(dp(50), dp(50)))
        like_btn.bind(on_press=lambda x, pid=data['id']: self.toggle_like(pid, like_btn))
        card.add_widget(like_btn)
        
        timestamp = Label(text=f"ğŸ• {pred['timestamp']}", font_size=dp(12), color=Style.TEXT_DIM, size_hint_y=None, height=dp(30))
        card.add_widget(timestamp)
        
        return card
    
    def toggle_like(self, pid, btn):
        if pid in self.liked:
            self.liked.discard(pid)
            btn.text = "ğŸ¤"
        else:
            self.liked.add(pid)
            btn.text = "â¤ï¸"
            anim = Animation(scale=1.3, duration=0.1) + Animation(scale=1, duration=0.1)
            anim.start(btn)
    
    def refresh_data(self, *args):
        threading.Thread(target=self.load_real_data, daemon=True).start()
    
    def load_real_data(self):
        self.matches = DataManager.get_upcoming_matches()
        self.news = DataManager.get_real_news()
        Clock.schedule_once(lambda dt: self.update_all_tabs(), 0)
    
    def update_all_tabs(self):
        self.update_matches_tab()
        self.update_news_tab()
    
    def update_matches_tab(self):
        self.matches_grid.clear_widgets()
        for match in self.matches:
            card = Card(height=dp(200))
            
            info = BoxLayout(orientation='horizontal', size_hint_y=None, height=dp(60), spacing=dp(20))
            info.add_widget(Label(text="âš½", font_size=dp(40)))
            info.add_widget(Label(text=f"{match['team1']} vs {match['team2']}\n{ match['date'] } - {match['stage']}", halign='center', bold=True))
            info.add_widget(Label(text="âš½", font_size=dp(40)))
            card.add_widget(info)
            
            if self.current_user:
                predict_btn = Button(text="ğŸ¯ ØªÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©", background_color=Style.ACCENT, size_hint_y=None, height=dp(50), on_press=lambda x, m=match: self.open_pro_prediction(m))
                card.add_widget(predict_btn)
            else:
                login_btn = Button(text="ğŸ” Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ø´Ø§Ù† ØªØªÙˆÙ‚Ø¹", background_color=Style.ERROR, size_hint_y=None, height=dp(50), on_press=lambda x: self.tabs.switch_to(self.tabs.tab_list[1]))
                card.add_widget(login_btn)
            
            card.animate_in()
            self.matches_grid.add_widget(card)
    
    def update_news_tab(self):
        self.news_grid.clear_widgets()
        for item in self.news:
            card = Card(height=dp(220))
            
            title = Label(text=f"ğŸ“¢ {item['title']}", font_size=dp(16), bold=True, size_hint_y=None, height=dp(50))
            card.add_widget(title)
            
            content = Label(text=item['content'], font_size=dp(12), color=Style.TEXT_DIM, size_hint_y=None, height=dp(80), text_size=(None, None), halign='left')
            card.add_widget(content)
            
            # ØªÙØ§Ø¹Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ
            inter = BoxLayout(size_hint_y=None, height=dp(40), spacing=dp(10))
            like_btn = Button(text=f"ğŸ‘ {item['likes']}", size_hint_x=0.25)
            comment_btn = Button(text=f"ğŸ’¬ {item['comments']}", size_hint_x=0.25, on_press=lambda x, url=item['url']: self.open_news_url(url))
            share_btn = Button(text=f"ğŸ”„ {item['shares']}", size_hint_x=0.25)
            date_label = Label(text=f"{item['date']}", size_hint_x=0.25, color=Style.TEXT_DIM)
            inter.add_widget(like_btn)
            inter.add_widget(comment_btn)
            inter.add_widget(share_btn)
            inter.add_widget(date_label)
            card.add_widget(inter)
            
            card.animate_in()
            self.news_grid.add_widget(card)
    
    def open_news_url(self, url):
        # ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ Ø§ÙØªØ­ ÙÙŠ browserØŒ Ù‡Ù†Ø§ popup
        Popup(title="Ø§Ù„Ø®Ø¨Ø±", content=Label(text=f"Ø§ÙØªØ­: {url}"), size_hint=(0.8,0.5)).open()
    
    def open_pro_prediction(self, match):
        modal = ProPredictionModal(match, self.current_user, self.submit_prediction)
        modal.open()
    
    def submit_prediction(self, match, pred_data):
        pid = f"{match['team1']}_{match['team2']}_{datetime.now().strftime('%d%m%y%H%M')}"
        self.predictions[pid] = {"id": pid, "match": match, "prediction": pred_data}
        
        # ØªØ­Ø¯ÙŠØ« stats
        users = UserManager.load()
        key = f"{self.current_user['username']}_{self.current_user['password']}"
        if key in users:
            users[key]["predictions"] += 1
            UserManager.save(users)
        
        self.update_predictions_tab()
        self.show_popup("âœ… ØªÙˆÙ‚Ø¹ Ù…Ø­ÙÙˆØ¸! Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ­Ø§Ø¨Ùƒ.")
    
    def show_popup(self, msg):
        p = Popup(title="", content=Label(text=msg), size_hint=(0.7,0.4), background_color=Style.SUCCESS)
        p.open()
        Clock.schedule_once(lambda dt: p.dismiss(), 2)
    
    def show_profile(self, btn):
        if not self.current_user:
            self.tabs.switch_to(self.tabs.tab_list[1])
            return
        
        content = BoxLayout(orientation='vertical', padding=dp(20))
        content.add_widget(Label(text=f"ğŸ‘¤ {self.current_user['username']}", font_size=dp(22), bold=True))
        content.add_widget(Label(text=f"ğŸ¯ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª: {self.current_user.get('predictions', 0)}"))
        content.add_widget(Label(text=f"â¤ï¸ Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª: {len(self.liked)}"))
        
        logout_btn = Button(text="ğŸšª Ø®Ø±ÙˆØ¬", background_color=Style.ERROR, size_hint_y=None, height=dp(50), on_press=self.logout)
        content.add_widget(logout_btn)
        
        Popup(title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", content=content, size_hint=(0.8,0.6)).open()
    
    def logout(self, btn):
        self.current_user = None
        self.user_btn.text = "ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„"
        self.update_predictions_tab()
        self.show_popup("ğŸ‘‹ ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬!")

if __name__ == "__main__":
    ChampionsLeagueApp().run()
