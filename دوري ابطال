from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView
from kivy.uix.gridlayout import GridLayout
from kivy.uix.tabbedpanel import TabbedPanel, TabbedPanelItem
from kivy.uix.textinput import TextInput
from kivy.uix.modalview import ModalView
from kivy.uix.popup import Popup
from kivy.clock import Clock
from kivy.graphics import Color, Rectangle, RoundedRectangle
from kivy.core.window import Window
from kivy.metrics import dp
import threading
import json
import os
from datetime import datetime

Window.clearcolor = (0.05, 0.08, 0.15, 1)

class ModernLabel(Label):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.color = (1, 1, 1, 1)

class ModernButton(Button):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.background_color = (0, 0, 0, 0)
        self.color = (1, 1, 1, 1)
        self.font_size = dp(14)
        self.bold = True

class CardLayout(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.size_hint_y = None
        self.padding = dp(15)
        self.spacing = dp(8)
        
        with self.canvas.before:
            Color(0.15, 0.2, 0.3, 1)
            self.rect = RoundedRectangle(
                pos=self.pos, 
                size=self.size,
                radius=[dp(15),]
            )
        self.bind(pos=self.update_rect, size=self.update_rect)
    
    def update_rect(self, *args):
        self.rect.pos = self.pos
        self.rect.size = self.size

class LoginModal(ModalView):
    def __init__(self, on_login_success, **kwargs):
        super().__init__(**kwargs)
        self.on_login_success = on_login_success
        self.size_hint = (0.85, 0.7)
        self.background_color = (0.1, 0.15, 0.25, 0.95)
        self.create_ui()
    
    def create_ui(self):
        layout = BoxLayout(orientation='vertical', padding=dp(25), spacing=dp(20))
        
        # ÿßŸÑÿπŸÜŸàÿßŸÜ
        title = ModernLabel(
            text="üîê Create Account / Login",
            font_size=dp(22),
            bold=True,
            halign='center'
        )
        layout.add_widget(title)
        
        # ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        username_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.2))
        username_label = ModernLabel(text="üë§ Username:", font_size=dp(14))
        self.username_input = TextInput(
            multiline=False,
            font_size=dp(16),
            size_hint=(1, 0.7),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1)
        )
        username_layout.add_widget(username_label)
        username_layout.add_widget(self.username_input)
        
        # ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±
        password_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.2))
        password_label = ModernLabel(text="üîí Password:", font_size=dp(14))
        self.password_input = TextInput(
            multiline=False,
            password=True,
            font_size=dp(16),
            size_hint=(1, 0.7),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1)
        )
        password_layout.add_widget(password_label)
        password_layout.add_widget(self.password_input)
        
        # ÿÆÿ∑ÿ∑ ÿßŸÑÿ™ŸàŸÇÿπ
        plan_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.3))
        plan_label = ModernLabel(text="üéØ Prediction Strategy:", font_size=dp(14))
        self.plan_input = TextInput(
            multiline=True,
            font_size=dp(14),
            size_hint=(1, 0.8),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            hint_text="Describe your prediction strategy..."
        )
        plan_layout.add_widget(plan_label)
        plan_layout.add_widget(self.plan_input)
        
        # ÿ£ÿ≤ÿ±ÿßÿ±
        buttons_layout = BoxLayout(size_hint=(1, 0.2), spacing=dp(10))
        
        cancel_btn = ModernButton(
            text='‚ùå Cancel',
            on_press=self.dismiss
        )
        
        login_btn = ModernButton(
            text='‚úÖ Login / Register',
            on_press=self.attempt_login
        )
        
        buttons_layout.add_widget(cancel_btn)
        buttons_layout.add_widget(login_btn)
        
        layout.add_widget(username_layout)
        layout.add_widget(password_layout)
        layout.add_widget(plan_layout)
        layout.add_widget(buttons_layout)
        
        self.add_widget(layout)
    
    def attempt_login(self, instance):
        username = self.username_input.text.strip()
        password = self.password_input.text.strip()
        plan = self.plan_input.text.strip()
        
        if not username or not password:
            self.show_error("Please fill all fields!")
            return
        
        if len(password) < 4:
            self.show_error("Password must be at least 4 characters!")
            return
        
        self.on_login_success(username, password, plan)
        self.dismiss()
    
    def show_error(self, message):
        popup = Popup(
            title='Error',
            content=ModernLabel(text=message),
            size_hint=(0.6, 0.3),
            background_color=(0.8, 0.2, 0.2, 1)
        )
        popup.open()

class DetailedPredictionModal(ModalView):
    def __init__(self, match, current_user, on_prediction_submit, **kwargs):
        super().__init__(**kwargs)
        self.match = match
        self.current_user = current_user
        self.on_prediction_submit = on_prediction_submit
        self.size_hint = (0.9, 0.8)
        self.background_color = (0.1, 0.15, 0.25, 0.95)
        self.create_ui()
    
    def create_ui(self):
        layout = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(15))
        
        # ÿßŸÑÿπŸÜŸàÿßŸÜ
        title = ModernLabel(
            text=f"üéØ Detailed Prediction: {self.match['team1']} vs {self.match['team2']}",
            font_size=dp(18),
            bold=True,
            halign='center'
        )
        layout.add_widget(title)
        
        # ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        user_info = ModernLabel(
            text=f"üë§ Predictor: {self.current_user['username']}",
            font_size=dp(14),
            color=(0.8, 0.9, 1, 1)
        )
        layout.add_widget(user_info)
        
        # ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©
        score_layout = BoxLayout(size_hint=(1, 0.15), spacing=dp(20))
        score_layout.add_widget(ModernLabel(text="Final Score:", font_size=dp(16)))
        
        self.team1_score = TextInput(
            text='0', multiline=False, input_filter='int',
            font_size=dp(18), halign='center', size_hint=(0.2, 1),
            background_color=(0.2, 0.25, 0.35, 1), foreground_color=(1, 1, 1, 1)
        )
        score_layout.add_widget(self.team1_score)
        
        score_layout.add_widget(ModernLabel(text=":", font_size=dp(20)))
        
        self.team2_score = TextInput(
            text='0', multiline=False, input_filter='int',
            font_size=dp(18), halign='center', size_hint=(0.2, 1),
            background_color=(0.2, 0.25, 0.35, 1), foreground_color=(1, 1, 1, 1)
        )
        score_layout.add_widget(self.team2_score)
        
        score_layout.add_widget(ModernLabel(text="", size_hint=(0.4, 1)))
        layout.add_widget(score_layout)
        
        # ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑŸÅÿßÿ¶ÿ≤
        winner_layout = BoxLayout(size_hint=(1, 0.1), spacing=dp(10))
        winner_layout.add_widget(ModernLabel(text="üèÜ Winner:", font_size=dp(14)))
        
        self.winner_input = TextInput(
            text=self.match['team1'], multiline=False,
            font_size=dp(14), size_hint=(0.6, 1),
            background_color=(0.2, 0.25, 0.35, 1), foreground_color=(1, 1, 1, 1)
        )
        winner_layout.add_widget(self.winner_input)
        layout.add_widget(winner_layout)
        
        # ÿßŸÑŸáÿØÿßŸÅŸäŸÜ
        scorers_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.3))
        scorers_layout.add_widget(ModernLabel(text="‚öΩ Goal Scorers:", font_size=dp(14)))
        
        self.scorers_input = TextInput(
            multiline=True,
            font_size=dp(13),
            size_hint=(1, 0.8),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            hint_text="List goal scorers and their teams..."
        )
        scorers_layout.add_widget(self.scorers_input)
        layout.add_widget(scorers_layout)
        
        # ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ
        analysis_layout = BoxLayout(orientation='vertical', spacing=dp(5), size_hint=(1, 0.3))
        analysis_layout.add_widget(ModernLabel(text="üìä Match Analysis:", font_size=dp(14)))
        
        self.analysis_input = TextInput(
            multiline=True,
            font_size=dp(13),
            size_hint=(1, 0.8),
            background_color=(0.2, 0.25, 0.35, 1),
            foreground_color=(1, 1, 1, 1),
            hint_text="Your analysis and reasoning..."
        )
        analysis_layout.add_widget(self.analysis_input)
        layout.add_widget(analysis_layout)
        
        # ÿ£ÿ≤ÿ±ÿßÿ±
        buttons_layout = BoxLayout(size_hint=(1, 0.15), spacing=dp(10))
        
        cancel_btn = ModernButton(text='‚ùå Cancel', on_press=self.dismiss)
        submit_btn = ModernButton(text='‚úÖ Submit Prediction', on_press=self.submit_prediction)
        
        buttons_layout.add_widget(cancel_btn)
        buttons_layout.add_widget(submit_btn)
        layout.add_widget(buttons_layout)
        
        self.add_widget(layout)
    
    def submit_prediction(self, instance):
        try:
            prediction_data = {
                'score': f"{self.team1_score.text}-{self.team2_score.text}",
                'winner': self.winner_input.text,
                'scorers': self.scorers_input.text,
                'analysis': self.analysis_input.text,
                'username': self.current_user['username'],
                'strategy': self.current_user['strategy'],
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M')
            }
            self.on_prediction_submit(self.match, prediction_data)
            self.dismiss()
        except ValueError:
            self.show_error("Please check your inputs!")

class ChampionsLeagueApp(App):
    def build(self):
        self.title = "UEFA Champions League üèÜ"
        self.data_manager = DataManager()
        self.user_predictions = {}
        self.liked_posts = set()
        self.current_user = None
        self.users_file = "users_data.json"
        
        # ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        self.load_users_data()
        
        # ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        self.main_layout = BoxLayout(orientation='vertical', spacing=dp(5))
        
        self.create_header()
        self.create_stats_bar()
        self.create_tabs()
        
        # ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ®ÿØÿ°
        Clock.schedule_once(lambda dt: self.load_data(), 1)
        
        return self.main_layout
    
    def load_users_data(self):
        try:
            if os.path.exists(self.users_file):
                with open(self.users_file, 'r') as f:
                    self.users_data = json.load(f)
            else:
                self.users_data = {}
        except:
            self.users_data = {}
    
    def save_users_data(self):
        try:
            with open(self.users_file, 'w') as f:
                json.dump(self.users_data, f)
        except:
            pass
    
    def create_header(self):
        header = BoxLayout(size_hint=(1, 0.1), padding=dp(10))
        with header.canvas.before:
            Color(0.1, 0.15, 0.25, 1)
            Rectangle(pos=header.pos, size=header.size)
            Color(0, 0.4, 0.8, 0.3)
            Rectangle(pos=(header.pos[0], header.pos[1] + header.height * 0.5), 
                     size=(header.width, header.height * 0.5))
        
        title = ModernLabel(
            text='üèÜ UEFA Champions League',
            font_size=dp(22),
            bold=True,
            halign='center'
        )
        
        # ÿ≤ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        self.user_btn = ModernButton(
            text='üë§ Login' if not self.current_user else f'üë§ {self.current_user["username"]}',
            size_hint=(0.25, 1),
            on_press=self.show_login_modal
        )
        
        # ÿ≤ÿ± ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
        refresh_btn = ModernButton(
            text='üîÑ Refresh',
            size_hint=(0.2, 1),
            on_press=self.refresh_data
        )
        
        header.add_widget(title)
        header.add_widget(self.user_btn)
        header.add_widget(refresh_btn)
        
        self.main_layout.add_widget(header)
    
    def show_login_modal(self, instance):
        if self.current_user:
            self.show_user_profile()
        else:
            modal = LoginModal(self.on_login_success)
            modal.open()
    
    def on_login_success(self, username, password, strategy):
        # ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        user_key = f"{username}_{password}"
        if user_key not in self.users_data:
            self.users_data[user_key] = {
                'username': username,
                'password': password,
                'strategy': strategy,
                'join_date': datetime.now().strftime('%Y-%m-%d'),
                'predictions_count': 0
            }
            self.save_users_data()
        
        self.current_user = self.users_data[user_key]
        self.user_btn.text = f'üë§ {username}'
        self.show_success_message(f"Welcome {username}!")
    
    def show_user_profile(self):
        content = BoxLayout(orientation='vertical', padding=dp(20), spacing=dp(10))
        
        content.add_widget(ModernLabel(
            text=f"üë§ {self.current_user['username']}",
            font_size=dp(18),
            bold=True
        ))
        
        content.add_widget(ModernLabel(
            text=f"üéØ Strategy: {self.current_user['strategy']}",
            font_size=dp(14)
        ))
        
        content.add_widget(ModernLabel(
            text=f"üìÖ Member since: {self.current_user['join_date']}",
            font_size=dp(12),
            color=(0.8, 0.8, 0.8, 1)
        ))
        
        content.add_widget(ModernLabel(
            text=f"üìä Predictions made: {self.current_user.get('predictions_count', 0)}",
            font_size=dp(12),
            color=(0.8, 0.8, 0.8, 1)
        ))
        
        logout_btn = ModernButton(
            text='üö™ Logout',
            on_press=self.logout
        )
        content.add_widget(logout_btn)
        
        popup = Popup(
            title='User Profile',
            content=content,
            size_hint=(0.7, 0.5),
            background_color=(0.1, 0.15, 0.25, 1)
        )
        popup.open()
    
    def logout(self, instance):
        self.current_user = None
        self.user_btn.text = 'üë§ Login'
        for popup in [p for p in Popup._active_popups if hasattr(p, '_instance')]:
            popup.dismiss()
        self.show_success_message("Logged out successfully!")
    
    def show_success_message(self, message):
        popup = Popup(
            title='Success',
            content=ModernLabel(text=message),
            size_hint=(0.6, 0.3),
            background_color=(0.2, 0.6, 0.2, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 2)
    
    def create_stats_bar(self):
        stats_layout = BoxLayout(size_hint=(1, 0.08), spacing=dp(8), padding=dp(10))
        
        stats_data = [
            ('üë•', '16', 'Teams'),
            ('üìä', '45', 'Matches'),
            ('üéØ', '128', 'Goals'),
            ('ü§î', str(len(self.user_predictions)), 'Predictions')
        ]
        
        for emoji, value, label in stats_data:
            stat_box = BoxLayout(orientation='vertical')
            with stat_box.canvas.before:
                Color(0.12, 0.18, 0.28, 1)
                RoundedRectangle(pos=stat_box.pos, size=stat_box.size, radius=[dp(10),])
            
            stat_box.add_widget(ModernLabel(text=emoji, font_size=dp(18)))
            stat_box.add_widget(ModernLabel(text=value, font_size=dp(16), bold=True))
            stat_box.add_widget(ModernLabel(text=label, font_size=dp(10), color=(0.7, 0.7, 0.8, 1)))
            stats_layout.add_widget(stat_box)
        
        self.main_layout.add_widget(stats_layout)
    
    def create_tabs(self):
        self.tabs = TabbedPanel(
            size_hint=(1, 0.82),
            tab_pos='top_mid',
            do_default_tab=False,
            background_color=(0.08, 0.12, 0.2, 1),
            border=[0, 0, 0, 0]
        )
        
        # ÿ™ÿ®ŸàŸäÿ® ÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™
        matches_tab = TabbedPanelItem(text='‚öΩ Matches')
        matches_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.matches_content = ScrollView()
        self.matches_layout = GridLayout(cols=1, spacing=dp(10), size_hint_y=None, padding=dp(10))
        self.matches_layout.bind(minimum_height=self.matches_layout.setter('height'))
        self.matches_content.add_widget(self.matches_layout)
        matches_tab.add_widget(self.matches_content)
        
        # ÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ™ŸàŸÇÿπÿßÿ™
        predictions_tab = TabbedPanelItem(text='ü§î Predictions')
        predictions_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.predictions_content = ScrollView()
        self.predictions_layout = GridLayout(cols=1, spacing=dp(10), size_hint_y=None, padding=dp(10))
        self.predictions_layout.bind(minimum_height=self.predictions_layout.setter('height'))
        self.predictions_content.add_widget(self.predictions_layout)
        predictions_tab.add_widget(self.predictions_content)
        
        # ÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®
        standings_tab = TabbedPanelItem(text='üìä Standings')
        standings_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.standings_content = ScrollView()
        self.standings_layout = GridLayout(cols=1, spacing=dp(3), size_hint_y=None, padding=dp(10))
        self.standings_layout.bind(minimum_height=self.standings_layout.setter('height'))
        self.standings_content.add_widget(self.standings_layout)
        standings_tab.add_widget(self.standings_content)
        
        # ÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ£ÿÆÿ®ÿßÿ±
        news_tab = TabbedPanelItem(text='üì∞ News')
        news_tab.background_color = (0.1, 0.15, 0.25, 1)
        self.news_content = ScrollView()
        self.news_layout = GridLayout(cols=1, spacing=dp(12), size_hint_y=None, padding=dp(10))
        self.news_layout.bind(minimum_height=self.news_layout.setter('height'))
        self.news_content.add_widget(self.news_layout)
        news_tab.add_widget(self.news_content)
        
        self.tabs.add_widget(matches_tab)
        self.tabs.add_widget(predictions_tab)
        self.tabs.add_widget(standings_tab)
        self.tabs.add_widget(news_tab)
        
        self.main_layout.add_widget(self.tabs)
    
    def load_data(self):
        threading.Thread(target=self._load_data_thread, daemon=True).start()
    
    def _load_data_thread(self):
        try:
            matches_data = self.data_manager.get_live_matches()
            standings_data = self.data_manager.get_standings()
            news_data = self.data_manager.get_news()
            
            Clock.schedule_once(lambda dt: self.update_ui(
                matches_data, standings_data, news_data
            ), 0)
            
        except Exception as e:
            Clock.schedule_once(lambda dt: self.show_error(str(e)), 0)
    
    def update_ui(self, matches, standings, news):
        self.matches_layout.clear_widgets()
        for match in matches:
            self.matches_layout.add_widget(self.create_match_card(match))
        
        self.update_predictions_tab()
        
        self.standings_layout.clear_widgets()
        self.standings_layout.add_widget(self.create_standings_header())
        for team in standings:
            self.standings_layout.add_widget(self.create_team_row(team, team['rank']))
        
        self.news_layout.clear_widgets()
        for news_item in news:
            self.news_layout.add_widget(self.create_news_card(news_item))
    
    def create_match_card(self, match):
        card = CardLayout(height=dp(140))
        
        match_info = BoxLayout(size_hint=(1, 0.5))
        
        team_layout1 = BoxLayout(orientation='vertical', size_hint=(0.4, 1))
        team_emoji1 = ModernLabel(text=self.get_team_emoji(match['team1']), font_size=dp(20))
        team_name1 = ModernLabel(text=match['team1'], font_size=dp(12), halign='center')
        team_layout1.add_widget(team_emoji1)
        team_layout1.add_widget(team_name1)
        
        score_layout = BoxLayout(orientation='vertical', size_hint=(0.2, 1))
        if match.get('status') == 'upcoming':
            score = ModernLabel(text="VS", font_size=dp(16), color=(0.8, 0.8, 0.8, 1))
            status = ModernLabel(text="UPCOMING", font_size=dp(10), color=(0.6, 0.8, 1, 1))
        else:
            score = ModernLabel(text=match['score'], font_size=dp(18), bold=True, color=(1, 0.8, 0.2, 1))
            status = ModernLabel(text="LIVE", font_size=dp(10), color=(1, 0.3, 0.3, 1))
        score_layout.add_widget(score)
        score_layout.add_widget(status)
        
        team_layout2 = BoxLayout(orientation='vertical', size_hint=(0.4, 1))
        team_emoji2 = ModernLabel(text=self.get_team_emoji(match['team2']), font_size=dp(20))
        team_name2 = ModernLabel(text=match['team2'], font_size=dp(12), halign='center')
        team_layout2.add_widget(team_emoji2)
        team_layout2.add_widget(team_name2)
        
        match_info.add_widget(team_layout1)
        match_info.add_widget(score_layout)
        match_info.add_widget(team_layout2)
        
        details = BoxLayout(size_hint=(1, 0.3))
        stage = ModernLabel(text=f"üèÜ {match['stage']}", font_size=dp(11))
        time = ModernLabel(text=f"üïê {match['date']}", font_size=dp(11))
        details.add_widget(stage)
        details.add_widget(time)
        
        actions = BoxLayout(size_hint=(1, 0.2), spacing=dp(5))
        if match.get('status') == 'upcoming':
            predict_btn = ModernButton(
                text='üéØ Predict Score',
                size_hint=(0.6, 1),
                on_press=lambda x, m=match: self.show_detailed_prediction_modal(m)
            )
            actions.add_widget(predict_btn)
        
        card.add_widget(match_info)
        card.add_widget(details)
        if match.get('status') == 'upcoming':
            card.add_widget(actions)
        
        return card
    
    def show_detailed_prediction_modal(self, match):
        if not self.current_user:
            self.show_login_required_message()
            return
        
        modal = DetailedPredictionModal(match, self.current_user, self.on_detailed_prediction_submit)
        modal.open()
    
    def show_login_required_message(self):
        popup = Popup(
            title='Login Required',
            content=ModernLabel(text="Please login to make predictions!"),
            size_hint=(0.6, 0.3),
            background_color=(0.8, 0.6, 0.2, 1)
        )
        popup.open()
        Clock.schedule_once(lambda dt: popup.dismiss(), 2)
    
    def on_detailed_prediction_submit(self, match, prediction_data):
        match_id = f"{match['team1']}_{match['team2']}_{match['date']}"
        self.user_predictions[match_id] = {
            'match': match,
            'prediction': prediction_data
        }
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿØ ÿ™ŸàŸÇÿπÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        user_key = f"{self.current_user['username']}_{self.current_user['password']}"
        if user_key in self.users_data:
            self.users_data[user_key]['predictions_count'] = self.users_data[user_key].get('predictions_count', 0) + 1
            self.save_users_data()
        
        self.update_predictions_tab()
        self.show_success_message("Prediction submitted successfully!")
    
    def update_predictions_tab(self):
        self.predictions_layout.clear_widgets()
        
        if not self.user_predictions:
            empty_label = ModernLabel(
                text="ü§î No predictions yet!\nLogin and predict upcoming matches.",
                font_size=dp(16),
                halign='center'
            )
            self.predictions_layout.add_widget(empty_label)
            return
        
        for pred_id, prediction_data in self.user_predictions.items():
            self.predictions_layout.add_widget(self.create_detailed_prediction_card(prediction_data))
    
    def create_detailed_prediction_card(self, prediction_data):
        card = CardLayout(height=dp(200))
        match = prediction_data['match']
        pred = prediction_data['prediction']
        
        title = ModernLabel(
            text=f"üéØ Prediction by {pred['username']}",
            font_size=dp(14),
            bold=True,
            halign='left'
        )
        
        match_info = BoxLayout(size_hint=(1, 0.2))
        teams = ModernLabel(
            text=f"{match['team1']} vs {match['team2']}",
            font_size=dp(13),
            halign='center'
        )
        
        score = ModernLabel(
            text=f"üìä Score: {pred['score']}",
            font_size=dp(14),
            bold=True,
            color=(1, 0.8, 0.2, 1),
            halign='center'
        )
        
        match_info.add_widget(teams)
        match_info.add_widget(score)
        
        details = BoxLayout(orientation='vertical', size_hint=(1, 0.6))
        details.add_widget(ModernLabel(text=f"üèÜ Winner: {pred['winner']}", font_size=dp(12)))
        details.add_widget(ModernLabel(text=f"‚öΩ Scorers: {pred['scorers']}", font_size=dp(11)))
        details.add_widget(ModernLabel(text=f"üìä Analysis: {pred['analysis']}", font_size=dp(11)))
        
        footer = BoxLayout(size_hint=(1, 0.2))
        footer.add_widget(ModernLabel(text=f"üïê {pred['timestamp']}", font_size=dp(10)))
        footer.add_widget(ModernLabel(text=f"üéØ Strategy: {pred['strategy'][:20]}...", font_size=dp(10)))
        
        card.add_widget(title)
        card.add_widget(match_info)
        card.add_widget(details)
        card.add_widget(footer)
        
        return card
    
    def create_standings_header(self):
        header = BoxLayout(size_hint_y=None, height=dp(35), padding=dp(5))
        with header.canvas.before:
            Color(0, 0.4, 0.8, 1)
            Rectangle(pos=header.pos, size=header.size)
        
        headers = ['üèÖ', 'Team', 'P', 'W', 'D', 'L', 'Pts']
        for text in headers:
            header.add_widget(ModernLabel(text=text, font_size=dp(12), bold=True, halign='center'))
        
        return header
    
    def create_team_row(self, team, rank):
        row = BoxLayout(size_hint_y=None, height=dp(32), padding=dp(5))
        bg_color = (0.12, 0.18, 0.28, 1) if rank % 2 == 0 else (0.15, 0.22, 0.35, 1)
        with row.canvas.before:
            Color(*bg_color)
            Rectangle(pos=row.pos, size=row.size)
        
        rank_emoji = 'ü•á' if rank == 1 else 'ü•à' if rank == 2 else 'ü•â' if rank == 3 else f'{rank}'
        
        data = [rank_emoji, team['name'], str(team['played']), str(team['won']), 
                str(team['drawn']), str(team['lost']), str(team['points'])]
        
        for i, text in enumerate(data):
            color = (1, 0.8, 0.2, 1) if i == 6 else (1, 1, 1, 1)
            bold = i in [0, 6]
            row.add_widget(ModernLabel(text=text, font_size=dp(11), bold=bold, color=color, halign='center'))
        
        return row
    
    def create_news_card(self, news_item):
        card = CardLayout(height=dp(160))
        
        title_layout = BoxLayout(size_hint=(1, 0.25))
        title = ModernLabel(text=f"üì¢ {news_item['title']}", font_size=dp(14), bold=True, halign='left')
        title_layout.add_widget(title)
        
        content = ModernLabel(
            text=news_item['content'],
            font_size=dp(11),
            size_hint_y=0.5,
            color=(0.8, 0.9, 1, 1),
            halign='left'
        )
        
        interactions = BoxLayout(size_hint=(1, 0.25))
        
        like_btn = ModernButton(
            text=f"üëç {news_item['likes']}",
            on_press=lambda x, item=news_item: self.toggle_like(item)
        )
        
        interactions.add_widget(ModernLabel(text=f"üí¨ {news_item['comments']}", font_size=dp(10)))
        interactions.add_widget(ModernLabel(text=f"üîÑ {news_item['shares']}", font_size=dp(10)))
        interactions.add_widget(ModernLabel(text=f"üìÖ {news_item['date']}", font_size=dp(10), color=(0.7, 0.7, 0.8, 1)))
        interactions.add_widget(like_btn)
        
        card.add_widget(title_layout)
        card.add_widget(content)
        card.add_widget(interactions)
        
        return card
    
    def toggle_like(self, news_item):
        if not self.current_user:
            self.show_login_required_message()
            return
        
        news_id = news_item['title']
        if news_id in self.liked_posts:
            self.liked_posts.remove(news_id)
            news_item['likes'] = str(int(news_item['likes'].replace('K', '')) - 1) + 'K'
        else:
            self.liked_posts.add(news_id)
            news_item['likes'] = str(int(news_item['likes'].replace('K', '')) + 1) + 'K'
        
        self.update_ui(
            self.data_manager.get_live_matches(),
            self.data_manager.get_standings(),
            self.data_manager.get_news()
        )
    
    def get_team_emoji(self, team_name):
        emoji_map = {
            'Real Madrid': '‚ö™', 'Man City': 'üîµ', 'Bayern Munich': 'üî¥',
            'Arsenal': 'üî¥', 'Barcelona': 'üîµ', 'PSG': 'üîµ',
            'Liverpool': 'üî¥', 'Chelsea': 'üîµ', 'Dortmund': 'üü°', 'Atletico Madrid': 'üî¥'
        }
        return emoji_map.get(team_name, '‚öΩ')
    
    def refresh_data(self, instance):
        self.load_data()
        self.show_success_message("Data refreshed!")
    
    def show_error(self, error_msg):
        print(f"Error: {error_msg}")

class DataManager:
    def get_live_matches(self):
        return [
            {
                'team1': 'Real Madrid', 'team2': 'Man City', 'score': '3-2',
                'date': 'Today 21:00', 'stage': 'Quarter Final', 'status': 'live'
            },
            {
                'team1': 'Bayern Munich', 'team2': 'Arsenal', 'score': '0-0',
                'date': 'Tomorrow 20:00', 'stage': 'Quarter Final', 'status': 'upcoming'
            },
            {
                'team1': 'Barcelona', 'team2': 'PSG', 'score': '0-0',
                'date': 'Apr 14, 21:00', 'stage': 'Quarter Final', 'status': 'upcoming'
            },
            {
                'team1': 'Dortmund', 'team2': 'Atletico Madrid', 'score': '0-0',
                'date': 'Apr 15, 20:00', 'stage': 'Quarter Final', 'status': 'upcoming'
            }
        ]
    
    def get_standings(self):
        return [
            {'rank': 1, 'name': 'Real Madrid', 'played': 6, 'won': 5, 'drawn': 1, 'lost': 0, 'points': 16},
            {'rank': 2, 'name': 'Man City', 'played': 6, 'won': 4, 'drawn': 2, 'lost': 0, 'points': 14},
            {'rank': 3, 'name': 'Bayern Munich', 'played': 6, 'won': 4, 'drawn': 1, 'lost': 1, 'points': 13},
            {'rank': 4, 'name': 'Arsenal', 'played': 6, 'won': 4, 'drawn': 1, 'lost': 1, 'points': 13},
        ]
    
    def get_news(self):
        return [
            {
                'title': 'New Injury Shakes Real Madrid',
                'content': 'Brazilian star out for 3 weeks before crucial Man City clash.',
                'likes': '1.2K', 'comments': '245', 'shares': '89', 'date': '2 hours ago'
            },
            {
                'title': 'Record Breaking Goal Scorer', 
                'content': 'Young striker makes history with 10 goals in single season.',
                'likes': '2.1K', 'comments': '356', 'shares': '124', 'date': '5 hours ago'
            }
        ]

if __name__ == '__main__':
    ChampionsLeagueApp().run()
