# ucl_manager.py - النسخة اللي شغالة فعلاً عند الكل

import sys
import sqlite3
from pathlib import Path
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from PyQt6.QtWidgets import *
from PyQt6.QtCore import Qt, QDate
from PyQt6.QtGui import QColor

DB_PATH = Path("ucl_database.db")

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS teams (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL,
        country TEXT,
        group_char TEXT
    )''')
    c.execute('''CREATE TABLE IF NOT EXISTS matches (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        home_team TEXT,
        away_team TEXT,
        home_goals INTEGER,
        away_goals INTEGER,
        date TEXT
    )''')
    conn.commit()
    conn.close()

def add_team(name, country, group):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute("INSERT INTO teams (name, country, group_char) VALUES (?, ?, ?)", (name, country, group))
        conn.commit()
        return True
    except:
        return False
    finally:
        conn.close()

def add_match(home, away, hg, ag, date):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO matches (home_team, away_team, home_goals, away_goals, date) VALUES (?, ?, ?, ?, ?)",
              (home, away, hg, ag, date))
    conn.commit()
    conn.close()

def get_teams():
    conn = sqlite3.connect(DB_PATH)
    df = pd.read_sql_query("SELECT name FROM teams ORDER BY name", conn)
    conn.close()
    return df["name"].tolist() if not df.empty else []

def get_standings():
    conn = sqlite3.connect(DB_PATH)
    query = """
    SELECT 
        t.name,
        COALESCE(COUNT(m.home_team), 0) + COALESCE(COUNT(m.away_team), 0) AS P,
        SUM(CASE WHEN (m.home_team = t.name AND m.home_goals > m.away_goals) OR (m.away_team = t.name AND m.away_goals > m.home_goals) THEN 1 ELSE 0 END) AS W,
        SUM(CASE WHEN m.home_goals = m.away_goals AND m.home_goals IS NOT NULL THEN 1 ELSE 0 END) AS D,
        SUM(CASE WHEN (m.home_team = t.name AND m.home_goals < m.away_goals) OR (m.away_team = t.name AND m.away_goals < m.home_goals) THEN 1 ELSE 0 END) AS L,
        COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END), 0) AS GF,
        COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END), 0) AS GA,
        (COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END), 0) - 
         COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END), 0)) AS GD,
        (SUM(CASE WHEN (m.home_team = t.name AND m.home_goals > m.away_goals) OR (m.away_team = t.name AND m.away_goals > m.home_goals) THEN 3 
             WHEN m.home_goals = m.away_goals AND m.home_goals IS NOT NULL THEN 1 ELSE 0 END)) AS Pts
    FROM teams t
    LEFT JOIN matches m ON m.home_team = t.name OR m.away_team = t.name
    GROUP BY t.name
    ORDER BY Pts DESC, GD DESC, GF DESC
    """
    df = pd.read_sql_query(query, conn)
    conn.close()
    return df

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("دوري أبطال أوروبا 2025")
        self.resize(1300, 800)
        self.setStyleSheet("background:#001f3f; color:white;")

        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)

        tabs = QTabWidget()
        layout.addWidget(tabs)

        tabs.addTab(self.teams_tab(), "الفرق")
        tabs.addTab(self.matches_tab(), "المباريات")
        tabs.addTab(self.standings_tab(), "الترتيب")
        tabs.addTab(self.chart_tab(), "الرسم البياني")

    def teams_tab(self):
        w = QWidget()
        l = QVBoxLayout(w)
        g = QGroupBox("إضافة فريق جديد")
        f = QFormLayout(g)

        self.name_input = QLineEdit()
        self.country_input = QLineEdit()
        self.group_input = QComboBox()
        self.group_input.addItems(["A","B","C","D","E","F","G","H"])

        btn = QPushButton("إضافة الفريق")
        btn.clicked.connect(self.add_team_now)

        f.addRow("اسم الفريق:", self.name_input)
        f.addRow("الدولة:", self.country_input)
        f.addRow("المجموعة:", self.group_input)
        f.addRow(btn)
        l.addWidget(g)
        l.addStretch()
        return w

    def add_team_now(self):
        name = self.name_input.text().strip()
        country = self.country_input.text().strip()
        group = self.group_input.currentText()
        if name and country:
            if add_team(name, country, group):
                QMessageBox.information(self, "تم", f"تم إضافة {name}")
                self.name_input.clear()
                self.country_input.clear()
            else:
                QMessageBox.warning(self, "خطأ", "الفريق موجود")
        else:
            QMessageBox.warning(self, "خطأ", "املأ البيانات")

    def matches_tab(self):
        w = QWidget()
        l = QVBoxLayout(w)
        g = QGroupBox("إضافة مباراة")
        f = QFormLayout(g)

        teams = get_teams()
        self.home = QComboBox(); self.home.addItems(teams)
        self.away = QComboBox(); self.away.addItems(teams)
        self.hg = QSpinBox(); self.hg.setRange(0,15)
        self.ag = QSpinBox(); self.ag.setRange(0,15)
        self.date = QDateEdit(); self.date.setDate(QDate.currentDate())

        btn = QPushButton("إضافة المباراة")
        btn.clicked.connect(self.add_match_now)

        f.addRow("المضيف:", self.home)
        f.addRow("أهدافه:", self.hg)
        f.addRow("الضيف:", self.away)
        f.addRow("أهدافه:", self.ag)
        f.addRow("التاريخ:", self.date)
        f.addRow(btn)
        l.addWidget(g)

        refresh = QPushButton("تحديث قائمة الفرق")
        refresh.clicked.connect(lambda: (self.home.clear(), self.home.addItems(get_teams()), self.away.clear(), self.away.addItems(get_teams())))
        l.addWidget(refresh)
        return w

    def add_match_now(self):
        h = self.home.currentText()
        a = self.away.currentText()
        if h and a and h != a:
            add_match(h, a, self.hg.value(), self.ag.value(), self.date.date().toString("yyyy-MM-dd"))
            QMessageBox.information(self, "تم", "تمت الإضافة")
        else:
            QMessageBox.warning(self, "خطأ", "اختار فريقين مختلفين")

    def standings_tab(self):
        w = QWidget()
        l = QVBoxLayout(w)
        self.table = QTableWidget()
        l.addWidget(self.table)
        btn = QPushButton("تحديث الترتيب")
        btn.clicked.connect(self.update_table)
        l.addWidget(btn)
        self.update_table()
        return w

    def update_table(self):
        df = get_standings()
        if df.empty:
            return
        self.table.setRowCount(len(df))
        self.table.setColumnCount(len(df.columns))
        self.table.setHorizontalHeaderLabels(["الفريق","م","ف","ت","خ","له","عليه","ف.أ","نقاط"])
        for i, row in df.iterrows():
            self.table.setItem(i, 0, QTableWidgetItem(row["name"]))
            self.table.setItem(i, 1, QTableWidgetItem(str(row["P"])))
            self.table.setItem(i, 2, QTableWidgetItem(str(row["W"])))
            self.table.setItem(i, 3, QTableWidgetItem(str(row["D"])))
            self.table.setItem(i, 4, QTableWidgetItem(str(row["L"])))
            self.table.setItem(i, 5, QTableWidgetItem(str(row["GF"])))
            self.table.setItem(i, 6, QTableWidgetItem(str(row["GA"])))
            self.table.setItem(i, 7, QTableWidgetItem(str(row["GD"])))
            self.table.setItem(i, 8, QTableWidgetItem(str(row["Pts"])))
            if i < 4:  # أول 4 فرق
                for j in range(9):
                    self.table.item(i,j).setBackground(QColor(0,200,0,100))

    def chart_tab(self):
        w = QWidget()
        l = QVBoxLayout(w)
        self.canvas = FigureCanvas(plt.Figure(figsize=(12,8)))
        l.addWidget(self.canvas)
        btn = QPushButton("رسم أفضل 12 فريق")
        btn.clicked.connect(self.draw)
        l.addWidget(btn)
        self.draw()
        return w

    def draw(self):
        df = get_standings().head(12)
        if df.empty:
            return

        self.canvas.figure.clear()
        ax = self.canvas.figure.add_subplot(111)
        
        # هنا الحل النهائي: نستخدم العمود "name" مباشرة
        ax.barh(df["name"], df["Pts"], color="#FFD700", edgecolor="white")
        ax.set_facecolor("#001f3f")
        ax.tick_params(colors="white", labelsize=14)
        ax.set_xlabel("النقاط", color="white", fontsize=16)
        ax.set_title("أفضل 12 فريقًا", color="#FFD700", fontsize=24, fontweight="bold")
        ax.invert_yaxis()
        ax.grid(axis='x', color='gray', alpha=0.3)

        # كتابة النقاط على البار
        for i, v in enumerate(df["Pts"]):
            ax.text(v + 0.3, i, str(v), color="white", va='center', fontweight='bold', fontsize=14)

        plt.subplots_adjust(left=0.3)
        self.canvas.draw()

if __name__ == "__main__":
    init_db()  # مهم جدًا نعملها أول حاجة
    app = QApplication(sys.argv)
    app.setStyle("Fusion")
    win = MainWindow()
    win.show()
    sys.exit(app.exec())
