# ucl_manager_perfect_final_arabic.py
# النسخة النهائية - كل شيء مثالي: أرقام بيضاء + عربي بدون عكس + GIF + تصميم فخم

import sys
import sqlite3
from pathlib import Path
import pandas as pd
import matplotlib.pyplot as plt

plt.rcParams['font.family'] = 'Segoe UI', 'Tahoma', 'Arial'
plt.rcParams['axes.unicode_minus'] = False

from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from PyQt6.QtWidgets import *
from PyQt6.QtCore import Qt, QDate
from PyQt6.QtGui import QColor, QMovie

DB_PATH = Path("ucl_database.db")

# === باقي الدوال زي ما هي (init_db, add_team, get_standings, إلخ) ===
# (نفس الكود اللي فوق من غير تغيير)

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS teams (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT UNIQUE NOT NULL, country TEXT, group_char TEXT)''')
    c.execute('''CREATE TABLE IF NOT EXISTS matches (id INTEGER PRIMARY KEY AUTOINCREMENT, home_team TEXT, away_team TEXT, home_goals INTEGER, away_goals INTEGER, date TEXT)''')
    conn.commit()
    conn.close()

def add_team(name, country, group):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute("INSERT INTO teams (name, country, group_char) VALUES (?, ?, ?)", (name, country, group))
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        return False
    finally:
        conn.close()

def add_match(home, away, hg, ag, date):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO matches (home_team, away_team, home_goals, away_goals, date) VALUES (?, ?, ?, ?, ?)",
              (home, away, hg, ag, date))
    conn.commit()
    conn.close()

def get_teams():
    conn = sqlite3.connect(DB_PATH)
    try:
        df = pd.read_sql_query("SELECT name FROM teams ORDER BY name", conn)
        return df["name"].tolist()
    except:
        return []
    finally:
        conn.close()

def get_standings():
    conn = sqlite3.connect(DB_PATH)
    query = """
    SELECT t.name,
           COUNT(m.id) AS P,
           SUM(CASE WHEN (m.home_team = t.name AND m.home_goals > m.away_goals) OR (m.away_team = t.name AND m.away_goals > m.home_goals) THEN 1 ELSE 0 END) AS W,
           SUM(CASE WHEN m.home_goals = m.away_goals AND m.home_goals IS NOT NULL THEN 1 ELSE 0 END) AS D,
           SUM(CASE WHEN (m.home_team = t.name AND m.home_goals < m.away_goals) OR (m.away_team = t.name AND m.away_goals < m.home_goals) THEN 1 ELSE 0 END) AS L,
           COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END), 0) AS GF,
           COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END), 0) AS GA,
           (COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END), 0) -
            COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END), 0)) AS GD,
           SUM(CASE WHEN (m.home_team = t.name AND m.home_goals > m.away_goals) OR (m.away_team = t.name AND m.away_goals > m.home_goals) THEN 3
                WHEN m.home_goals = m.away_goals AND m.home_goals IS NOT NULL THEN 1 ELSE 0 END) AS Pts
    FROM teams t LEFT JOIN matches m ON m.home_team = t.name OR m.away_team = t.name
    GROUP BY t.name
    ORDER BY Pts DESC, GD DESC, GF DESC
    """
    df = pd.read_sql_query(query, conn)
    conn.close()
    return df

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.lang = "ar"
        self.setWindowTitle("نظام دوري أبطال أوروبا 2025")
        self.resize(1500, 900)

        self.setStyleSheet("""
            QMainWindow {background:#001f3f;}
            QGroupBox {color:#FFD700; font-size:18px; font-weight:bold; border:2px solid #FFD700; border-radius:12px; margin:10px; padding:15px;}
            QPushButton {background:#FFD700; color:#001f3f; font-size:15px; font-weight:bold; padding:12px 25px; border-radius:12px;}
            QPushButton:hover {background:#FFC107;}
            QTabWidget::pane {border:3px solid #FFD700; background:#112240; border-radius:12px;}
            QTabBar::tab {background:#003366; color:white; padding:15px; font-size:18px; border-radius:10px;}
            QTabBar::tab:selected {background:#FFD700; color:#001f3f; font-weight:bold;}
        """)

        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)
        layout.setContentsMargins(15, 15, 15, 15)
        layout.setSpacing(10)

        top = QHBoxLayout()
        top.addStretch()
        self.lang_btn = QPushButton("English")
        self.lang_btn.setFixedSize(130, 50)
        self.lang_btn.clicked.connect(self.toggle_lang)
        top.addWidget(self.lang_btn)
        layout.addLayout(top)

        self.tabs = QTabWidget()
        layout.addWidget(self.tabs)

        self.apply_direction()
        self.refresh_ui()

    def toggle_lang(self):
        self.lang = "en" if self.lang == "ar" else "ar"
        self.apply_direction()
        self.refresh_ui()

    def apply_direction(self):
        if self.lang == "ar":
            self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
            self.lang_btn.setText("English")
        else:
            self.setLayoutDirection(Qt.LayoutDirection.LeftToRight)
            self.lang_btn.setText("العربية")

    def refresh_ui(self):
        self.tabs.clear()
        titles = ["الترحيب", "الفرق", "المباريات", "الترتيب", "التحليل"]
        self.tabs.addTab(self.tab_welcome(), titles[0])
        self.tabs.addTab(self.tab_teams(), titles[1])
        self.tabs.addTab(self.tab_matches(), titles[2])
        self.tabs.addTab(self.tab_standings(), titles[3])
        self.tabs.addTab(self.tab_chart(), titles[4])

    def tab_welcome(self):
        w = QWidget()
        l = QVBoxLayout(w)
        l.setContentsMargins(0,0,0,0)
        label = QLabel()
        label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        movie = QMovie("ucl.gif")
        if movie.isValid():
            label.setMovie(movie)
            movie.start()
        else:
            label.setText("دوري أبطال أوروبا\nالنسخة الأسطورية")
            label.setStyleSheet("font-size:50px; color:#FFD700; font-weight:bold;")
        l.addWidget(label)
        return w

    def tab_teams(self):
        w = QWidget(); l = QVBoxLayout(w)
        g = QGroupBox("إضافة فريق جديد")
        f = QFormLayout(g)
        self.t_name = QLineEdit(); self.t_country = QLineEdit()
        self.t_group = QComboBox(); self.t_group.addItems(["A","B","C","D","E","F","G","H"])
        btn = QPushButton("إضافة الفريق"); btn.clicked.connect(self.add_team_act)
        f.addRow("اسم الفريق:", self.t_name); f.addRow("الدولة:", self.t_country)
        f.addRow("المجموعة:", self.t_group); f.addRow("", btn)
        l.addWidget(g); l.addStretch(); return w

    def add_team_act(self):
        if self.t_name.text().strip() and self.t_country.text().strip():
            if add_team(self.t_name.text().strip(), self.t_country.text().strip(), self.t_group.currentText()):
                QMessageBox.information(self, "تم", "تم إضافة الفريق")
                self.t_name.clear(); self.t_country.clear(); self.refresh_ui()
            else:
                QMessageBox.warning(self, "خطأ", "الفريق موجود مسبقًا")
        else:
            QMessageBox.warning(self, "خطأ", "املأ جميع الحقول")

    def tab_matches(self):
        w = QWidget(); l = QVBoxLayout(w)
        g = QGroupBox("إضافة مباراة")
        f = QFormLayout(g)
        teams = get_teams()
        self.h = QComboBox(); self.h.addItems(teams)
        self.a = QComboBox(); self.a.addItems(teams)
        self.hg = QSpinBox(); self.hg.setRange(0,20)
        self.ag = QSpinBox(); self.ag.setRange(0,20)
        btn = QPushButton("إضافة"); btn.clicked.connect(self.add_match_act)
        f.addRow("المضيف:", self.h); f.addRow("أهدافه:", self.hg)
        f.addRow("الضيف:", self.a); f.addRow("أهدافه:", self.ag); f.addRow("", btn)
        l.addWidget(g)
        r = QPushButton("تحديث الفرق")
        r.clicked.connect(lambda: (self.h.clear(), self.h.addItems(get_teams()), self.a.clear(), self.a.addItems(get_teams())))
        l.addWidget(r, alignment=Qt.AlignmentFlag.AlignCenter); l.addStretch(); return w

    def add_match_act(self):
        h, a = self.h.currentText(), self.a.currentText()
        if h and a and h != a:
            add_match(h, a, self.hg.value(), self.ag.value(), QDate.currentDate().toString("yyyy-MM-dd"))
            QMessageBox.information(self, "تم", "تمت الإضافة")
            self.refresh_ui()

    def tab_standings(self):
        w = QWidget(); l = QVBoxLayout(w)
        self.table = QTableWidget(); l.addWidget(self.table)
        btn = QPushButton("تحديث"); btn.clicked.connect(self.update_table)
        l.addWidget(btn, alignment=Qt.AlignmentFlag.AlignCenter)
        self.update_table(); return w

    def update_table(self):
        df = get_standings()
        if df.empty: return
        h = ["الفريق","لعب","ف","ت","خ","له","عليه","فارق","نقاط"]
        self.table.setColumnCount(9); self.table.setHorizontalHeaderLabels(h)
        self.table.setRowCount(len(df))
        for i, r in df.iterrows():
            for j, v in enumerate([r["name"],r["P"],r["W"],r["D"],r["L"],r["GF"],r["GA"],r["GD"],r["Pts"]]):
                item = QTableWidgetItem(str(v))
                if i < 4: item.setBackground(QColor(0,220,0,100))
                self.table.setItem(i, j, item)
        self.table.resizeColumnsToContents()

    def tab_chart(self):
        w = QWidget(); l = QVBoxLayout(w)
        self.canvas = FigureCanvas(plt.Figure(figsize=(12,8)))
        l.addWidget(self.canvas)
        btn = QPushButton("تحديث الرسم البياني")
        btn.clicked.connect(self.draw_chart)
        l.addWidget(btn, alignment=Qt.AlignmentFlag.AlignCenter)
        self.draw_chart(); return w

    def draw_chart(self):
        df = get_standings().head(12)
        if df.empty: return

        self.canvas.figure.clear()
        ax = self.canvas.figure.add_subplot(111)

        teams_raw = df["name"].tolist()
        points = df["Pts"].tolist()

        # الحل الذكي الجديد: نعكس النص العربي فقط مرة واحدة ونضمن إنه يطلع صح
        teams = [team[::-1] if any(ord(c) >= 0x0600 for c in team) else team for team in teams_raw]

        bars = ax.barh(range(len(teams)), points, color="#FFD700", height=0.75, edgecolor="#001f3f", linewidth=1.5)
        ax.set_facecolor("#001f3f")
        self.canvas.figure.patch.set_facecolor("#001f3f")

        ax.set_yticks(range(len(teams)))
        ax.set_yticklabels(teams, fontsize=17, fontweight='bold', color='white')
        ax.tick_params(colors="white", labelsize=14)
        ax.set_xlabel("النقاط", color="white", fontsize=16)
        ax.set_title("أفضل 12 فريق", color="#FFD700", fontsize=26, fontweight="bold", pad=30)

        ax.invert_yaxis()
        ax.grid(True, axis='x', color='gray', alpha=0.3, linestyle='--')

        # الأرقام بيضاء وواضحة جدًا
        for i, pt in enumerate(points):
            ax.text(pt + 0.5, i, str(pt), va='center', ha='left',
                    color="white", fontweight='bold', fontsize=18, bbox=dict(boxstyle="round,pad=0.3", facecolor="#FFD700", alpha=0.8))

        plt.subplots_adjust(left=0.38, right=0.95, top=0.9, bottom=0.1)
        self.canvas.draw()

if __name__ == "__main__":
    init_db()
    app = QApplication(sys.argv)
    app.setStyle("Fusion")
    win = MainWindow()
    win.show()
    sys.exit(app.exec())
