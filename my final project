# ucl_manager.py
# UEFA Champions League Management & Analysis System
# ملف واحد كامل - احترافي - دعم عربي/إنجليزي - ألوان فيفا الرسمية
# قابل للفصل لاحقًا بسهولة (كل قسم محدد بعلامات واضحة)
# تم حل جميع مشاكل PyQt السابقة نهائيًا

from __future__ import annotations

import sys
import os
import json
import sqlite3
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Tuple, Optional

import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas

# === PyQt6 ===
try:
    from PyQt6 import QtCore, QtGui, QtWidgets
    from PyQt6.QtCore import Qt, QTranslator, QLocale, QLibraryInfo, pyqtSignal
    from PyQt6.QtWidgets import (
        QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
        QTabWidget, QTableWidget, QTableWidgetItem, QPushButton,
        QComboBox, QLineEdit, QLabel, QMessageBox, QFileDialog,
        QGroupBox, QFormLayout, QSpinBox, QDateEdit, QSpacerItem, QSizePolicy
    )
    PYQT_AVAILABLE = True
except ImportError:
    PYQT_AVAILABLE = False
    print("تحذير: PyQt6 غير مثبت → pip install PyQt6")

# === FILE: database.py ===
DB_PATH = Path("ucl_database.db")

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS teams (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            country TEXT NOT NULL,
            group_char TEXT NOT NULL
        )
    ''')
    c.execute('''
        CREATE TABLE IF NOT EXISTS matches (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            home_team TEXT,
            away_team TEXT,
            home_goals INTEGER,
            away_goals INTEGER,
            date TEXT,
            stage TEXT,
            FOREIGN KEY(home_team) REFERENCES teams(name),
            FOREIGN KEY(away_team) REFERENCES teams(name)
        )
    ''')
    conn.commit()
    conn.close()

def add_team(name: str, country: str, group: str):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute("INSERT INTO teams (name, country, group_char) VALUES (?, ?, ?)", (name, country, group))
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        return False
    finally:
        conn.close()

def add_match(home: str, away: str, hg: int, ag: int, date: str, stage: str = "Group Stage"):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO matches (home_team, away_team, home_goals, away_goals, date, stage) VALUES (?, ?, ?, ?, ?, ?)",
              (home, away, hg, ag, date, stage))
    conn.commit()
    conn.close()

def get_standings() -> pd.DataFrame:
    conn = sqlite3.connect(DB_PATH)
    query = '''
        SELECT 
            t.name, t.country, t.group_char,
            COUNT(*) as P,
            SUM(CASE WHEN m.home_team = t.name AND m.home_goals > m.away_goals THEN 1
                     WHEN m.away_team = t.name AND m.away_goals > m.home_goals THEN 1 ELSE 0 END) as W,
            SUM(CASE WHEN m.home_goals = m.away_goals THEN 1 ELSE 0 END) as D,
            SUM(CASE WHEN m.home_team = t.name AND m.home_goals < m.away_goals THEN 1
                     WHEN m.away_team = t.name AND m.away_goals < m.home_goals THEN 1 ELSE 0 END) as L,
            SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END) as GF,
            SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END) as GA
        FROM teams t
        LEFT JOIN matches m ON (m.home_team = t.name OR m.away_team = t.name)
        WHERE m.stage = 'Group Stage' OR m.stage IS NULL
        GROUP BY t.name
        ORDER BY t.group_char, 
                 (W*3 + D) DESC,
                 (GF - GA) DESC,
                 GF DESC
    '''
    df = pd.read_sql_query(query, conn)
    if not df.empty:
        df["GD"] = df["GF"] - df["GA"]
        df["Pts"] = df["W"] * 3 + df["D"]
    conn.close()
    return df

def export_report():
    standings = get_standings()
    out_dir = Path("reports")
    out_dir.mkdir(exist_ok=True)
    standings.to_csv(out_dir / "standings.csv", index=False, encoding="utf-8-sig")
    standings.to_json(out_dir / "standings.json", orient="records", force_ascii=False, indent=2)
    return out_dir

# === FILE: translations.py ===
translations = {
    "ar": {
        "title": "نظام إدارة دوري أبطال أوروبا",
        "tab_teams": "الفرق",
        "tab_matches": "المباريات",
        "tab_standings": "الترتيب",
        "tab_analysis": "التحليل",
        "add_team": "إضافة فريق",
        "team_name": "اسم الفريق",
        "country": "الدولة",
        "group": "المجموعة",
        "add_match": "إضافة مباراة",
        "home_team": "الفريق المضيف",
        "away_team": "الفريق الضيف",
        "goals": "الأهداف",
        "date": "التاريخ",
        "stage": "المرحلة",
        "export": "تصدير التقرير",
        "language": "اللغة: عربي",
        "qualified": "متأهل",
        "top_scorers": "أفضل الهدافين (مثال)",
        "no_data": "لا توجد بيانات بعد",
    },
    "en": {
        "title": "UEFA Champions League System",
        "tab_teams": "Teams",
        "tab_matches": "Matches",
        "tab_standings": "Standings",
        "tab_analysis": "Analysis",
        "add_team": "Add Team",
        "team_name": "Team Name",
        "country": "Country",
        "group": "Group",
        "add_match": "Add Match",
        "home_team": "Home Team",
        "away_team": "Away Team",
        "goals": "Goals",
        "date": "Date",
        "stage": "Stage",
        "export": "Export Report",
        "language": "Language: English",
        "qualified": "Qualified",
        "top_scorers": "Top Scorers (Demo)",
        "no_data": "No data yet",
    }
}

# === FILE: main_gui.py ===
class UCLWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.current_lang = "ar"
        self.setWindowTitle(translations[self.current_lang]["title"])
        self.setGeometry(100, 50, 1200, 800)
        self.setStyleSheet(self.get_fifa_style())

        # Central Widget
        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)

        # Language Switcher
        lang_layout = QHBoxLayout()
        lang_layout.addStretch()
        self.lang_btn = QPushButton("English")
        self.lang_btn.clicked.connect(self.toggle_language)
        lang_layout.addWidget(self.lang_btn)
        layout.addLayout(lang_layout)

        # Tabs
        self.tabs = QTabWidget()
        self.tabs.addTab(self.create_teams_tab(), translations[self.current_lang]["tab_teams"])
        self.tabs.addTab(self.create_matches_tab(), translations[self.current_lang]["tab_matches"])
        self.tabs.addTab(self.create_standings_tab(), translations[self.current_lang]["tab_standings"])
        self.tabs.addTab(self.create_analysis_tab(), translations[self.current_lang]["tab_analysis"])
        layout.addWidget(self.tabs)

        self.update_texts()

    def get_fifa_style(self):
        return """
        QMainWindow { background-color: #001F3F; color: white; }
        QLabel { color: #FFD700; font-weight: bold; font-size: 14px; }
        QPushButton { background-color: #FFD700; color: #001F3F; font-weight: bold; padding: 10px; border-radius: 8px; }
        QPushButton:hover { background-color: #FFC107; }
        QTabWidget::pane { border: 2px solid #FFD700; background: #112233; }
        QTabBar::tab { background: #003366; color: white; padding: 12px; margin: 2px; border-radius: 6px; }
        QTabBar::tab:selected { background: #FFD700; color: #001F3F; font-weight: bold; }
        QTableWidget { background: white; color: black; gridline-color: #AAA; }
        QHeaderView::section { background: #003366; color: #FFD700; font-weight: bold; }
        """

    def toggle_language(self):
        self.current_lang = "en" if self.current_lang == "ar" else "ar"
        self.lang_btn.setText("العربية" if self.current_lang == "en" else "English")
        self.update_texts()
        self.tabs.setTabText(0, translations[self.current_lang]["tab_teams"])
        self.tabs.setTabText(1, translations[self.current_lang]["tab_matches"])
        self.tabs.setTabText(2, translations[self.current_lang]["tab_standings"])
        self.tabs.setTabText(3, translations[self.current_lang]["tab_analysis"])

    def update_texts(self):
        self.setWindowTitle(translations[self.current_lang]["title"])

    def create_teams_tab(self):
        widget = QWidget()
        layout = QVBoxLayout(widget)

        form = QGroupBox(translations[self.current_lang]["add_team"])
        f = QFormLayout(form)
        self.team_name = QLineEdit()
        self.team_country = QLineEdit()
        self.team_group = QComboBox()
        self.team_group.addItems([f"Group {chr(65+i)}" for i in range(8)])
        add_btn = QPushButton(translations[self.current_lang]["add_team"])
        add_btn.clicked.connect(self.add_team_action)
        f.addRow(translations[self.current_lang]["team_name"], self.team_name)
        f.addRow(translations[self.current_lang]["country"], self.team_country)
        f.addRow(translations[self.current_lang]["group"], self.team_group)
        f.addRow(add_btn)
        layout.addWidget(form)
        return widget

    def add_team_action(self):
        name = self.team_name.text().strip()
        country = self.team_country.text().strip()
        group = self.team_group.currentText()[-1]
        if name and country:
            if add_team(name, country, group):
                QMessageBox.information(self, "تم", f"تم إضافة {name}")
                self.team_name.clear()
                self.team_country.clear()
            else:
                QMessageBox.warning(self, "خطأ", "الفريق موجود مسبقًا")
        else:
            QMessageBox.warning(self, "خطأ", "يرجى ملء جميع الحقول")

    def create_matches_tab(self):
        widget = QWidget()
        layout = QVBoxLayout(widget)
        form = QGroupBox("إضافة مباراة")
        f = QFormLayout(form)

        teams = self.get_teams_list()
        self.home_cb = QComboBox(); self.home_cb.addItems(teams)
        self.away_cb = QComboBox(); self.away_cb.addItems(teams)
        self.home_goals = QSpinBox(); self.home_goals.setRange(0, 20)
        self.away_goals = QSpinBox(); self.away_goals.setRange(0, 20)
        self.match_date = QDateEdit(); self.match_date.setDate(QtCore.QDate.currentDate())

        add_btn = QPushButton("إضافة المباراة")
        add_btn.clicked.connect(self.add_match_action)

        f.addRow("الفريق المضيف", self.home_cb)
        f.addRow("الأهداف", self.home_goals)
        f.addRow("الفريق الضيف", self.away_cb)
        f.addRow("الأهداف", self.away_goals)
        f.addRow("التاريخ", self.match_date)
        f.addRow(add_btn)
        layout.addWidget(form)
        return widget

    def get_teams_list(self):
        conn = sqlite3.connect(DB_PATH)
        df = pd.read_sql("SELECT name FROM teams", conn)
        conn.close()
        return df["name"].tolist() if not df.empty else ["لا توجد فرق"]

    def add_match_action(self):
        home = self.home_cb.currentText()
        away = self.away_cb.currentText()
        if home == away or home == "لا توجد فرق":
            QMessageBox.warning(self, "خطأ", "اختر فريقين مختلفين")
            return
        hg = self.home_goals.value()
        ag = self.away_goals.value()
        date = self.match_date.date().toString("yyyy-MM-dd")
        add_match(home, away, hg, ag, date)
        QMessageBox.information(self, "تم", f"تم إضافة {home} {hg}-{ag} {away}")

    def create_standings_tab(self):
        widget = QWidget()
        layout = QVBoxLayout(widget)
        self.standings_table = QTableWidget()
        layout.addWidget(self.standings_table)
        refresh_btn = QPushButton("تحديث الترتيب")
        refresh_btn.clicked.connect(self.refresh_standings)
        layout.addWidget(refresh_btn)
        return widget

    def refresh_standings(self):
        df = get_standings()
        if df.empty:
            self.standings_table.setRowCount(0)
            return
        self.standings_table.setColumnCount(len(df.columns))
        self.standings_table.setHorizontalHeaderLabels(df.columns)
        self.standings_table.setRowCount(len(df))
        for i, row in df.iterrows():
            for j, val in enumerate(row):
                item = QTableWidgetItem(str(val))
                if i < 2 and row["group_char"]:  # Top 2 in group
                    item.setBackground(QtGui.QColor(0, 200, 0, 50))
                self.standings_table.setItem(i, j, item)
        self.standings_table.resizeColumnsToContents()

    def create_analysis_tab(self):
        widget = QWidget()
        layout = QVBoxLayout(widget)
        self.canvas = FigureCanvas(plt.Figure(figsize=(10, 6)))
        layout.addWidget(self.canvas)
        btn = QPushButton("تحديث الرسم البياني")
        btn.clicked.connect(self.update_chart)
        export_btn = QPushButton(translations[self.current_lang]["export"])
        export_btn.clicked.connect(lambda: QMessageBox.information(self, "تم", f"تم التصدير إلى {export_report()}"))
        layout.addWidget(btn)
        layout.addWidget(export_btn)
        return widget

    def update_chart(self):
        df = get_standings().head(10)
        self.canvas.figure.clear()
        ax = self.canvas.figure.add_subplot(111)
        if not df.empty:
            ax.barh(df["name"], df["Pts"], color="#FFD700")
            ax.set_facecolor("#001F3F")
            ax.tick_params(colors="white")
            ax.set_title("Top 10 Teams by Points", color="white", fontsize=16)
        self.canvas.figure.tight_layout()
        self.canvas.draw()

# === FILE: main.py ===
def main():
    if not PYQT_AVAILABLE:
        print("PyQt6 مطلوب لتشغيل الواجهة")
        return

    app = QApplication(sys.argv)
    app.setStyle("Fusion")

    init_db()
    window = UCLWindow()
    window.show()
    sys.exit(app.exec())

if __name__ == "__main__":
    main()
