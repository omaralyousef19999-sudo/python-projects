# ucl_manager.py - النسخة النهائية: عربي RTL + إنجليزي LTR + زر تبديل + رسم بياني شغال

import sys
import sqlite3
from pathlib import Path
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from PyQt6.QtWidgets import *
from PyQt6.QtCore import Qt, QDate, QLocale
from PyQt6.QtGui import QColor

DB_PATH = Path("ucl_database.db")

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS teams (id INTEGER PRIMARY KEY, name TEXT UNIQUE, country TEXT, group_char TEXT)''')
    c.execute('''CREATE TABLE IF NOT EXISTS matches (id INTEGER PRIMARY KEY, home_team TEXT, away_team TEXT,
                 home_goals INTEGER, away_goals INTEGER, date TEXT)''')
    conn.commit()
    conn.close()

def add_team(name, country, group):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    try:
        c.execute("INSERT INTO teams (name, country, group_char) VALUES (?, ?, ?)", (name, country, group))
        conn.commit()
        return True
    except:
        return False
    finally:
        conn.close()

def add_match(home, away, hg, ag, date):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO matches (home_team, away_team, home_goals, away_goals, date) VALUES (?, ?, ?, ?, ?)",
              (home, away, hg, ag, date))
    conn.commit()
    conn.close()

def get_teams():
    conn = sqlite3.connect(DB_PATH)
    df = pd.read_sql_query("SELECT name FROM teams ORDER BY name", conn)
    conn.close()
    return df["name"].tolist() if not df.empty else []

def get_standings():
    conn = sqlite3.connect(DB_PATH)
    query = """
    SELECT t.name,
           COUNT(m.id) AS P,
           SUM(CASE WHEN (m.home_team = t.name AND m.home_goals > m.away_goals) OR 
                         (m.away_team = t.name AND m.away_goals > m.home_goals) THEN 1 ELSE 0 END) AS W,
           SUM(CASE WHEN m.home_goals = m.away_goals THEN 1 ELSE 0 END) AS D,
           SUM(CASE WHEN (m.home_team = t.name AND m.home_goals < m.away_goals) OR 
                         (m.away_team = t.name AND m.away_goals < m.home_goals) THEN 1 ELSE 0 END) AS L,
           COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END), 0) AS GF,
           COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END), 0) AS GA,
           (COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.home_goals ELSE m.away_goals END), 0) -
            COALESCE(SUM(CASE WHEN m.home_team = t.name THEN m.away_goals ELSE m.home_goals END), 0)) AS GD,
           (SUM(CASE WHEN (m.home_team = t.name AND m.home_goals > m.away_goals) OR 
                          (m.away_team = t.name AND m.away_goals > m.home_goals) THEN 3
                WHEN m.home_goals = m.away_goals THEN 1 ELSE 0 END)) AS Pts
    FROM teams t LEFT JOIN matches m ON m.home_team = t.name OR m.away_team = t.name
    GROUP BY t.name
    ORDER BY Pts DESC, GD DESC, GF DESC
    """
    df = pd.read_sql_query(query, conn)
    conn.close()
    return df

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.lang = "ar"  # البداية عربي
        self.setWindowTitle("نظام دوري أبطال أوروبا 2025")
        self.resize(1350, 800)
        self.apply_language()

        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)

        # شريط اللغة في الأعلى
        top_bar = QHBoxLayout()
        top_bar.addStretch()
        self.lang_btn = QPushButton("English")
        self.lang_btn.clicked.connect(self.toggle_language)
        top_bar.addWidget(self.lang_btn)
        layout.addLayout(top_bar)

        self.tabs = QTabWidget()
        layout.addWidget(self.tabs)
        self.build_tabs()

    def apply_language(self):
        if self.lang == "ar":
            self.setLayoutDirection(Qt.LayoutDirection.RightToLeft)
            QLocale.setDefault(QLocale(QLocale.Language.Arabic))
            self.lang_btn.setText("English")
            self.setWindowTitle("نظام دوري أبطال أوروبا 2025")
        else:
            self.setLayoutDirection(Qt.LayoutDirection.LeftToRight)
            QLocale.setDefault(QLocale(QLocale.Language.English))
            self.lang_btn.setText("العربية")
            self.setWindowTitle("UEFA Champions League 2025")

    def toggle_language(self):
        self.lang = "en" if self.lang == "ar" else "ar"
        self.apply_language()
        self.build_tabs()

    def build_tabs(self):
        self.tabs.clear()
        if self.lang == "ar":
            self.tabs.addTab(self.teams_tab(), "الفرق")
            self.tabs.addTab(self.matches_tab(), "المباريات")
            self.tabs.addTab(self.standings_tab(), "الترتيب")
            self.tabs.addTab(self.analysis_tab(), "التحليل")
        else:
            self.tabs.addTab(self.teams_tab(), "Teams")
            self.tabs.addTab(self.matches_tab(), "Matches")
            self.tabs.addTab(self.standings_tab(), "Standings")
            self.tabs.addTab(self.analysis_tab(), "Analysis")

    def teams_tab(self):
        w = QWidget(); l = QVBoxLayout(w)
        g = QGroupBox("إضافة فريق جديد" if self.lang=="ar" else "Add New Team")
        f = QFormLayout(g)
        self.name_in = QLineEdit()
        self.country_in = QLineEdit()
        self.group_in = QComboBox()
        self.group_in.addItems(["A","B","C","D","E","F","G","H"])
        btn = QPushButton("إضافة الفريق" if self.lang=="ar" else "Add Team")
        btn.clicked.connect(self.add_team_now)
        f.addRow("اسم الفريق:" if self.lang=="ar" else "Team Name:", self.name_in)
        f.addRow("الدولة:" if self.lang=="ar" else "Country:", self.country_in)
        f.addRow("المجموعة:" if self.lang=="ar" else "Group:", self.group_in)
        f.addRow(btn); l.addWidget(g); l.addStretch(); return w

    def add_team_now(self):
        name = self.name_in.text().strip()
        country = self.country_in.text().strip()
        group = self.group_in.currentText()
        if name and country:
            if add_team(name, country, group):
                msg = "تم إضافة الفريق!" if self.lang=="ar" else "Team added!"
                QMessageBox.information(self, "تم", msg)
                self.name_in.clear(); self.country_in.clear()
            else:
                QMessageBox.warning(self, "خطأ", "الفريق موجود بالفعل" if self.lang=="ar" else "Team already exists")
        self.build_tabs()

    def matches_tab(self):
        w = QWidget(); l = QVBoxLayout(w)
        g = QGroupBox("إضافة مباراة" if self.lang=="ar" else "Add Match")
        f = QFormLayout(g)
        teams = get_teams()
        self.home_cb = QComboBox(); self.home_cb.addItems(teams)
        self.away_cb = QComboBox(); self.away_cb.addItems(teams)
        self.hg = QSpinBox(); self.hg.setRange(0,20)
        self.ag = QSpinBox(); self.ag.setRange(0,20)
        self.date_edit = QDateEdit(); self.date_edit.setDate(QDate.currentDate())
        btn = QPushButton("إضافة المباراة" if self.lang=="ar" else "Add Match")
        btn.clicked.connect(self.add_match_now)
        refresh = QPushButton("تحديث الفرق" if self.lang=="ar" else "Refresh Teams")
        refresh.clicked.connect(lambda: (self.home_cb.clear(), self.home_cb.addItems(get_teams()),
                                        self.away_cb.clear(), self.away_cb.addItems(get_teams())))
        f.addRow("المضيف:" if self.lang=="ar" else "Home:", self.home_cb)
        f.addRow("أهدافه:" if self.lang=="ar" else "Goals:", self.hg)
        f.addRow("الضيف:" if self.lang=="ar" else "Away:", self.away_cb)
        f.addRow("أهدافه:" if self.lang=="ar" else "Goals:", self.ag)
        f.addRow("التاريخ:" if self.lang=="ar" else "Date:", self.date_edit)
        f.addRow(btn); l.addWidget(g); l.addWidget(refresh); l.addStretch(); return w

    def add_match_now(self):
        h = self.home_cb.currentText()
        a = self.away_cb.currentText()
        if h and a and h != a:
            add_match(h, a, self.hg.value(), self.ag.value(), self.date_edit.date().toString("yyyy-MM-dd"))
            QMessageBox.information(self, "تم", "تمت الإضافة")
            self.build_tabs()
        else:
            QMessageBox.warning(self, "خطأ", "اختر فريقين مختلفين")

    def standings_tab(self):
        w = QWidget(); l = QVBoxLayout(w)
        self.table = QTableWidget(); l.addWidget(self.table)
        btn = QPushButton("تحديث الترتيب" if self.lang=="ar" else "Refresh Standings")
        btn.clicked.connect(self.update_table)
        l.addWidget(btn); self.update_table(); return w

    def update_table(self):
        df = get_standings()
        if df.empty: return
        headers = ["الفريق","لعب","فوز","تعادل","خسارة","له","عليه","فارق","نقاط"] if self.lang=="ar" else \
                  ["Team","P","W","D","L","GF","GA","GD","Pts"]
        self.table.setColumnCount(9)
        self.table.setHorizontalHeaderLabels(headers)
        self.table.setRowCount(len(df))
        for i, row in df.iterrows():
            self.table.setItem(i,0,QTableWidgetItem(row["name"]))
            self.table.setItem(i,1,QTableWidgetItem(str(row["P"])))
            self.table.setItem(i,2,QTableWidgetItem(str(row["W"])))
            self.table.setItem(i,3,QTableWidgetItem(str(row["D"])))
            self.table.setItem(i,4,QTableWidgetItem(str(row["L"])))
            self.table.setItem(i,5,QTableWidgetItem(str(row["GF"])))
            self.table.setItem(i,6,QTableWidgetItem(str(row["GA"])))
            self.table.setItem(i,7,QTableWidgetItem(str(row["GD"])))
            self.table.setItem(i,8,QTableWidgetItem(str(row["Pts"])))
            if i < 4:
                for j in range(9):
                    self.table.item(i,j).setBackground(QColor(0,200,0,100))

    def analysis_tab(self):
        w = QWidget(); l = QVBoxLayout(w)
        self.canvas = FigureCanvas(plt.Figure(figsize=(12,8)))
        l.addWidget(self.canvas)
        btn = QPushButton("تحديث الرسم البياني" if self.lang=="ar" else "Update Chart")
        btn.clicked.connect(self.draw_chart)
        l.addWidget(btn)
        self.draw_chart()
        return w

    def draw_chart(self):
        df = get_standings().head(12)
        if df.empty: return
        self.canvas.figure.clear()
        ax = self.canvas.figure.add_subplot(111)
        ax.barh(df["name"], df["Pts"], color="#FFD700", edgecolor="white")
        ax.set_facecolor("#001f3f")
        ax.tick_params(colors="white", labelsize=13)
        ax.set_xlabel("Points" if self.lang=="en" else "النقاط", color="white", fontsize=14)
        ax.set_title("Top 12 Teams" if self.lang=="en" else "أفضل 12 فريق", color="#FFD700", fontsize=22, fontweight="bold")
        ax.invert_yaxis()
        ax.grid(axis='x', color='gray', alpha=0.3)
        for i, v in enumerate(df["Pts"]):
            ax.text(v + 0.3, i, str(v), color="white", va='center', fontweight='bold', fontsize=13)
        plt.subplots_adjust(left=0.3)
        self.canvas.draw()

if __name__ == "__main__":
    init_db()
    app = QApplication(sys.argv)
    app.setStyle("Fusion")
    win = MainWindow()
    win.show()
    sys.exit(app.exec())
